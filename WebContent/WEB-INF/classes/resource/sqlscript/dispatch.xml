<?xml version="1.0" encoding="UTF-8"?>
<mapper namespace="dispatch">
	<!-- 调度(合同/安装/使用/拆卸)申请通过时提醒:调度资源设备/零配件 在用情况 -->
	<select id="dispatch_diary_componequip_inused">
	<![CDATA[
		DECLARE @DISPATCH_ID BIGINT
		SET @DISPATCH_ID = ?
		SELECT D.RECORD_SERIAL PRODUCT_SERIAL, D.RELATE_SERIAL
		  FROM T_EQUIPMENT_DIARY D, T_DISPATCH_EQUIP E
		 WHERE E.DISPATCH_ID = @DISPATCH_ID
		   AND D.EQUIP_ID = E.EQUIP_ID
		   AND D.END_DATE > E.START_DATE
		   AND D.ACTIVE = 1
		UNION ALL
		SELECT CD.COMPON_SERIAL PRODUCT_SERIAL, CD.RELATE_SERIAL
		  FROM T_COMPONENT_DIARY CD, T_DISPATCH_COMPON E
		 WHERE E.DISPATCH_ID = @DISPATCH_ID
		   AND CD.COMPON_ID = E.COMPON_ID
		   AND CD.END_DATE > E.START_DATE
		   AND CD.ACTIVE = 1
		   AND CD.CONSUME_FLAG = '0'
	]]>
	</select>
	<!-- 安装/使用/拆卸 申请通过前验证:零配件(领用、借用)占用情况 -->
	<select id="equipFlow_diary_component_inused_pickupborrow">
	<![CDATA[
		DECLARE @START_DATE SMALLDATETIME
		DECLARE @END_DATE SMALLDATETIME
		DECLARE @RELATE_ID BIGINT
		DECLARE @RELATE_MODULE VARCHAR(32)
		SET @START_DATE = ?
		SET @END_DATE = ?
		SET @RELATE_ID = ?
		SET @RELATE_MODULE = ?
		SELECT CD.COMPON_SERIAL, CD.RELATE_SERIAL
		  FROM T_COMPONENT_DIARY CD
		 WHERE (CD.RELATE_MODULE = 'PICKUP' OR CD.RELATE_MODULE = 'BORROW')
		   AND CD.ACTIVE = '1'
		   AND CD.START_DATE < @END_DATE
		   AND CD.END_DATE > @START_DATE
		   AND CD.CONSUME_FLAG = '0'
		   AND EXISTS (SELECT 'X'
		          FROM T_COMPONENT_DIARY T
		         WHERE RELATE_ID = @RELATE_ID
		           AND T.RELATE_MODULE = @RELATE_MODULE
		           AND CD.COMPON_ID = T.COMPON_ID)
	]]>
	</select>
	<!-- 安装/使用/拆卸 申请通过时提醒:零配件占用情况(领用/借用已过滤) [之前验证过:ied_diary_component_inused_pickupborrow] -->
	<select id="equipFlow_diary_component_inused">
	<![CDATA[
		DECLARE @START_DATE SMALLDATETIME
		DECLARE @END_DATE SMALLDATETIME
		DECLARE @RELATE_ID BIGINT
		DECLARE @RELATE_MODULE VARCHAR(32)
		SET @START_DATE = ?
		SET @END_DATE = ?
		SET @RELATE_ID = ?
		SET @RELATE_MODULE = ?
		SELECT CD.COMPON_ID, CD.COMPON_SERIAL, CD.RELATE_SERIAL
		  FROM T_COMPONENT_DIARY CD
		 WHERE CD.ACTIVE = '1'
		   AND CD.START_DATE <= @END_DATE
		   AND CD.END_DATE >= @START_DATE
		   AND CD.CONSUME_FLAG = '0'
		   AND EXISTS (SELECT 'X'
		          FROM T_COMPONENT_DIARY T
		         WHERE T.RELATE_ID = @RELATE_ID
		           AND T.RELATE_MODULE = @RELATE_MODULE
		           AND T.COMPON_ID = CD.COMPON_ID)
	]]>
	</select>
	<!-- 安装/使用/拆卸 申请通过时:零配件其他设备使用流程业务日历结束时间更新(领用/借用已过滤) -->
	<select id="equipFlow_diary_component_preover">
	<![CDATA[
		DECLARE @RELATE_ID BIGINT
		DECLARE @RELATE_MODULE VARCHAR(32)
		DECLARE @START_DATE SMALLDATETIME
		SET @RELATE_ID = ?
		SET @RELATE_MODULE = ?
		SET @START_DATE = ?
		UPDATE CD
		   SET CD.END_DATE = @START_DATE, CD.STATUS = '8'
		  FROM T_COMPONENT_DIARY CD
		 WHERE CD.END_DATE > @START_DATE
		   AND CD.ACTIVE = '1'
		   AND CD.CONSUME_FLAG = '0'
		   AND ((CD.RELATE_ID <> @RELATE_ID) OR (CD.RELATE_ID = @RELATE_ID AND CD.RELATE_MODULE <> @RELATE_MODULE))
		   AND EXISTS (SELECT 'X'
		          FROM T_COMPONENT_DIARY T
		         WHERE T.RELATE_ID = @RELATE_ID
		           AND T.RELATE_MODULE = @RELATE_MODULE
		           AND T.COMPON_ID = CD.COMPON_ID)
	]]>
	</select>
	<!-- 拆卸 申请通过时:零配件当前设备使用流程业务中日历结束时间更新(领用/借用已过滤) -->
	<select id="equipFlow_set_diary_component_endDate_bydismantle">
	<![CDATA[
		DECLARE @DISMANTLE_ID BIGINT
		DECLARE @END_DATE SMALLDATETIME
		SET @DISMANTLE_ID = ?
		SET @END_DATE = ?
		UPDATE CD
		   SET CD.END_DATE = @END_DATE
		  FROM T_COMPONENT_DIARY CD, T_EQUIPMENT_FLOW EF
		 WHERE EF.DISMANTLE_ID = @DISMANTLE_ID
		   AND EF.FLOW_STATE = '6'
		   AND ((CD.RELATE_ID = EF.INSTALL_ID AND CD.RELATE_MODULE = 'EQUIP_INSTALL') OR (CD.RELATE_ID = EF.EMPLOY_ID AND CD.RELATE_MODULE = 'EQUIP_EMPLOY'))
		   AND CD.ACTIVE = '1'
		   AND CD.END_DATE > @END_DATE
	]]>
	</select>
	<!-- 调度(安装/使用/拆卸)申请通过前:调度资源人员/零配件 重复调配 -->
	<select id="dispatch_diary_componpracti_repeat">
	<![CDATA[
		DECLARE @RELATE_ID BIGINT
		DECLARE @RELATE_MODULE VARCHAR(32)
		DECLARE @DISPATCH_ID BIGINT
		SET @RELATE_ID = ?
		SET @RELATE_MODULE = ?
		SET @DISPATCH_ID = ?
		SELECT PD.PRACTI_NAME RESOURCE_NAME
		  FROM T_PRACTI_DIARY PD, T_DISPATCH_PRACTI DP
		 WHERE PD.RELATE_ID = @RELATE_ID
		   AND PD.RELATE_MODULE = @RELATE_MODULE
		   AND DP.DISPATCH_ID = @DISPATCH_ID
		   AND DP.PRACTI_ID = PD.PRACTI_ID
		UNION ALL
		SELECT CD.COMPON_SERIAL RESOURCE_NAME
		  FROM T_COMPONENT_DIARY CD, T_DISPATCH_COMPON DC
		 WHERE CD.RELATE_ID = @RELATE_ID
		   AND CD.RELATE_MODULE = @RELATE_MODULE
		   AND DC.DISPATCH_ID = @DISPATCH_ID
		   AND DC.COMPON_ID = CD.COMPON_ID
		   AND CD.CONSUME_FLAG = '0'
	]]>
	</select>
	<!-- 清除对已经调度完成的人员履历信息 -->
	<select id="clean_practi_resume">
	<![CDATA[
		DELETE FROM T_PRACTI_RESUME WHERE PRACTI_DIARY_ID = ?
	]]>
	</select>
	<!-- 运输部件信息 -->
	<select id="count_logistics_trandetail">
	<![CDATA[
		SELECT LT.LICENSE_PLATE, LT.DRIVER, CG.VALUE COMPON_GENERIC, C.CALCULATE, CS.VALUE COMPON_SPECIFIC, SUM(LT.COUNTS) COUNTS, LT.REMARK
		  FROM T_LOGISTICS_TRANDETAIL LT
		  LEFT JOIN T_DISPATCH_COMPON DC ON LT.DISPATCH_COMPON_ID = DC.DISPATCH_COMPON_ID
		  LEFT JOIN T_COMPONENT C ON DC.COMPON_ID = C.COMPON_ID
		  LEFT JOIN BM_COMPONENT_GENERIC CG ON C.COMPON_GENERIC = CG.CODE
		  LEFT JOIN BM_COMPONENT_SPECIFIC CS ON C.COMPON_SPECIFIC = CS.CODE
		 WHERE LT.TRANSPORT_ID = ?
		 GROUP BY LT.LICENSE_PLATE, LT.DRIVER, CG.VALUE, C.CALCULATE, CS.VALUE, LT.REMARK
	]]>
	</select>
	<!-- 回场部件信息 -->
	<select id="count_logistics_backdetail">
	<![CDATA[
		SELECT LB.LICENSE_PLATE, LB.DRIVER, CG.VALUE COMPON_GENERIC, C.CALCULATE, CS.VALUE COMPON_SPECIFIC, SUM(LB.COUNTS) COUNTS, LB.REMARK
		  FROM T_LOGISTICS_BACKDETAIL LB
		  LEFT JOIN T_COMPONENT_DIARY CD ON LB.COMPON_DIARY_ID = CD.COMPON_DIARY_ID
		  LEFT JOIN T_COMPONENT C ON CD.COMPON_ID = C.COMPON_ID
		  LEFT JOIN BM_COMPONENT_GENERIC CG ON C.COMPON_GENERIC = CG.CODE
		  LEFT JOIN BM_COMPONENT_SPECIFIC CS ON C.COMPON_SPECIFIC = CS.CODE
		 WHERE LB.BACKSPORT_ID = ?
		 GROUP BY LB.LICENSE_PLATE, LB.DRIVER, CG.VALUE, C.CALCULATE, CS.VALUE, LB.REMARK
	]]>
	</select>
	<!-- 项目在用设备部件汇总 -->
	<select id="project_ecinused_gather">
	<![CDATA[
		DECLARE @PROJECT_ID BIGINT
		DECLARE @EQUIP_ID BIGINT
		SET @PROJECT_ID = ?
		SET @EQUIP_ID = ?
		SELECT ED.EQUIP_DIARY_ID,
		       ED.RECORD_ID,
		       BEG.VALUE EQUIP_GENERIC,
		       BES.VALUE EQUIP_SPECIFIC,
		       ED.EXW_SERIAL,
		       ED.BUILDING_NUM,
		       BCG.VALUE COMPON_GENERIC,
		       BCS.VALUE COMPON_SPECIFIC,
		       C.DIMENSIONS,
		       CD.CALCULATE,
		       ISNULL(SUM(CD.COUNTS), 0) COUNTS,
		       ISNULL(SUM(C.KNOT_METRIC * CD.COUNTS), 0) KNOT_METRIC
		  FROM T_EQUIPMENT_DIARY ED
		  LEFT JOIN T_COMPONENT_DIARY CD ON CD.FLOW_ID = ED.FLOW_ID
		  LEFT JOIN T_COMPONENT C ON C.COMPON_ID = CD.COMPON_ID
		  LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = ED.EQUIP_SPECIFIC
		  LEFT JOIN BM_EQUIP_GENERIC BEG ON BEG.CODE = ED.EQUIP_GENERIC
		  LEFT JOIN BM_COMPONENT_SPECIFIC BCS ON BCS.CODE = CD.COMPON_SPECIFIC
		  LEFT JOIN BM_COMPONENT_GENERIC BCG ON BCG.CODE = CD.COMPON_GENERIC
		 WHERE ED.PROJECT_ID = @PROJECT_ID
		   AND ED.EQUIP_ID = CASE WHEN @EQUIP_ID IS NULL THEN ED.EQUIP_ID ELSE @EQUIP_ID END
		 GROUP BY ED.EQUIP_DIARY_ID,ED.FLOW_ID, ED.RECORD_ID, BES.VALUE, BEG.VALUE, ED.EXW_SERIAL, ED.BUILDING_NUM, BCG.VALUE, BCS.VALUE,C.DIMENSIONS,CD.CALCULATE
		 ORDER BY ED.EQUIP_DIARY_ID ASC;
	]]>
	</select>
	<!-- 项目未用设备部件汇总 -->
	<select id="project_ecunused_gather">
	<![CDATA[
	 	SELECT BCG.VALUE COMPON_GENERIC, BCS.VALUE COMPON_SPECIFIC,C.DIMENSIONS, C.CALCULATE, BCH.COUNTS COUNTS
  		 FROM
		 T_PROJECT_COMPON BCH 
		 LEFT JOIN T_COMPONENT C ON BCH.COMPON_ID=C.COMPON_ID
		   LEFT JOIN BM_COMPONENT_SPECIFIC BCS ON BCS.CODE = C.COMPON_SPECIFIC
		  LEFT JOIN BM_COMPONENT_GENERIC BCG ON BCG.CODE = C.COMPON_GENERIC
		 WHERE BCH.PROJECT_ID = ? AND BCH.COUNTS>0 AND BCH.STATUS=0
	]]>
	</select>
	<!-- 项目未用设备部件汇总2 -->
	<select id="project_ecunused_gather2">
	<![CDATA[
		 SELECT PC.COMPON_ID, SUM(ISNULL(PC.COUNTS,0)) COUNTS
		 FROM T_PROJECT_COMPON PC 
		 WHERE PC.STATUS = 0
		 GROUP BY PC.COMPON_ID 
	]]>
	</select>
	<!-- 过滤调度合同 -->
	<select id="list_by_trans_status">
	<![CDATA[
		DECLARE @CONTRACTSERIAL VARCHAR(128)
		DECLARE @PROJECT_NAME VARCHAR(128)
		DECLARE @EQUIPSERIAL VARCHAR(64)
		DECLARE @dataPermission VARCHAR(800)
		SET @CONTRACTSERIAL = ?
		SET @PROJECT_NAME = ?
		SET @EQUIPSERIAL = ?
		SET @dataPermission = ?
		
		SELECT T.CONTRACT_ID contractId
			,T.PROJECT_NAME projectName
			,T.CONTRACT_SERIAL contractSerial
			,T.CONTRACT_THEME contractTheme
			,T.SUBCONTRACT subcontract
			,T.FUND_TYPE fundType
			,T.PB_ENT pbEnt
			,T.PB_MODULE pbModule
			,T.PB_ENT_NAME pbEntName
			,T.PB_ENT_LINK_MAN pbEntLinkMan
			,T.PA_ENT abEnt
			,T.PA_MODULE paModule
			,T.PA_ENT_NAME paEntName
			,T.PA_ENT_LINK_MAN paEntLinkMan
			,T.ENTERPRISE_SERIAL enterpriseSerial
			,T.COVER cover
			,T.SALESMAN_ID salesmanId
			,T.SALESMAN salesman
			,T.COLLECTION_RATIO collectionRatio
			,T.PROJECT_ID projectId
			,T.PROJECT_SERIAL projectSerial
			,T.PROJECT_NAME projectName
			,T.ADDRESS address
			,T.SIGNING_TIME signingTime
			,T.CONTRACT_AMOUNT contractAmount
			,T.APPLYFOR_STATE applyforState
			,T.PROVIDED_DATE providedDate
			,T.EQUIP_COUNT equipCount
			,T.CONSTRACT_NO contractNo
			,T.COMPETENT_DEPARTMET competentDepartment
			,T.TAX_MODE taxMode
			,T.APPLICABLE_TAX_RATE applicableTaxRate
			,T.SIGNEG_AREA signedArea
			,T.DISTRICT district
			,T.BELONG_TO_AREA belongToArea
			,T.CONTRACT_CATEGORY contractCategory
			,BA.VALUE  belongToAreaName
			,BC.VALUE contractCategoryName
			,_EQUIP.EQUIP_SERIAL equipSerial
			,(CASE T.APPLYFOR_STATE
				    WHEN  0 THEN '待提交'
					WHEN  1 THEN '待处理'
					WHEN  2 THEN '待审批'
					WHEN  3 THEN '待调度'
					WHEN  4 THEN '待执行'
					WHEN  5 THEN '执行中'
					WHEN  6 THEN '执行完成'
					WHEN  7 THEN '作废待审'
					WHEN  8 THEN '作废待批'
					WHEN  9 THEN '作废'
					END
			
			) applyforStateName
			,(CASE T.FUND_TYPE
				    WHEN  0 THEN '付款'
					WHEN  1 THEN '收款'
					END
			
			) fundTypeName
	 FROM T_CONTRACT_LEASE T 
	LEFT JOIN T_DISPATCH TD ON TD.RELATE_ID = T.CONTRACT_ID AND TD.RELATE_MODULE = 'CONTRACT_LEASE' AND TD.DEL_FLAG='1' AND TD.APPLYFOR_STATE = '3'
	LEFT JOIN T_DISPATCH_EQUIP TE ON TE.DISPATCH_ID = TD.DISPATCH_ID 
	LEFT JOIN BM_BELONG_TO_AREA BA ON BA.CODE = T.BELONG_TO_AREA
	LEFT JOIN BM_CONTRACT_CATEGORY BC ON BC.CODE = T.CONTRACT_CATEGORY
	LEFT JOIN T_EQUIPMENT _EQUIP ON _EQUIP.EQUIP_ID = TE.EQUIP_ID
	WHERE TE.WORK_STATUS = '0' AND  TE.DISPATCH_EQUIP_ID IS NOT NULL
	AND (SELECT dbo.PermissionFilter(T.PERMISSION_FLAG, @dataPermission))=1
	AND TD.EFFECTIVE !='0'
	 AND (
			    CHARINDEX((CASE WHEN @PROJECT_NAME IS NULL THEN T.PROJECT_NAME ELSE @PROJECT_NAME END), T.PROJECT_NAME) > 0
			   OR CHARINDEX((CASE WHEN @CONTRACTSERIAL IS NULL THEN CAST(T.CONTRACT_SERIAL AS VARCHAR(64)) ELSE @CONTRACTSERIAL END), CAST(T.CONTRACT_SERIAL AS VARCHAR(64))) > 0
			   OR CHARINDEX((CASE WHEN @EQUIPSERIAL IS NULL THEN _EQUIP.EQUIP_SERIAL ELSE @EQUIPSERIAL END), _EQUIP.EQUIP_SERIAL) > 0
		   )
	]]>
	</select>
	<!-- 周材回收管理打印单流水号 -->
	<select id="recycle_detail_num">
	<![CDATA[
		DECLARE @RECYCLE_ID BIGINT
		SET @RECYCLE_ID = ?
		SELECT 
		C.CONTRACT_NUMBER+'/TH'+RIGHT('0000'+CONVERT(VARCHAR,C.NUM), 4) AS DETAIL_NO 
		FROM (
			SELECT 
			T.CONTRACT_NUMBER,
			(SELECT COUNT( 0 ) AS NUM FROM T_RECYCLE_MANAGE RM WHERE EXISTS (
				SELECT RE.CONTRACT_ID FROM T_RECYCLE_MANAGE RE WHERE RE.RECYCLE_ID = @RECYCLE_ID AND RE.CONTRACT_ID = RM.CONTRACT_ID) 
				AND RM.RECYCLE_ID <= @RECYCLE_ID 
				AND RM.DEL_FLAG = 1) AS NUM 
			FROM T_CONTRACT_MATERIALS T 
			WHERE EXISTS (SELECT RE.CONTRACT_ID FROM T_RECYCLE_MANAGE RE WHERE RE.RECYCLE_ID = @RECYCLE_ID AND RE.CONTRACT_ID = T.CONTRACTMA_ID)
		) C
	]]>
	</select>
	
	<!-- 周材现场装车打印单流水号 -->
	<select id="materials_detail_num">
	<![CDATA[
		DECLARE @PACKAGE_ID BIGINT
		SET @PACKAGE_ID = ?
		SELECT 
		C.CONTRACT_NUMBER+'/ZC'+RIGHT('0000'+CONVERT(VARCHAR,C.NUM), 4) AS DETAIL_NO 
		FROM (
			SELECT
			T.CONTRACT_NUMBER,
			(SELECT COUNT( 0 ) AS NUM FROM T_MATERIALS_PACKAGE MP WHERE
				EXISTS (SELECT RE.CONTRACT_ID FROM T_MATERIALS_PACKAGE RE WHERE RE.PACKAGE_ID = @PACKAGE_ID AND RE.CONTRACT_ID = MP.CONTRACT_ID ) 
				AND MP.PACKAGE_ID <= @PACKAGE_ID 
				AND MP.DEL_FLAG = 1 
			) AS NUM 
		FROM T_CONTRACT_MATERIALS T 
		WHERE EXISTS ( SELECT RE.CONTRACT_ID FROM T_MATERIALS_PACKAGE RE WHERE RE.PACKAGE_ID = @PACKAGE_ID AND RE.CONTRACT_ID = T.CONTRACTMA_ID)
		)C
	]]>
	
	</select>
	<!-- 周材收货管理打印单流水号 -->
		<select id="goods_recipient_detail_num">
	<![CDATA[
		DECLARE @RECIPIENT_ID BIGINT
		SET @RECIPIENT_ID = ?
		SELECT C.LEASE_SERIAL+'/JS'+RIGHT('0000'+CONVERT(VARCHAR,C.NUM), 4) AS DETAIL_NO FROM 
		(SELECT
			T.LEASE_SERIAL,
			(
			SELECT COUNT( 0 ) AS NUM
			FROM
				T_GOODS_RECIPIENT MP 
			WHERE
				EXISTS ( SELECT RE.LEASE_ID FROM T_GOODS_RECIPIENT RE WHERE RE.RECIPIENT_ID = @RECIPIENT_ID AND RE.LEASE_ID = MP.LEASE_ID ) 
				AND MP.RECIPIENT_ID <= @RECIPIENT_ID 
				AND MP.DEL_FLAG = 1 
			) AS NUM 
		FROM
			T_LEASE_CONTRACT T 
		WHERE
			EXISTS ( SELECT RE.LEASE_ID FROM T_GOODS_RECIPIENT RE WHERE RE.RECIPIENT_ID = @RECIPIENT_ID AND RE.LEASE_ID = T.LEASE_ID))C
	]]>
	</select>
	
		<!-- 周材退货管理打印单流水号 -->
		<select id="return_goods_detail_num">
	<![CDATA[
		DECLARE @RETURN_ID BIGINT
		SET @RETURN_ID = ?
		SELECT C.LEASE_SERIAL+'/JT'+RIGHT('0000'+CONVERT(VARCHAR,C.NUM), 4) AS DETAIL_NO FROM 
		(SELECT
			T.LEASE_SERIAL,
			(
			SELECT COUNT( 0 ) AS NUM
			FROM
				T_RETURN_GOODS MP 
			WHERE
				EXISTS ( SELECT RE.LEASE_ID FROM T_RETURN_GOODS RE WHERE RE.RETURN_ID = @RETURN_ID  AND RE.LEASE_ID = MP.LEASE_ID ) 
				AND MP.RETURN_ID <= @RETURN_ID  
				AND MP.DEL_FLAG = 1 
			) AS NUM 
		FROM
			T_LEASE_CONTRACT T 
		WHERE
			EXISTS ( SELECT RE.LEASE_ID FROM T_RETURN_GOODS RE WHERE RE.RETURN_ID = @RETURN_ID  AND RE.LEASE_ID = T.LEASE_ID))C
	]]>
	</select>
	
		<!-- 周材项目调拨打印单流水号 -->
		<select id="allocation_project_detail_num">
	<![CDATA[
		DECLARE @ALLOCATION_ID BIGINT
		SET @ALLOCATION_ID = ?
		SELECT C.CONTRACT_NUMBER+'/DB'+RIGHT('0000'+CONVERT(VARCHAR,C.NUM), 4) AS DETAIL_NO FROM 
		(SELECT
			T.CONTRACT_NUMBER,
			(
			SELECT COUNT( 0 ) AS NUM
			FROM
				T_ALLOCATION_PROJECT MP 
			WHERE
				EXISTS ( SELECT RE.OUT_CONTRACT_ID FROM T_ALLOCATION_PROJECT RE WHERE RE.ALLOCATION_ID = @ALLOCATION_ID AND RE.OUT_CONTRACT_ID = MP.OUT_CONTRACT_ID ) 
				AND MP.ALLOCATION_ID <= @ALLOCATION_ID 
				AND MP.DEL_FLAG = 1 
			) AS NUM 
		FROM
			T_CONTRACT_MATERIALS T 
		WHERE
			EXISTS ( SELECT RE.OUT_CONTRACT_ID FROM T_ALLOCATION_PROJECT RE WHERE RE.ALLOCATION_ID = @ALLOCATION_ID AND RE.OUT_CONTRACT_ID = T.CONTRACTMA_ID))C
	]]>
	</select>
	
	<select id="equip_is_dispatch">
		<![CDATA[
		 SELECT E.EQUIP_SERIAL FROM T_EQUIPMENT_FLOW EF,T_EQUIPMENT E WHERE EF.EQUIP_ID=E.EQUIP_ID
		 AND EF.FLOW_ID =(SELECT MAX(FLOW_ID) FROM T_EQUIPMENT_FLOW WHERE EQUIP_ID=? AND FLOW_STATE<8);
		]]>
	</select>
	<select id="equip_is_all_dismantle">
		<![CDATA[
		 SELECT E.EQUIP_SERIAL FROM T_EQUIPMENT_FLOW EF,T_EQUIPMENT E WHERE EF.EQUIP_ID=E.EQUIP_ID
		 AND EF.FLOW_ID =(SELECT MAX(FLOW_ID) FROM T_EQUIPMENT_FLOW WHERE EQUIP_ID=? AND FLOW_STATE<8);
		]]>
	</select>
	<!-- 设备档案中设备相关连的合同信息 -->
	<select id="equip_contract_info">
		<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT F.CONTRACT_ID
        FROM T_EQUIPMENT_FLOW F
        WHERE F.EQUIP_ID = @EQUIP_ID
		]]>
	</select>
	<!-- 设备档案中设备相关连的业务申请信息 -->
	<select id="equip_contract_arrange_info">
		<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CL.ARRANGE_ID
		FROM T_CONTRACT_LEASE CL
		WHERE CL.CONTRACT_ID IN(
		SELECT F.CONTRACT_ID
        FROM T_EQUIPMENT_FLOW F
        WHERE F.EQUIP_ID = @EQUIP_ID)
		]]>
	</select>
	<!-- 设备档案中设备相关连的调拨信息 -->
	<select id="equip_dispatch_info">
		<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT F.DISPATCH_ID
        FROM T_EQUIPMENT_FLOW F
        WHERE F.EQUIP_ID = @EQUIP_ID
		]]>
	</select>
	<!-- 设备档案中设备相关连的合同结算信息 -->
	<select id="equip_settle_contract_info">
		<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT SC.SETTLE_ID
		FROM T_SETTLE_CONTRACT SC
		WHERE SC.CONTRACT_ID IN(
		SELECT F.CONTRACT_ID
        FROM T_EQUIPMENT_FLOW F
        WHERE F.EQUIP_ID = @EQUIP_ID)
		]]>
	</select>
	
		<!-- 保险管理中设备相关连的合同信息 -->
	<select id="equip_insurance_contract_info">
		<![CDATA[
		DECLARE @INSURE_ID BIGINT
		DECLARE @PROJECT_NAME VARCHAR(128)
		DECLARE @APPLYFOR_STATE VARCHAR(1)
		DECLARE @CONSTRACT_NO VARCHAR(128)
		DECLARE @PA_ENT_NAME VARCHAR(128)
		DECLARE @PB_ENT_NAME VARCHAR(128)
		DECLARE @startDate VARCHAR(10)
		DECLARE @endDate VARCHAR(10)
		SET @INSURE_ID = ?
		SET @PROJECT_NAME = ?
		SET @APPLYFOR_STATE = ?
		SET @CONSTRACT_NO = ?
		SET @PA_ENT_NAME = ?
		SET @PB_ENT_NAME = ?
		SET @startDate = ?
		SET @endDate = ?
		SELECT T.* FROM (SELECT
		CL.PROJECT_NAME AS 'projectName',
		CL.CONSTRACT_NO AS 'contractNo',
		CL.APPLYFOR_STATE AS 'applyforState',
		(CASE CL.APPLYFOR_STATE
			WHEN '0' THEN '待提交'
			WHEN '1' THEN '待审核'
			WHEN '2' THEN '待审批'
			WHEN '3' THEN '待调度'
			WHEN '4' THEN '待执行'
			WHEN '5' THEN '执行中'
			WHEN '6' THEN '执行完成'
			WHEN '7' THEN '作废待审'
			WHEN '8' THEN '作废待批'
			WHEN '9' THEN '作废'
		END
		 )AS 'applyforStateName',
		CL.SIGNING_TIME AS 'signingTime',
		CL.CONTRACT_AMOUNT AS 'contractAmount',
		CL.EQUIP_COUNT AS 'equipCount',
		CL.PA_ENT_NAME AS 'paEntName',
		CL.PB_ENT_NAME AS 'pbEntName'
		FROM T_CONTRACT_LEASE CL WHERE EXISTS(SELECT ED.CONTRACT_ID FROM T_EQUIP_INSURANCE_DETAIL ED WHERE CL.CONTRACT_ID = ED.CONTRACT_ID AND ED.INSURE_ID = @INSURE_ID)
		)T
		WHERE (T.projectName LIKE '%'+@PROJECT_NAME+'%' OR @PROJECT_NAME = '' OR @PROJECT_NAME IS NULL )
		AND (T.applyforState = @APPLYFOR_STATE  OR @APPLYFOR_STATE = '' OR @APPLYFOR_STATE IS NULL )
		AND (T.contractNo LIKE '%'+@CONSTRACT_NO+'%' OR @CONSTRACT_NO = '' OR @CONSTRACT_NO IS NULL )
		AND (T.paEntName LIKE '%'+@PA_ENT_NAME+'%' OR @PA_ENT_NAME = '' OR @PA_ENT_NAME IS NULL )
		AND (T.pbEntName LIKE '%'+@PB_ENT_NAME+'%' OR @PB_ENT_NAME = '' OR @PB_ENT_NAME IS NULL )
		AND (T.signingTime > = @startDate+'%' OR @startDate = '' OR @startDate IS NULL )
		AND (T.signingTime <= @endDate+'%' OR @endDate = '' OR @endDate IS NULL )
		]]>
	</select>
	
			<!-- 保险管理中续保打印 -->
	<select id="equip_insurance_contract_count">
		<![CDATA[
		DECLARE @DETAIL_ID varchar(500)
		SET @DETAIL_ID = ?
		SELECT 
			ED.PROJECT_NAME,
			ED.ADDRESS,
			ES.VALUE,
			E.EXW_SERIAL,
			E.EQUIP_SERIAL,
			D.DEP_NAME,
			ED.REMARK,
			ED.PREMIUM 
		FROM T_EQUIP_INSURANCE_DETAIL ED 
		LEFT JOIN T_EQUIPMENT E ON ED.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON E.EQUIP_SPECIFIC = ES.CODE
		LEFT JOIN DEPARTMENT D ON E.DEP_ID = D.DEP_ID
		LEFT JOIN T_EQUIP_INSURANCE EI ON ED.INSURE_ID = EI.INSURE_ID
		WHERE  (CHARINDEX(','+convert(VARCHAR,ED.DETAIL_ID)+',',@DETAIL_ID)>0 OR @DETAIL_ID = '' OR @DETAIL_ID IS NULL)
		
		]]>
	</select>
	
				<!-- 结算管理中设备明细 -->
	<select id="settle_contract_equip_list">
		<![CDATA[
		DECLARE @SETTLE_ID BIGINT
		SET @SETTLE_ID = ?
		SELECT 
			T2.*,
			BG.VALUE AS equipGenericName,
			E.EXW_SERIAL AS exwSerial,
			E.EQUIP_SERIAL AS equipSerial
		FROM (
			SELECT 
				T.equipId,
				SUM(T.itemSummary) AS itemSummary,
				SUM(T.equipSummary) AS equipSummary,
				SUM(T.componSummary) AS componSummary,
				SUM(T.operatorSummary) AS operatorSummary,
				SUM(T.otherSummary) AS otherSummary,
				SUM(T.safeSummary) AS safeSummary
			FROM (
				SELECT
					SI.EQUIP_ID AS equipId,
					SI.SUMMARY AS itemSummary,
					NULL AS equipSummary,
					NULL AS componSummary,
					NULL AS operatorSummary,
					NULL AS otherSummary,
					NULL AS safeSummary
				FROM T_SETTLE_ITEM_BRIEF SI WHERE SI.SETTLE_ID = @SETTLE_ID
				UNION ALL
				SELECT
					SE.EQUIP_ID AS equipId,
					NULL AS itemSummary,
					SE.SUMMARY AS equipSummary,
					NULL AS componSummary,
					NULL AS operatorSummary,
					NULL AS otherSummary,
					NULL AS safeSummary
				FROM T_SETTLE_EQUIP_BRIEF SE WHERE SE.SETTLE_ID = @SETTLE_ID
				UNION ALL
				SELECT
					SB.EQUIP_ID AS equipId,
					NULL AS itemSummary,
					NULL AS equipSummary,
					SB.SUMMARY AS componSummary,
					NULL AS operatorSummary,
					NULL AS otherSummary,
					NULL AS safeSummary
				FROM T_SETTLE_COMPON_BRIEF SB WHERE SB.SETTLE_ID = @SETTLE_ID
				UNION ALL
				SELECT
					OS.EQUIP_ID AS equipId,
					NULL AS itemSummary,
					NULL AS equipSummary,
					NULL AS componSummary,
					OS.SUMMARY AS operatorSummary,
					NULL AS otherSummary,
					NULL AS safeSummary
				FROM T_OPERATOR_SALARY_STATEMENT OS WHERE OS.SETTLE_ID = @SETTLE_ID
				UNION ALL
				SELECT
					OE.EQUIP_ID AS equipId,
				    NULL AS itemSummary,
					NULL AS equipSummary,
					NULL AS componSummary,
					NULL AS operatorSummary,
					OE.AMOUNT AS otherSummary,
					NULL AS safeSummary
				FROM T_OTHER_EXPENSE_STATEMENT OE WHERE OE.SETTLE_ID = @SETTLE_ID
				UNION ALL
				SELECT
					SM.EQUIP_ID AS equipId,
					NULL AS itemSummary,
					NULL AS equipSummary,
					NULL AS componSummary,
					NULL AS operatorSummary,
					NULL AS otherSummary,
					SM.SUMMARY AS safeSummary
				FROM T_SAFETY_MONITOR_SETTLE_STATEMENT SM WHERE SM.SETTLE_ID = @SETTLE_ID)T 
			GROUP BY T.equipId) T2
		LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = T2.equipId
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC  = BG.CODE
		]]>
	</select>
	
</mapper>