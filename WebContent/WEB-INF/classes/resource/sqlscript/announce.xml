<?xml version="1.0" encoding="UTF-8"?>
<mapper namespace="announce">
	<!-- 发布公告 -->
	<select id="pulish_to_appuser">
	<![CDATA[
		DECLARE @ANNOUNCE_ID BIGINT
		SET @ANNOUNCE_ID = ?
		INSERT INTO T_ANNOUNCE_USER
		  (ANNOUNCE_ID, USER_ID, USER_NAME, READ_FLAG, PUBLISH_TIME, DEL_FLAG)
		  SELECT CA.ANNOUNCE_ID ANNOUNCE_ID,
		         CA.USER_ID USER_ID,
		         CA.USER_NAME USER_NAME,
		         '0' READ_FLAG,
		         GETDATE() PUBLISH_TIME,
		         '1' DEL_FLAG
		    FROM T_ANNOUNCE_CATEGORY CA
		   WHERE CA.ANNOUNCE_ID = @ANNOUNCE_ID
		     AND CA.CATEGORY = '0'
		  UNION ALL
		  SELECT CA.ANNOUNCE_ID ANNOUNCE_ID,
		         U.USERID USER_ID,
		         U.FULLNAME USER_NAME,
		         '0' READ_FLAG,
		         GETDATE() PUBLISH_TIME,
		         '1' DEL_FLAG
		    FROM APP_USER U, T_ANNOUNCE_CATEGORY CA
		   WHERE CA.ANNOUNCE_ID = @ANNOUNCE_ID
		     AND CA.CATEGORY = '1'
		     AND U.DEP_ID = CA.DEP_ID
		     AND U.STATUS = 1
		     AND DELFLAG = 0
	]]>
	</select>
	<!-- 工作备忘 -->
	<select id="display_unfinished">
	<![CDATA[
		DECLARE @PRACTI_ID BIGINT
		DECLARE @USER_ID BIGINT
		DECLARE @OFFSET INT
		DECLARE @LIMIT INT
		SET @OFFSET = ?
		SET @LIMIT = ?
		SET @PRACTI_ID = ?
		SET @USER_ID = ?;
		WITH QUERY AS (
		SELECT MD.MEMO_ID, MD.MEMO_DETAIL_ID, M.MEMO_THEME, MD.CONTENTS, M.PRACTI_NAME, MD.PLAN_FINISHED_DATE, ROW_NUMBER () OVER (ORDER BY MD.MEMO_DETAIL_ID) AS _ROWNUM
		  FROM T_MEMO_DETAIL MD, T_MEMO M
		 WHERE MD.FINISHED = '0'
		   AND MD.MEMO_ID = M.MEMO_ID
		   AND M.STATUS = '0'
		   AND (M.PRACTI_ID = @PRACTI_ID OR M.USER_ID = @USER_ID OR EXISTS (SELECT 'X' FROM T_MEMO_DEPUTY D WHERE MD.MEMO_ID = D.MEMO_ID AND D.PRACTI_ID = @PRACTI_ID)))
		SELECT * FROM QUERY WHERE _ROWNUM >= @OFFSET AND _ROWNUM < (@OFFSET + @LIMIT)
	]]>
	</select>
</mapper>