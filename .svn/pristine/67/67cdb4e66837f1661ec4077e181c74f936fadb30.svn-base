/**
 *====================================================
 * 文件名称: EquipmentServiceImpl.java
 * 修订记录：
 * No    日期				作者(操作:具体内容)
 * 1.    2013-7-6			chenxy(创建:创建文件)
 *====================================================
 * 类描述：(说明未实现或其它不应生成javadoc的内容)
 */
package com.knight.emms.service.impl;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.apache.commons.lang.StringUtils;

import com.knight.core.exception.BusinessException;
import com.knight.core.filter.QueryFilter;
import com.knight.core.util.DateUtil;
import com.knight.emms.core.model.SerialNumberStrategy;
import com.knight.emms.core.service.BaseBusinessModelServiceImpl;
import com.knight.emms.dao.ComponentDao;
import com.knight.emms.dao.EquipmentAffiliatedDao;
import com.knight.emms.dao.EquipmentDao;
import com.knight.emms.dao.InstalmentDao;
import com.knight.emms.domain.FundPaymentVoucherService;
import com.knight.emms.domain.IUploadTerminalDomain;
import com.knight.emms.domain.SchedularArchiveDomain;
import com.knight.emms.domain.SchedularDispatchDomain;
import com.knight.emms.domain.SchedularFundDomain;
import com.knight.emms.model.AmountPayment;
import com.knight.emms.model.Equipment;
import com.knight.emms.service.EquipmentService;
import com.knight.emms.support.EquipmentSupport;
import com.knight.system.service.impl.CodeServiceImpl;

/**
 * @ClassName: EquipmentServiceImpl
 * @Description: TODO(这里用一句话描述这个类的作用)
 * @author chenxy
 * @date 2013-7-6 下午11:23:40
 */
public class EquipmentServiceImpl extends BaseBusinessModelServiceImpl<Equipment> implements EquipmentService, FundPaymentVoucherService {

	private EquipmentDao equipmentDao;

	@Resource
	private EquipmentAffiliatedDao equipmentAffiliatedDao;

	@Resource
	private InstalmentDao instalmentDao;

	@Resource
	private ComponentDao componentDao;

	@Resource
	private IUploadTerminalDomain uploadTerminalDomain;

	@Resource
	private SchedularArchiveDomain schedularArchiveDomain;

	@Resource
	private SchedularDispatchDomain schedularDispatchDomain;

	@Resource
	private SchedularFundDomain schedularFundDomain;

	public EquipmentServiceImpl(EquipmentDao dao) {
		super(dao);
		this.equipmentDao = dao;
	}

	public Equipment getTranslateFull(Long equipId) {
		Equipment e = equipmentDao.get(equipId);
		CodeServiceImpl.translate(e, getPersistantStruct());
		CodeServiceImpl.translate(e.getInstalmentSet(), instalmentDao.getPersistantStruct());
		CodeServiceImpl.translate(e.getComponentSet(), componentDao.getPersistantStruct());
		CodeServiceImpl.translate(e.getEquipmentAffiliatedSet(), equipmentAffiliatedDao.getPersistantStruct());
		return e;
	}

	public void saveCreate(Equipment equipment) {
		EquipmentSupport.completeDefaultEquipment(equipment);
		int seq = equipmentDao.createNextSerialseq(equipment, equipment.getEquipGeneric());
		equipment.setRecordSerial(equipment.getEquipGeneric() + DateUtil.getCurrentDateStr() + StringUtils.leftPad(seq + "", 3, "0"));
		equipmentDao.save(equipment);
	}

	public void saveUpload(List<Equipment> equipmentList) {
		SerialNumberStrategy strategy = Equipment.class.getAnnotation(SerialNumberStrategy.class);
		String currentDate = DateUtil.getCurrentDateStr();
		Map<String, List<Equipment>> equipMap = new HashMap<String, List<Equipment>>();
		for (Equipment e : equipmentList) {
			List<Equipment> equipList = null;
			if (equipMap.containsKey(e.getEquipGeneric())) {
				equipList = equipMap.get(e.getEquipGeneric());
			} else {
				equipList = new ArrayList<Equipment>();
				equipMap.put(e.getEquipGeneric(), equipList);
			}
			equipList.add(e);
		}
		for (List<Equipment> equipList : equipMap.values()) {
			Equipment e = equipList.get(0);
			int seq = equipmentDao.createNextSerialseq(e, e.getEquipGeneric());
			if (seq + equipList.size() > strategy.maxseq()) {
				throw new BusinessException("序列号生成已达最大值" + strategy.maxseq() + ",无法继续生成编号,请改期录入!");
			}
			for (int i = 0; i < equipList.size(); i++) {
				Equipment equipment = equipList.get(i);
				EquipmentSupport.completeDefaultEquipment(equipment);
				equipment.setRecordSerial(equipment.getEquipGeneric() + currentDate + StringUtils.leftPad((seq + i) + "", (strategy.maxseq() + "").length(), "0"));
			}
		}
		for (Equipment equipment : equipmentList) {
			uploadTerminalDomain.uploadsave(equipment);
		}
	}

	public void refresh() {
		schedularArchiveDomain.birthdayRemind();
		schedularArchiveDomain.corpCertDueToRemind();
		schedularArchiveDomain.equipInsureOvertimeRemind();
		schedularArchiveDomain.equipScrapToRemind();
		schedularArchiveDomain.practiCertDueToRemind();
		schedularArchiveDomain.setDepreciateRate();
		schedularDispatchDomain.borrowExpireRemaind();
		schedularDispatchDomain.borrowOvertimeRemaind();
		schedularDispatchDomain.contractExpireEquipRemaind();
		schedularDispatchDomain.contractOvertimeEquipRemaind();
		schedularDispatchDomain.purchaseOvertimeRemaind();
		schedularFundDomain.amountPayDueToRemind();
		schedularFundDomain.moneyLendOvertimeRemind();
	}

	public List<Map<String, Object>> queryDistributeMapInfo(QueryFilter filter) {
		return equipmentDao.queryDistributeMapInfo(filter);
	}

	// ====================================================================================//
	public BigDecimal getRelatePaymentAmount(Long equipId) {
		Equipment e = equipmentDao.get(equipId);
		if (e.getMortgageAmount() == null) {
			return BigDecimal.ZERO;
		}
		return e.getMortgageAmount();
	}
	public List<Equipment> getEquipment(){

		List<Equipment> list = equipmentDao.getAll();
		return list;
		
	}

	public void saveRelateAmountPaymentStatus(AmountPayment amountPayment, Long equipId, String status) {
		Equipment e = equipmentDao.get(equipId);
		e.setFinishedAmount(amountPayment.getHasPaymentAmount());
		e.setRemainderAmount(e.getMortgageAmount().subtract(e.getFinishedAmount()));
		e.setFundStatus(status);
		equipmentDao.save(e);
	}

	public void removeAffiliated(Long affiliatedId) {
		equipmentAffiliatedDao.remove(affiliatedId);
	}

}
