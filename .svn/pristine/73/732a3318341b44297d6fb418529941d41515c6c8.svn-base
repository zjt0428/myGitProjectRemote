/**
 *====================================================
 * 文件名称: EquipmentAction.java
 * 修订记录：
 * No    日期				作者(操作:具体内容)
 * 1.    2013-7-6			chenxy(创建:创建文件)
 *====================================================
 * 类描述：(说明未实现或其它不应生成javadoc的内容)
 */
package com.knight.emms.web.action;

import java.math.BigDecimal;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import lombok.Getter;
import lombok.Setter;

import com.knight.core.exception.BusinessException;
import com.knight.core.filter.QueryFilter;
import com.knight.core.log.ActionLog;
import com.knight.core.model.ExportField;
import com.knight.core.model.ExportModel;
import com.knight.core.util.DateUtil;
import com.knight.core.util.GsonUtil;
import com.knight.core.util.ReadWriteFileUtil;
import com.knight.core.web.action.ExportBaseAction;
import com.knight.emms.constant.Constant;
import com.knight.emms.constant.Status;
import com.knight.emms.model.Component;
import com.knight.emms.model.Equipment;
import com.knight.emms.model.extend.EquipComponDocmodel;
import com.knight.emms.service.ComponentService;
import com.knight.emms.service.EquipmentService;
import com.knight.emms.service.InstalmentService;
import com.knight.emms.support.FundPlanSupport;
import com.knight.emms.support.StatusAnalyze;
import com.knight.emms.support.UploadTerminalFileParser;
import com.knight.system.application.ApplicationContainer;
import com.knight.system.model.FileAttach;
import com.knight.system.service.FileAttachService;
import com.knight.system.service.impl.CodeServiceImpl;

/**
 * @ClassName: EquipmentAction
 * @Description: TODO(这里用一句话描述这个类的作用)
 * @author chenxy
 * @date 2013-7-6 下午11:23:52
 */
public class EquipmentAction extends ExportBaseAction<Equipment> {

	private static final long serialVersionUID = 1L;

	@Getter
	@Setter
	private Equipment equipment;

	@Setter
	@Getter
	private Long equipId;

	@Resource
	private EquipmentService equipmentService;

	@Resource
	private InstalmentService instalmentService;

	@Resource
	private ComponentService componentService;

	@Resource
	private FileAttachService fileAttachService;

	protected String getUnBaseTypeValue(ExportModel model, Object value, ExportField exportField, int headerIndex) throws Exception {
		Equipment e = (Equipment) model;
		switch (headerIndex) {
		case 6:
			return DateUtil.changeDateToStr(e.getPurchaseDate(), DateUtil.LINK_DISPLAY_DATE);
		}
		return super.getUnBaseTypeValue(model, value, exportField, headerIndex);
	}

	public String list() {
		QueryFilter filter = new QueryFilter(getRequest());
		List<Equipment> list = equipmentService.queryTranslateAll(filter);
		StringBuffer buff = new StringBuffer("{success:true,'totalCounts':").append(filter.getPagingBean().getTotalItems()).append(",result:");
		buff.append(GsonUtil.toJson(list, DateUtil.LINK_DISPLAY_DATE));
		buff.append("}");
		this.jsonString = buff.toString();
		return SUCCESS;
	}

	public String load() {
		Equipment c = equipmentService.getTranslateFull(equipId);
		StringBuffer sb = new StringBuffer("{success:true,data:[");
		sb.append(GsonUtil.toJson(c, GsonUtil.SINCE_VERSION_20, DateUtil.LINK_DISPLAY_DATE, false));
		sb.append("]}");
		setJsonString(sb.toString());
		return SUCCESS;
	}

	public String upload() {
		Long fileId = new Long(getRequest().getParameter("fileId"));
		FileAttach fileAttach = fileAttachService.get(fileId);
		try {
			List<Equipment> list = UploadTerminalFileParser.parserFile(fileAttach.getFilePath(), UploadTerminalFileParser.T_EQUIPMENT);
			if (!list.isEmpty()) {
				equipmentService.saveUpload(list);
			}
		} catch (Exception e) {
			if (e instanceof BusinessException) {
				throw (BusinessException) e;
			}
			throw new BusinessException("上传备案信息文件解析异常!", e);
		}
		System.out.println("详明4");
		return SUCCESS;
	}

	@ActionLog(description = "保存设备信息")
	public String save() {
		if (equipment.getEquipId() == null) {
			equipmentService.saveCreate(equipment);
			this.isCreateFileAttach = true;
		} else {
			Equipment c = equipmentService.get(equipment.getEquipId());
			equipment.setFinishedAmount(c.getFinishedAmount());
			equipment.setRemainderAmount(c.getRemainderAmount());
			Date purchaseDate = c.getPurchaseDate();
			String depreciateDate = DateUtil.changeDateToStr(DateUtil.transpositionDate(purchaseDate, Calendar.YEAR, 1), DateUtil.LINK_DISPLAY_DATE);
			//--------------------------
			if (c.getDepreciateDate().equals(depreciateDate)) { // 未进行折旧处理
				equipment.setDepreciateDate(DateUtil.changeDateToStr(DateUtil.transpositionDate(equipment.getPurchaseDate(), Calendar.YEAR, 1), DateUtil.LINK_DISPLAY_DATE));
			} else {
//				equipment.setPurchaseDate(c.getPurchaseDate());
				equipment.setDepreciateDate(c.getDepreciateDate());
			}
//			equipment.setDepreciateDate(DateUtil.changeDateToStr(DateUtil.transpositionDate(equipment.getPurchaseDate(), Calendar.YEAR, 1), DateUtil.LINK_DISPLAY_DATE));

			equipment.setTotalRate(c.getTotalRate());
			equipment.setRecordSerial(c.getRecordSerial());
			if (Constant.ENABLED.equals(equipment.getMortgage())) { // 按揭贷款-付款状态
				if (equipment.getMortgageAmount().compareTo(BigDecimal.ZERO) < 1) {
					equipment.setFundStatus(Status.Fund.paymented);
				} else if (equipment.getMortgageAmount().compareTo(c.getMortgageAmount()) < 1) {
					equipment.setFundStatus(c.getFundStatus());
				} else {
					equipment.setFundStatus(Status.Fund.payment);
				}
			}

			equipment.setFlowId(c.getFlowId());
//			equipment.setProjectAddress(c.getProjectAddress());
			equipment.setProjectId(c.getProjectId());
//			equipment.setProjectName(c.getProjectName());
			equipment.setEquipDiary(c.getEquipDiary());	
			equipment.setStoreStatus(c.getStoreStatus());
			equipment.setBusinessStatus(c.getBusinessStatus());
			equipment.setStatusDate(c.getStatusDate());
			equipment.setStatus(StatusAnalyze.parserECValid(equipment.getScrapDate(), c.getStatus()));
			equipment.setDelFlag(c.getDelFlag());
			equipment.setPresentValue(equipment.getAssetValue().subtract(equipment.getAssetValue().multiply(equipment.getTotalRate())));
		}
		equipment.setSubEquipment();
		equipmentService.merge(equipment);
		for (Component component : equipment.getComponentSet()) {
			component = componentService.get(component.getComponId());
			component.setEquipId(equipment.getEquipId());
			componentService.update(component);
		}
		if (Constant.ENABLED.equals(equipment.getMortgage())) { // 按揭贷款
			equipment.setInstalmentSet(FundPlanSupport.createInstalment(equipment));
			instalmentService.saveOrMeger(equipment.getInstalmentSet());
		}
		createFileAttach(equipment.getEquipId());
		System.out.println("详明5");
		return SUCCESS;
	}

	@ActionLog(description = "删除设备信息")
	public String multiDel() {
		String[] ids = getRequest().getParameterValues("ids");
		for (String id : ids) {
			Equipment c = equipmentService.get(new Long(id));
			if (Status.EquipCompon.unused.equals(c.getStatus()) || Status.EquipCompon.scrap.equals(c.getStatus()) || Status.EquipCompon.losed.equals(c.getStatus())) { // 闲置报废遗失设备
				c.setDelFlag(Constant.DISENABLED);
				equipmentService.save(c);
			}
		}System.out.println("详明6");
		return SUCCESS;
	}

	@ActionLog(description = "移除设备零配件信息")
	public String multiDelComponent() {
		String[] ids = getRequest().getParameterValues("ids");
		for (String id : ids) {
			componentService.removeBindingEquipment(new Long(id));
		}System.out.println("详明7");
		return SUCCESS;
	}

	public String multiDelAffiliated() {
		String[] ids = getRequest().getParameterValues("ids");
		for (String id : ids) {
			equipmentService.removeAffiliated(new Long(id));
		}System.out.println("详明8");
		return SUCCESS;
	}

	@ActionLog(description = "注销设备信息")
	public String multiCancel() {
		Date currentDate = DateUtil.getCurrentDate();
		String[] ids = getRequest().getParameterValues("ids");
		for (String id : ids) {
			Equipment c = equipmentService.get(new Long(id));
			if (Status.EquipBusiness.disenable.equals(c.getBusinessStatus())) { // 闲置设备
				c.setBusinessStatus(Status.EquipBusiness.cancel);
				c.setStatusDate(currentDate);
				equipmentService.save(c);
			}
		}System.out.println("详明9");
		return SUCCESS;
	}

	@ActionLog(description = "恢复设备信息")
	public String recover() {
		Date currentDate = DateUtil.getCurrentDate();
		String[] ids = getRequest().getParameterValues("ids");
		for (String id : ids) {
			Equipment c = equipmentService.get(new Long(id));
			if (Status.EquipBusiness.cancel.equals(c.getBusinessStatus())) { // 注销设备
				c.setBusinessStatus(StatusAnalyze.parserECValid(c.getScrapDate(), Status.EquipBusiness.disenable));
				c.setStatusDate(currentDate);
				equipmentService.save(c);
			}
		}System.out.println("详明10");
		return SUCCESS;
	}

	@ActionLog(description = "停用设备")
	public String multiCease() {
		Date currentDate = DateUtil.getCurrentDate();
		String[] ids = getRequest().getParameterValues("ids");
		for (String id : ids) {
			Equipment c = equipmentService.get(new Long(id));
			if (Status.EquipCompon.inused.equals(c.getStatus())) { // 在用设备停用
				c.setBusinessStatus(Status.EquipBusiness.stop);
				c.setStatus(Status.EquipCompon.stop);
				c.setStatusDate(currentDate);
				equipmentService.save(c);
			}
		}System.out.println("详明11");
		return SUCCESS;
	}

	@ActionLog(description = "恢复停用设备")
	public String multiRun() {
		Date currentDate = DateUtil.getCurrentDate();
		String[] ids = getRequest().getParameterValues("ids");
		for (String id : ids) {
			Equipment c = equipmentService.get(new Long(id));
			if (Status.EquipCompon.stop.equals(c.getStatus())) { // 恢复停用设备
				c.setStatus(Status.EquipCompon.inused);
				c.setStatusDate(currentDate);
				equipmentService.save(c);
			}
		}System.out.println("详明12");
		return SUCCESS;
	}

	public String release() {
		Date currentDate = DateUtil.getCurrentDate();
		String[] ids = getRequest().getParameterValues("ids");
		for (String id : ids) {
			Equipment c = equipmentService.get(new Long(id));
			c.setStatus(Status.EquipCompon.unused);
			c.setEquipDiary(null);
			c.setFlowId(null);
			c.setProjectId(null);
			c.setProjectName(null);
			c.setProjectAddress(null);
			c.setBusinessStatus(Status.EquipBusiness.disenable);
			c.setStatusDate(currentDate);
			equipmentService.save(c);
		}
		return SUCCESS;
	}

	@ActionLog(description = "更新设备状态")
	public String refresh() {
		equipmentService.refresh();
		return SUCCESS;
	}

	@ActionLog(description = "一机一档")
	public String printDocument() {
		equipment = equipmentService.getTranslateFull(equipId);
		getRequest().setAttribute("currentDate", DateUtil.getCurrentCNDateStr());
		// 所属部件信息
		List<Map<String, Object>> componDairyList = equipmentService.queryByScript("equipdoc.include_compon_diary", equipId);
		Map<Long, EquipComponDocmodel> equipComponDairys = new HashMap<Long, EquipComponDocmodel>();
		for (Map<String, Object> data : componDairyList) {
			Long componId = (Long) data.get("COMPON_ID");
			EquipComponDocmodel compon = null;
			if (equipComponDairys.containsKey(componId)) {
				compon = equipComponDairys.get(componId);
			} else {
				compon = new EquipComponDocmodel();
				compon.setComponId(componId);
				compon.setPurchaseDate((String) data.get("PURCHASE_DATE"));
				compon.setComponGenericName((String) data.get("COMPON_GENERIC"));
				compon.setComponSpecificName((String) data.get("COMPON_SPECIFIC"));
				compon.setStatusName(CodeServiceImpl.fastValue("EQUIP_COMPON_STATUS", (String) data.get("STATUS")));
				equipComponDairys.put(componId, compon);
			}
			Map<String, String> diary = new HashMap<String, String>();
			diary.put("START_DATE", (String) data.get("START_DATE"));
			diary.put("END_DATE", (String) data.get("END_DATE"));
			diary.put("PROJECT_NAME", (String) data.get("PROJECT_NAME"));
			diary.put("ADDRESS", (String) data.get("ADDRESS"));
			compon.getComponDiarys().add(diary);
		}
		getRequest().setAttribute("equipComponDairys", equipComponDairys.values());
		// 运行状态
		List<Map<String, Object>> rentout = equipmentService.queryByScript("equipdoc.rent_out_count", equipId);
		getRequest().setAttribute("rentout", rentout.get(0).get("COUNTS"));
		List<Map<String, Object>> receivesum = equipmentService.queryByScript("equipdoc.receive_sum", equipId);
		BigDecimal receive = (BigDecimal) receivesum.get(0).get("PRESENT_AMOUNT");
		getRequest().setAttribute("receivesum", receive);
		List<Map<String, Object>> paymentsum = equipmentService.queryByScript("equipdoc.payment_sum", equipId);
		BigDecimal payment = (BigDecimal) paymentsum.get(0).get("PRESENT_AMOUNT");
		getRequest().setAttribute("paymentsum", payment);
		if (payment.compareTo(BigDecimal.ZERO) == 1) {
			getRequest().setAttribute("grossProfitRate", receive.subtract(payment).multiply(new BigDecimal(100)).divide(payment).setScale(BigDecimal.ROUND_HALF_EVEN).toString() + "%");
		} else {
			getRequest().setAttribute("grossProfitRate", "0.00%");
		}
		List<Map<String, Object>> occupancyrate = equipmentService.queryByScript("equipdoc.occupancy_rate", equipId);
		getRequest().setAttribute("occupancyrate", occupancyrate.get(0).get("OCCUPANCY_RATE") + "%");
		List<Map<String, Object>> equipdiarys = equipmentService.queryByScript("equipdoc.top2_diary", equipId);
		if (!equipdiarys.isEmpty()) {
			if (Status.EquipComponStore.warehoused.equals(equipdiarys.get(0).get("WORK_STATUS"))) { // 已入库
				getRequest().setAttribute("lastProjectName", equipdiarys.get(0).get("PROJECT_NAME"));
				getRequest().setAttribute("lastProjectAddress", equipdiarys.get(0).get("ADDRESS"));
			} else {
				getRequest().setAttribute("currentProjectName", equipdiarys.get(0).get("PROJECT_NAME"));
				getRequest().setAttribute("currentProjectAddress", equipdiarys.get(0).get("ADDRESS"));
				getRequest().setAttribute("currentActivateDate", equipdiarys.get(0).get("ACTIVATE_DATE"));
				getRequest().setAttribute("currentUnEntName", equipdiarys.get(0).get("UN_CUSTOM_NAME"));
				if (equipdiarys.size() == 2) {
					getRequest().setAttribute("lastProjectName", equipdiarys.get(1).get("PROJECT_NAME"));
					getRequest().setAttribute("lastProjectAddress", equipdiarys.get(1).get("ADDRESS"));
				}
			}
		}
		// 租赁合同
		List<Map<String, Object>> contracts = equipmentService.queryByScript("equipdoc.contract", equipId);
		for (Map<String, Object> data : contracts) {
			data.put("APPLYFOR_STATE", CodeServiceImpl.fastValue("CONTRACT_APPLYFOR_STATUS", (String) data.get("APPLYFOR_STATE")));
		}
		getRequest().setAttribute("contracts", contracts);
		// 结算信息
		List<Map<String, Object>> settles = equipmentService.queryByScript("equipdoc.settle", equipId);
		for (Map<String, Object> data : settles) {
			data.put("FUND_STATUS", CodeServiceImpl.fastValue("FUND_PLAN_STATUS", (String) data.get("FUND_STATUS")));
		}
		getRequest().setAttribute("settles", settles);
		// 调度信息
		List<Map<String, Object>> dispatchs = equipmentService.queryByScript("equipdoc.dispatch", equipId);
		for (Map<String, Object> data : dispatchs) {
			data.put("APPLYFOR_STATE", CodeServiceImpl.fastValue("DISPATCH_APPLYFOR_STATE", (String) data.get("APPLYFOR_STATE")));
		}
		getRequest().setAttribute("dispatchs", dispatchs);
		// 安装启用
		List<Map<String, Object>> installs = equipmentService.queryByScript("equipdoc.install", equipId);
		getRequest().setAttribute("installs", installs);
		//顶升加节
		List<Map<String, Object>> jjcomponts = equipmentService.queryByScript("equipdoc.jj", equipId);
		getRequest().setAttribute("jjcomponts", jjcomponts);
		// 检测信息
		List<Map<String, Object>> detects = equipmentService.queryByScript("equipdoc.detect", equipId);
		getRequest().setAttribute("detects", detects);
		// 验收信息
		List<Map<String, Object>> verifys = equipmentService.queryByScript("equipdoc.verify", equipId);
		getRequest().setAttribute("verifys", verifys);
		// 使用信息
		List<Map<String, Object>> employs = equipmentService.queryByScript("equipdoc.employ", equipId);
		getRequest().setAttribute("employs", employs);
		// 巡检信息
		List<Map<String, Object>> inspects = equipmentService.queryByScript("equipdoc.inspect", equipId);
		getRequest().setAttribute("inspects", inspects);
		// 维保记录
		List<Map<String, Object>> maints = equipmentService.queryByScript("equipdoc.maint", equipId);
		getRequest().setAttribute("maints", maints);
		// 拆卸信息
		List<Map<String, Object>> dismantles = equipmentService.queryByScript("equipdoc.dismantle", equipId);
		getRequest().setAttribute("dismantles", dismantles);
		// 保险信息
		List<Map<String, Object>> insures = equipmentService.queryByScript("equipdoc.insure", equipId);
		getRequest().setAttribute("insures", insures);
		// 收款明细
		List<Map<String, Object>> receives = equipmentService.queryByScript("equipdoc.receive", equipId);
		for (Map<String, Object> data : receives) {
			data.put("RECEIVE_STATUS", CodeServiceImpl.fastValue("FUND_STATUS", (String) data.get("RECEIVE_STATUS")));
		}
		getRequest().setAttribute("receives", receives);
		// 支出明细
		List<Map<String, Object>> payments = equipmentService.queryByScript("equipdoc.payment", equipId);
		for (Map<String, Object> data : payments) {
			data.put("PAYMENT_STATUS", CodeServiceImpl.fastValue("FUND_STATUS", (String) data.get("PAYMENT_STATUS")));
		}
		getRequest().setAttribute("payments", payments);
		return "equipDocument";
	}

	public String loadMaterialGather() throws Exception {
		String path = ApplicationContainer.getAppAbsolutePath() + "/WEB-INF/classes/resource/material.js";
		String content = ReadWriteFileUtil.readFileForStr(path);
		setJsonString(content);System.out.println("详明16");
		return SUCCESS;
	}

	public String distribute() {
		QueryFilter filter = new QueryFilter(getRequest());
		List<Map<String, Object>> list = equipmentService.queryDistributeMapInfo(filter);
		StringBuffer buff = new StringBuffer("{success:true,'totalCounts':").append(filter.getPagingBean().getTotalItems()).append(",result:");
		buff.append(GsonUtil.toJson(list, DateUtil.LINK_DISPLAY_DATE));
		buff.append("}");
		this.jsonString = buff.toString();
		return SUCCESS;
	}
	
	public String examine(){
		
		Equipment c = equipmentService.get(equipment.getEquipId());
		c.setExamineDate(equipment.getExamineDate());
		equipmentService.save(c);
		System.out.println("详明18");
		return SUCCESS;
		
	}
	//确认
	public String confirm(){
		String[] ids = getRequest().getParameterValues("ids");
		for (String id : ids) {
			Equipment c = equipmentService.get(new Long(id));			
			c.setStatus("1");
			equipmentService.save(c);
		}
			return SUCCESS;
			
		}
}
