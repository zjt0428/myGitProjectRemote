<?xml version="1.0" encoding="UTF-8"?>
<mapper namespace="equipdoc">
    <!-- 设备所属部件及使用信息 -->
    <select id="include_compon_diary">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT C.COMPON_ID,
		       C.STATUS,
		       (SELECT CG.VALUE FROM BM_COMPONENT_GENERIC CG WHERE CG.CODE = C.COMPON_GENERIC) COMPON_GENERIC,
		       (SELECT CG.VALUE FROM BM_COMPONENT_SPECIFIC CG WHERE CG.CODE = C.COMPON_SPECIFIC) COMPON_SPECIFIC,
		       CONVERT(VARCHAR(10), C.PURCHASE_DATE, 23) PURCHASE_DATE,
		       CONVERT(VARCHAR(10), CD.START_DATE, 23) START_DATE,
		       CONVERT(VARCHAR(10), CD.END_DATE, 23) END_DATE,
		       CD.PROJECT_NAME,
		       CD.ADDRESS
		  FROM T_COMPONENT C
		  LEFT JOIN T_COMPONENT_DIARY CD ON CD.COMPON_ID = C.COMPON_ID
		 WHERE C.DEL_FLAG = '1'
		   AND C.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 总出租次数 -->
    <select id="rent_out_count">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT COUNT(*) COUNTS
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D
		 WHERE (D.APPLYFOR_STATE = '3' OR D.APPLYFOR_STATE = '5')
		   AND D.DISPATCH_ID = DE.DISPATCH_ID
		   AND DE.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 总收入（元） -->
    <select id="receive_sum">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT ISNULL(SUM(AES.PRESENT_AMOUNT), 0) PRESENT_AMOUNT
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_RECEIVE AR
		 WHERE AR.APPLYFOR_STATE = '3'
		   AND AR.AMOUNT_RECEIVE_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_RECEIVE'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 总支出（元） -->
    <select id="payment_sum">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT ISNULL(SUM(AES.PRESENT_AMOUNT), 0) PRESENT_AMOUNT
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_PAYMENT AP
		 WHERE AP.APPLYFOR_STATE = '3'
		   AND AP.AMOUNT_PAYMENT_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_PAYMENT'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 总出租率 -->
    <select id="occupancy_rate">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CAST(CAST(ISNULL(SUM(DATEDIFF(DAY, ED.START_DATE, (CASE WHEN ED.END_DATE > GETDATE() THEN GETDATE() ELSE ED.END_DATE END))), 0) AS FLOAT) /
		       CAST(ISNULL((SELECT (DATEDIFF(DAY, E.PURCHASE_DATE, GETDATE())) FROM T_EQUIPMENT E WHERE E.EQUIP_ID = @EQUIP_ID), 1) AS FLOAT) * 100 AS DEC(5, 2)) OCCUPANCY_RATE
		  FROM T_EQUIPMENT_DIARY ED
		 WHERE ED.ACTIVE = '1'
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 最近调配记录(当前、上一次) -->
    <select id="top2_diary">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT TOP 2 P.PROJECT_NAME,
		       P.ADDRESS,
		       ED.ACTIVATE_DATE,
		       P.UN_CUSTOM_NAME,
		       DE.WORK_STATUS
		  FROM T_DISPATCH_EQUIP DE, T_EQUIPMENT_DIARY ED LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID
		 WHERE ED.ACTIVE = '1'
		   AND ED.EQUIP_ID = @EQUIP_ID
		   AND ED.PROJECT_ID > 0
		   AND DE.DISPATCH_EQUIP_ID = ED.BUSINESS_EQUIP_ID
		 ORDER BY ED.START_DATE DESC
	]]>
    </select>
    <!-- 租赁合同 -->
    <select id="contract">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CL.APPLYFOR_STATE,
		       CL.CONTRACT_SERIAL,
		       CL.PB_ENT_NAME,
		       CL.PROJECT_NAME,
		       CL.SIGNING_TIME,
		       CL.CONTRACT_AMOUNT,
		       CL.SALESMAN
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D, T_CONTRACT_LEASE CL
		 WHERE DE.DISPATCH_ID = D.DISPATCH_ID
		   AND DE.EQUIP_ID = @EQUIP_ID
		   AND (D.APPLYFOR_STATE = '3' OR D.APPLYFOR_STATE = '5')
		   AND D.RELATE_ID = CL.CONTRACT_ID
		   AND D.RELATE_MODULE = 'CONTRACT_LEASE'
	]]>
    </select>
    <!-- 租赁合同-资料打印 -->
    <select id="contractByPE">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		DECLARE @PROJECT_ID BIGINT
		SET @EQUIP_ID = ?
		SET @PROJECT_ID = ?
		SELECT * FROM T_CONTRACT_EQUIP CE
		LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = CE.CONTRACT_ID
		WHERE CE.EQUIP_ID = @EQUIP_ID
		AND CL.PROJECT_ID = @PROJECT_ID
	]]>
    </select>
    <!-- 结算信息 -->
    <select id="settle">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT SC.FUND_STATUS,
		       SC.SETTLE_SERIAL,
		       SC.START_SETTLE_DATE,
		       SC.END_SETTLE_DATE,
		       SC.SETTLE_AMOUNT,
		       SC.PROJECT_NAME,
		       SC.PA_ENT_NAME
		  FROM T_SETTLE_EQUIP_BRIEF SEB, T_SETTLE_CONTRACT SC
		 WHERE SEB.EQUIP_ID = @EQUIP_ID
		   AND SEB.SETTLE_ID = SC.SETTLE_ID
		   AND SC.EFFECTIVE = '1'
	]]>
    </select>
    <!-- 调度信息 -->
    <select id="dispatch">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT D.APPLYFOR_STATE,
		       D.PROJECT_NAME,
		       D.ADDRESS,
		       CONVERT(VARCHAR(10), DE.START_DATE, 23) START_DATE,
		       D.PROJECT_MANAGER
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D
		 WHERE DE.EQUIP_ID = @EQUIP_ID
		   AND DE.DISPATCH_ID = D.DISPATCH_ID
		   AND (D.APPLYFOR_STATE = '3' OR D.APPLYFOR_STATE = '5')
	]]>
    </select>
    <!-- 安装启用 -->
    <select id="install">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CONVERT(VARCHAR(10), EI.STARTIN_DATE, 23) STARTIN_DATE,
		       CONVERT(VARCHAR(10), EI.ENDIN_DATE, 23) ENDIN_DATE,
		       EA.ACTIVATE_DATE,
		       ED.PROJECT_NAME,
		       EI.INSTALL_HEIGHT,
		       EI.PRINCIPAL
		  FROM T_EQUIPMENT_INSTALL EI, T_EQUIPMENT_DIARY ED LEFT JOIN T_EQUIPMENT_ACTIVATE EA ON EA.FLOW_ID = ED.FLOW_ID
		 WHERE ED.FLOW_ID = EI.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
		   AND (EI.APPLYFOR_STATE = '3' OR EI.APPLYFOR_STATE = '4')
	]]>
    </select>
    <!--  顶升加节 -->
    <select id="jj">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CD.COMPON_GENERIC,
		CD.COUNTS,
		CD.PROJECT_NAME,
		CD.JJUSERNAME,
		CD.START_DATE
		FROM T_COMPONENT_DIARY CD
		WHERE CD.JJSTAUTS = '2'
	]]>
    </select>
    <!-- 检测信息 -->
    <select id="detect">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EDE.DETECT_SERIAL,
		       EDE.DETECT_ENT_NAME,
		       EDE.DETECT_DATE,
		       ED.PROJECT_NAME,
		       EDE.DETECT_RESULT
		  FROM T_EQUIPMENT_DETECT EDE, T_EQUIPMENT_DIARY ED
		 WHERE EDE.DEL_FLAG = '1'
		   AND ED.FLOW_ID = EDE.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 验收信息 -->
    <select id="verify">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EV.VERIFY_SERIAL,
		       EV.EM_ENT_NAME,
		       EV.VERIFY_RESULT,
		       ED.PROJECT_NAME,
		       ED.ADDRESS
		  FROM T_EQUIPMENT_VERIFY EV, T_EQUIPMENT_DIARY ED
		 WHERE EV.DEL_FLAG = '1'
		   AND ED.FLOW_ID = EV.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 使用信息 -->
    <select id="employ">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CONVERT(VARCHAR(10), EE.EMPLOY_DATE, 23) EMPLOY_DATE,
			   CONVERT(VARCHAR(10), EE.END_PLAN_DATE, 23) END_PLAN_DATE,
		       P.UN_CUSTOM_NAME,
		       ED.PROJECT_NAME,
		       ED.ADDRESS
		  FROM T_EQUIPMENT_EMPLOY EE, T_EQUIPMENT_DIARY ED LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID
		 WHERE (EE.APPLYFOR_STATE = '3' OR EE.APPLYFOR_STATE = '4')
		   AND ED.FLOW_ID = EE.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 巡检信息 -->
    <select id="inspect">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EI.INSPECT_SERIAL,
		       CONVERT(VARCHAR(10), EI.INSPECT_DATE, 23) INSPECT_DATE,
		       EI.INSPECT_PEPOLES,
		       (SELECT IR.VALUE FROM BM_INSPECT_RESULT IR WHERE IR.CODE = EI.INSPECT_RESULT) INSPECT_RESULT,
		       ED.PROJECT_NAME
		  FROM T_EQUIPMENT_INSPECT EI, T_EQUIPMENT_INSPECT_SCHEMA EIS, T_EQUIPMENT_DIARY ED
		 WHERE EI.INSPECT_SCHEMA_ID = EIS.INSPECT_SCHEMA_ID
		   AND EIS.FLOW_ID = ED.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 维保记录 -->
    <select id="maint">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EM.MAINT_SERIAL,
		       CONVERT(VARCHAR(10), EM.MAINT_DATE, 23) MAINT_DATE,
		       EM.MAINT_PEPOLES,
		       (SELECT MT.VALUE FROM BM_MAINT_TYPE MT WHERE MT.CODE = EMS.MAINT_TYPE) MAINT_TYPE,
		       CONVERT(VARCHAR(10), EM.THIS_END_CYCLE_DATE, 23) THIS_END_CYCLE_DATE,
		       (SELECT IR.VALUE FROM BM_INSPECT_RESULT IR WHERE IR.CODE = EM.MAINT_RESULT) MAINT_RESULT
		  FROM T_EQUIPMENT_MAINT EM, T_EQUIPMENT_MAINT_SCHEMA EMS, T_EQUIPMENT_DIARY ED
		 WHERE EM.MAINT_SCHEMA_ID = EMS.MAINT_SCHEMA_ID
		   AND EMS.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
		   AND EM.STATUS > '0'
	]]>
    </select>
    <!-- 拆卸信息 -->
    <select id="dismantle">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CONVERT(VARCHAR(10), DIS.STARTDIS_DATE, 23) STARTDIS_DATE,
			   CONVERT(VARCHAR(10), DIS.ENDDIS_DATE, 23) ENDDIS_DATE,
		       DBO.F_MERGE_DISMANTLE_PRACTI(DIS.DISMANTLE_ID, 'EQUIP_DISMANTLE') PRACTI_NAMES,
		       ED.PROJECT_NAME,
		       DIS.DISMANTLE_HEIGHT,
		       DIS.PRINCIPAL
		  FROM T_EQUIPMENT_DISMANTLE DIS, T_EQUIPMENT_DIARY ED
		 WHERE (DIS.APPLYFOR_STATE = '3' OR DIS.APPLYFOR_STATE = '4')
		   AND DIS.FLOW_ID = ED.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 保险信息 -->
    <select id="insure">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT IE.INSURANCE_COMPANY,
		       IE.START_INSURE_DATE,
		       IE.END_INSURE_DATE,
		       IE.INSURE_SERIAL,
		       IE.PREMIUM,
		       (SELECT SUM(IC.COMPENSATE_AMOUNT) FROM T_INSURE_CLAIM IC WHERE IC.INSURE_ID = IE.INSURE_ID) COMPENSATE_AMOUNT
		  FROM T_INSURE_EQUIPMENT IE 
		 WHERE IE.DEL_FLAG = '1'
		   AND IE.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 收款明细 -->
    <select id="receive">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT AR.AMOUNT_SERIAL,
		       AR.PAYMENT_NAME,
		       AR.RECEIVE_DATE,
		       AR.RECEIVE_AMOUNT,
		       AR.RECEIVE_STATUS
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_RECEIVE AR
		 WHERE AR.APPLYFOR_STATE = '3'
		   AND AR.AMOUNT_RECEIVE_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_RECEIVE'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 支出明细 -->
    <select id="payment">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT AP.RELATE_THEME,
		       AP.RECEIVE_NAME,
		       AP.PAYMENT_DATE,
		       AP.PAYMENT_AMOUNT,
		       AP.PAYMENT_STATUS
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_PAYMENT AP
		 WHERE AP.APPLYFOR_STATE = '3'
		   AND AP.AMOUNT_PAYMENT_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_PAYMENT'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- ==============================================设备分布==================================== -->
    <!-- 设备省份分布 -->
    <select id="province_map_info">
        <![CDATA[
		SELECT '0' AREA_TYPE, A.CODE AREA_ID, A.VALUE AREA_NAME, A.LONGITUDE, A.LATITUDE, CAST(A.COUNTS AS VARCHAR) + ' 台' STAT_COUNTS
		  FROM (SELECT B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE, COUNT(B.VALUE) COUNTS
		          FROM T_EQUIPMENT       E,
		               T_EQUIPMENT_DIARY ED,
		               T_PROJECT         P,
		               BM_PROVINCE       B
		         WHERE E.FLOW_ID = ED.FLOW_ID
		           AND ED.PROJECT_ID = P.PROJECT_ID
		           AND P.PROVINCE = B.CODE
		           AND P.DEL_FLAG=1
		         GROUP BY B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE) A
		  WHERE 1 = 1
	]]>
    </select>
    <!-- 设备城市分布 -->
    <select id="city_map_info">
        <![CDATA[
		SELECT '1' AREA_TYPE, A.CODE AREA_ID, A.VALUE AREA_NAME, A.LONGITUDE, A.LATITUDE, CAST(A.COUNTS AS VARCHAR) + ' 台' STAT_COUNTS
		  FROM (SELECT P.PROVINCE, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE, COUNT(B.VALUE) COUNTS
		          FROM T_EQUIPMENT       E,
		               T_EQUIPMENT_DIARY ED,
		               T_PROJECT         P,
		               BM_CITY           B
		         WHERE E.FLOW_ID = ED.FLOW_ID
		           AND ED.PROJECT_ID = P.PROJECT_ID
		           AND P.CITY = B.CODE
		           AND P.DEL_FLAG=1
		         GROUP BY P.PROVINCE, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE) A
		  WHERE 1 = 1
	]]>
    </select>
    <!-- 设备区县分布 -->
    <select id="country_map_info">
        <![CDATA[
		SELECT '2' AREA_TYPE, A.CODE AREA_ID, A.VALUE AREA_NAME, A.LONGITUDE, A.LATITUDE, CAST(A.COUNTS AS VARCHAR) + ' 台' STAT_COUNTS
		  FROM (SELECT P.PROVINCE, P.CITY, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE, COUNT(B.VALUE) COUNTS
		          FROM T_EQUIPMENT       E,
		               T_EQUIPMENT_DIARY ED,
		               T_PROJECT         P,
		               BM_COUNTY         B
		         WHERE E.FLOW_ID = ED.FLOW_ID
		           AND ED.PROJECT_ID = P.PROJECT_ID
		           AND P.COUNTY = B.CODE
		           AND P.DEL_FLAG=1
		         GROUP BY P.PROVINCE, P.CITY, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE) A
		  WHERE 1 = 1
	]]>
    </select>
    <select id="settleEquipByPE">
        <![CDATA[
            SELECT * FROM T_SETTLE_EQUIP_BRIEF SE
            LEFT JOIN T_SETTLE_CONTRACT SC ON SC.SETTLE_ID = SE.SETTLE_ID
            WHERE SE.EQUIP_ID = ?
            AND SC.PROJECT_ID = ?
        ]]>
    </select>
    <select id="indisSchemaByPE">
        <![CDATA[
            SELECT * FROM T_INDIS_SCHEMA S
            WHERE S.EQUIP_ID = ?
            AND S.PROJECT_ID = ?
            AND S.RELATE_MODULE = 'EQUIP_INSTALL'
        ]]>
    </select>
    
    <!-- 设备分布情况看板 -->>
	<select id="equip_distribution">
	<![CDATA[
		DECLARE @province VARCHAR(2)
		SET @province=?
		SELECT 
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 WHERE e.DEL_FLAG = 1 AND p.CITY=bc.code) counts,
			bc.CODE code,
	 		bc.[VALUE] value,
	 		bc.LONGITUDE longitude, 
			bc.LATITUDE latitude,
	 		(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.STATUS =0  AND e.DEL_FLAG = 1) inuseCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e  WHERE e.STATUS =1  AND e.DEL_FLAG = 1) idleCount,
			round(cast(isnull(cast((SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 WHERE e.STATUS =0  AND e.DEL_FLAG = 1)*1.0/
				nullif((SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEL_FLAG = 1),0) as decimal(10,2)),0)*100 as int),2) inuseRate,
			round(cast(isnull(cast((SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1  WHERE e.STATUS =1  AND e.DEL_FLAG = 1 )*1.0/
				nullif((SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEL_FLAG = 1),0) as decimal(10,2)),0)*100 as int),2) idleRate,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 WHERE  p.CITY = bc.CODE AND e.EQUIP_GENERIC='T' AND e.DEL_FLAG = 1 ) towerCityCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='T' AND e.DEL_FLAG = 1 AND e.STATUS =0) towerCityInuseCount,	
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='T' AND e.DEL_FLAG = 1 AND e.STATUS =1) towerCityIdleCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='S' AND e.DEL_FLAG = 1) liftCityCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='S' AND e.DEL_FLAG = 1 AND e.STATUS =0) liftCityInuseCount,	
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='S' AND e.DEL_FLAG = 1 AND e.STATUS =1) liftCityIdleCount,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='T' AND tt.DEL_FLAG = 1) towerTotalCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='T' AND tt.DEL_FLAG = 1 AND tt.STATUS =0 ) towerInuseCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='T' AND tt.DEL_FLAG = 1 AND tt.STATUS =1 ) towerIdleCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='S' AND tt.DEL_FLAG = 1) liftTotalCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='S' AND tt.DEL_FLAG = 1 AND tt.STATUS =0 ) liftInuseCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='S' AND tt.DEL_FLAG = 1 AND tt.STATUS =1 ) liftIdleCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.DEL_FLAG = 1) totalCounts,
			(SELECT COUNT(p.PROJECT_ID) FROM T_PROJECT p WHERE p.CITY = bc.CODE AND p.DEL_FLAG=1) cityProjectCount
		FROM 
			BM_CITY bc 
		 WHERE 
		     bc.CODE LIKE @province+'%'
	]]>
	</select>
		
	<!-- 设备看板（巡检预警提醒） -->
	<select id="equip_inspect_warning">
	<![CDATA[
		SELECT (SELECT COUNT(*) FROM T_EQUIPMENT_INSPECT WHERE STATUS = 2) AS overdueNotInspect,
		round(cast(isnull(cast((SELECT COUNT(*) 
								FROM T_EQUIPMENT_INSPECT 
								WHERE STATUS = 1 OR STATUS = 3)*1.0/
					NULLIF((SELECT COUNT(*) 
							FROM T_EQUIPMENT_INSPECT ),0) as decimal(10,2)),0)*100 as int),2) AS inspectCompleted,
		(SELECT COUNT(*) FROM 
				(SELECT e.EQUIP_ID AS i FROM T_EQUIPMENT e 
					WHERE e.EQUIP_ID IN (
						SELECT ef.EQUIP_ID FROM T_EQUIPMENT_FLOW ef 
						LEFT JOIN T_EQUIPMENT_INSTALL ei ON ei.INSTALL_ID = ef.INSTALL_ID AND ei.APPLYFOR_STATE = 3  
						WHERE ei.DEL_FLAG = 1) 
					AND e.DEL_FLAG=1) j 
		WHERE j.i NOT IN ( SELECT efw.EQUIP_ID FROM T_EQUIPMENT_FLOW efw LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.FLOW_ID = efw.FLOW_ID ))AS installNotPlan,
		round(cast(isnull(cast(
						(SELECT COUNT(e.EQUIP_ID) 
							FROM T_EQUIPMENT e 
							WHERE e.EQUIP_ID IN (SELECT ef.EQUIP_ID FROM T_EQUIPMENT_FLOW ef 
													LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eis ON eis.FLOW_ID = ef.FLOW_ID) 
							AND e.DEL_FLAG=1)*1.0/
				NULLIF((SELECT COUNT(*) 
						FROM T_EQUIPMENT e 
						LEFT JOIN T_EQUIPMENT_FLOW ef ON ef.EQUIP_ID=e.EQUIP_ID 
						LEFT JOIN T_EQUIPMENT_INSTALL tei ON tei.FLOW_ID=ef.FLOW_ID
						WHERE e.DEL_FLAG=1 AND tei.DEL_FLAG=1),0) as decimal(10,2)),0)*100 as int),2) AS inspectPlanRate,
		(SELECT COUNT(*) AS a FROM T_APP_REPAIR WHERE STATE = 1) AS maintNotManage,
		(CONVERT(decimal(18, 1),(SELECT COUNT(*) FROM T_APP_REPAIR apr WHERE apr.STATE = 0 OR apr.STATE = 4) * 1.0 / 
		nullif((SELECT COUNT(*) FROM T_APP_REPAIR apr),0)) * 100) AS maintCompleted
	]]>
	</select>
	
	<!-- 设备看板（本周巡检排行） -->
	<select id="equip_inspect_week_ranking">
	<![CDATA[
		DECLARE @START INT
		DECLARE @PAGE_SIZE INT
		SET @START = ?
		SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT _a.DEP_ID depId,
			_a.DEP_NAME depName,
			ROW_NUMBER() OVER (ORDER BY _a.corpInspectCompleted DESC) AS _ROWNUM,
			_a.corpInspectCompleted,
			_a.corpInspectPlan,
			_a.corpMaintCompleted 
		FROM (
			SELECT
				ci.DEP_ID,
				ci.DEP_NAME,
				(CONVERT(decimal(18, 2),(
						SELECT COUNT(e.EQUIP_ID) 
						FROM T_EQUIPMENT e 
						WHERE  e.EQUIP_ID IN (SELECT ef.EQUIP_ID FROM T_EQUIPMENT_FLOW ef 
													LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eis ON eis.FLOW_ID = ef.FLOW_ID
													WHERE DATEDIFF(week,eis.CYCLE_ACTIVATE_DATE,GETDATE())=0) 
															AND e.DEP_ID = ci.DEP_ID 
							AND e.DEL_FLAG = 1) * 1.0 / 
				NULLIF((SELECT COUNT(*) FROM T_EQUIPMENT e 
							LEFT JOIN T_EQUIPMENT_FLOW ef ON ef.EQUIP_ID=e.EQUIP_ID 
							LEFT JOIN T_EQUIPMENT_INSTALL tei ON tei.FLOW_ID=ef.FLOW_ID
							WHERE e.DEP_ID = ci.DEP_ID 
									AND tei.APPLYFOR_STATE = 3
									AND e.DEL_FLAG = 1 
									AND	tei.DEL_FLAG = 1 AND DATEDIFF(week,tei.ENDIN_DATE,GETDATE())=0),0)
				)* 100 ) corpInspectPlan,
				(CONVERT(decimal(18, 2),(
						SELECT COUNT(ei.INSPECT_ID) 
							FROM T_EQUIPMENT_INSPECT ei 
							LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID 
							LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_DIARY_ID = eic.EQUIP_DIARY_ID 
							LEFT JOIN T_EQUIPMENT e ON e.EQUIP_ID=ed.EQUIP_ID
							WHERE e.DEP_ID = ci.DEP_ID 
								AND (ei.STATUS = 1 
								OR ei.STATUS = 3)
								AND DATEDIFF(week,ei.INSPECT_DATE,GETDATE())=0
								AND e.DEL_FLAG = 1) * 1.0 / 
						nullif((SELECT COUNT(ei.INSPECT_ID) FROM T_EQUIPMENT_INSPECT ei 
									LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID 
									LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_DIARY_ID = eic.EQUIP_DIARY_ID 
									LEFT JOIN T_EQUIPMENT e ON e.EQUIP_ID=ed.EQUIP_ID
									WHERE e.DEP_ID = ci.DEP_ID 
												AND DATEDIFF(week,ei.INSPECT_DATE,GETDATE())=0
												AND e.DEL_FLAG = 1),0)) * 100 
				) AS corpInspectCompleted,
				(CONVERT(decimal(18, 1),(
								SELECT count(apr.REPID) FROM T_APP_REPAIR apr 
									LEFT JOIN T_EQUIPMENT e ON apr.EQUIP_ID = e.EQUIP_ID 
									WHERE apr.STATE=4 
										AND e.DEP_ID = ci.DEP_ID 
										AND DATEDIFF(week,apr.REPORT_DT,GETDATE())=0
										AND e.DEL_FLAG = 1) * 1.0 / 
						nullif((SELECT count(apr.REPID) FROM T_APP_REPAIR apr 
									LEFT JOIN T_EQUIPMENT e ON apr.EQUIP_ID = e.EQUIP_ID 
									WHERE  DATEDIFF(week,apr.REPORT_DT,GETDATE())=0
										AND e.DEL_FLAG = 1),0)) * 100) AS corpMaintCompleted
			FROM
					DEPARTMENT ci
			WHERE ci.DEP_ID IN(90,91,93,94,110) AND ci.DELFLAG=1	
			)  _a
		)
		SELECT * FROM QUERY q WHERE _ROWNUM >@START AND _ROWNUM <= (@START +  @PAGE_SIZE)  ORDER BY q.corpInspectCompleted DESC
	]]>
	</select>
	
	<!-- 设备看板（本月巡检排行） -->
	<select id="equip_inspect_month_ranking">
	<![CDATA[
		WITH QUERY AS (
		SELECT _a.DEP_ID depId,
			_a.DEP_NAME depName,
			ROW_NUMBER() OVER (ORDER BY _a.corpInspectCompleted DESC) AS _ROWNUM,
			_a.corpInspectCompleted,
			_a.corpInspectPlan,
			_a.corpMaintCompleted 
		FROM (
			SELECT
				ci.DEP_ID,
				ci.DEP_NAME,
				(CONVERT(decimal(18, 2),(
						SELECT COUNT(e.EQUIP_ID) 
						FROM T_EQUIPMENT e 
						WHERE  e.EQUIP_ID  IN (SELECT ef.EQUIP_ID FROM T_EQUIPMENT_FLOW ef 
													LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eis ON eis.FLOW_ID = ef.FLOW_ID
													WHERE DATEDIFF(month,eis.CYCLE_ACTIVATE_DATE,GETDATE())=0) 
															AND e.DEP_ID = ci.DEP_ID 
							AND e.DEL_FLAG = 1) * 1.0 / 
				NULLIF((SELECT COUNT(*) FROM T_EQUIPMENT e 
							LEFT JOIN T_EQUIPMENT_FLOW ef ON ef.EQUIP_ID=e.EQUIP_ID 
							LEFT JOIN T_EQUIPMENT_INSTALL tei ON tei.FLOW_ID=ef.FLOW_ID
							WHERE e.DEP_ID = ci.DEP_ID 
									AND tei.APPLYFOR_STATE = 3
									AND e.DEL_FLAG = 1 
									AND	tei.DEL_FLAG = 1 AND DATEDIFF(month,tei.ENDIN_DATE,GETDATE())=0),0)
				)* 100 ) corpInspectPlan,
				(CONVERT(decimal(18, 2),(
						SELECT COUNT(ei.INSPECT_ID) 
							FROM T_EQUIPMENT_INSPECT ei 
							LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID 
							LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_DIARY_ID = eic.EQUIP_DIARY_ID 
							LEFT JOIN T_EQUIPMENT e ON e.EQUIP_ID=ed.EQUIP_ID
							WHERE e.DEP_ID = ci.DEP_ID 
								AND (ei.STATUS = 1 
								OR ei.STATUS = 3)
								AND DATEDIFF(month,ei.INSPECT_DATE,GETDATE())=0
								AND e.DEL_FLAG = 1) * 1.0 / 
						nullif((SELECT COUNT(ei.INSPECT_ID) FROM T_EQUIPMENT_INSPECT ei 
									LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID 
									LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_DIARY_ID = eic.EQUIP_DIARY_ID 
									LEFT JOIN T_EQUIPMENT e ON e.EQUIP_ID=ed.EQUIP_ID
									WHERE e.DEP_ID = ci.DEP_ID 
												AND DATEDIFF(month,ei.INSPECT_DATE,GETDATE())=0
												AND e.DEL_FLAG = 1),0)) * 100 
				) AS corpInspectCompleted,
				(CONVERT(decimal(18, 1),(
								SELECT count(apr.REPID) FROM T_APP_REPAIR apr 
									LEFT JOIN T_EQUIPMENT e ON apr.EQUIP_ID = e.EQUIP_ID 
									WHERE apr.STATE=4 
										AND e.DEP_ID = ci.DEP_ID 
										AND DATEDIFF(month,apr.REPORT_DT,GETDATE())=0
										AND e.DEL_FLAG = 1) * 1.0 / 
						nullif((SELECT count(apr.REPID) FROM T_APP_REPAIR apr 
									LEFT JOIN T_EQUIPMENT e ON apr.EQUIP_ID = e.EQUIP_ID 
									WHERE  DATEDIFF(month,apr.REPORT_DT,GETDATE())=0
										AND e.DEL_FLAG = 1),0)) * 100) AS corpMaintCompleted
			FROM
					DEPARTMENT ci
			WHERE ci.DEP_ID IN(90,91,93,94,110) AND ci.DELFLAG=1
			)  _a
		)
		SELECT 
		depId,
		depName,
		ISNULL(corpInspectCompleted, 0) as 'corpInspectCompleted',
		ISNULL(corpInspectPlan, 0) as 'corpInspectPlan',
		ISNULL(corpMaintCompleted, 0) as 'corpMaintCompleted'		
		FROM QUERY 
	]]>
	</select>
	
	<!-- 设备看板（本年巡检排行） -->
	<select id="equip_inspect_year_ranking">
	<![CDATA[
		SELECT a.depId,a.depName,a.equipCount,ISNULL(inspectCompletion,0.00) inspectCompletion FROM (
			SELECT 
					ee.depId,
					(SELECT dt.DEP_NAME FROM DEPARTMENT dt WHERE dt.DEP_ID = ee.depId) depName,
					SUM(ee.equipCount) equipCount,
					(CAST(CAST((select COUNT(EQUIP_ID) from (
					SELECT te.EQUIP_ID,eic.CYCLE_ACTIVATE_DATE,eic.INSPECT_SCHEMA_ID,
					(SELECT COUNT(ei.INSPECT_SCHEMA_ID) FROM T_EQUIPMENT_INSPECT ei WHERE eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID) c
					FROM T_EQUIPMENT te
					INNER JOIN DEPARTMENT d ON d.dep_id = te.dep_id
					INNER JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_ID = te.EQUIP_ID
					INNER JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.EQUIP_DIARY_ID = ed.EQUIP_DIARY_ID AND DATEDIFF(year,GETDATE(),eic.CYCLE_ACTIVATE_DATE)=0
					WHERE eic.INSPECT_TIMES = (SELECT COUNT(ei.INSPECT_SCHEMA_ID) FROM T_EQUIPMENT_INSPECT ei WHERE eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID) 
								AND (te.DEP_ID = ee.depId OR (CASE WHEN d.DEP_LEVEL=4 THEN d.PARENT_ID ELSE d.DEP_ID END) = ee.depId) ) b 
					WHERE b.c != 0)*1.0*100/NULLIF(SUM(ee.equipCount),0) as decimal(10,2)) as varchar(50))) AS inspectCompletion
			FROM 
					(SELECT 
						COUNT(EQUIP_ID) equipCount,
						(CASE WHEN d.DEP_LEVEL= 4 THEN d.PARENT_ID ELSE d.DEP_ID END) depId
					FROM
						(
						SELECT  e.* FROM T_EQUIPMENT e
						LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_ID = e.EQUIP_ID
						LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.EQUIP_DIARY_ID = ed.EQUIP_DIARY_ID 
						WHERE DATEDIFF(year,GETDATE(),eic.CYCLE_ACTIVATE_DATE) = 0 AND e.DEL_FLAG=1 AND eic.DEL_FLAG=1
						) a RIGHT JOIN DEPARTMENT d ON a.DEP_ID = d.DEP_ID 
					WHERE
						 d.DEP_NAME LIKE '%分公司%' OR d.PARENT_ID IN ( 90, 91, 92, 93, 94, 95, 109, 110 )
					GROUP BY d.DEP_ID,d.DEP_LEVEL,d.PARENT_ID) ee
			GROUP BY ee.depId 
		) AS a ORDER BY CONVERT(FLOAT,inspectCompletion) desc
	]]>
	</select>
		<!--查询设备的权限归属 -->
	<select id="equip_permission_flag">
		<![CDATA[
		SELECT FULLNAME as fullName FROM APP_USER WHERE CHARINDEX('s'+CONVERT(VARCHAR,USERID)+'e',?)>0
			]]>
	</select>
	<select id="province_list">
	<![CDATA[
		SELECT
			bp.* 
		FROM
			BM_PROVINCE bp
		WHERE 
			bp.CODE IN (SELECT P.PROVINCE FROM T_PROJECT p LEFT JOIN T_EQUIPMENT e ON p.PROJECT_ID = e.PROJECT_ID WHERE p.DEL_FLAG=1 and e.PROJECT_ID is not null)
	]]>	
	</select>
	
	<!--本月巡检管理4个圈 -->
	<select id="current_month_inspect_collect">
	<![CDATA[
		SELECT 
		unfinishedCount = ISNULL(SUM(CASE WHEN P.CREATE_TIMES=0 OR P.CREATE_TIMES>EIS.INSPECT_TIMES THEN 1 ELSE 0 END),0),
		finishedCount = ISNULL(SUM(CASE WHEN P.CREATE_TIMES<>0 AND P.CREATE_TIMES=EIS.INSPECT_TIMES THEN 1 ELSE 0 END),0),
		abnormalCount = (SELECT COUNT(*) AS NUM FROM T_EQUIPMENT_INSPECT EI
											LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EI.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
											LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = EIS.FLOW_ID
											LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EF.EQUIP_ID
											WHERE  (EI.RECTIFICATION ='1' OR CHARINDEX(EI.INSPECT_RESULT,'012') > 0) 
											AND INSPECT_DATE>=DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0) 
											AND INSPECT_DATE < DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0)),
		normalCount = (SELECT COUNT(*) AS NUM  FROM T_EQUIPMENT_INSPECT EI
											LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EI.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
											LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = EIS.FLOW_ID
											LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EF.EQUIP_ID
											WHERE  (EI.RECTIFICATION <>'1' OR CHARINDEX(EI.INSPECT_RESULT,'3456') > 0) 
											AND INSPECT_DATE>=DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0) 
											AND INSPECT_DATE < DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0))
		FROM T_EQUIPMENT_INSPECT_SCHEMA EIS INNER JOIN
		(
			SELECT COUNT(S.INSPECT_SCHEMA_ID) AS 'CREATE_TIMES',T.INSPECT_SCHEMA_ID 
			FROM T_EQUIPMENT_INSPECT_SCHEMA T 
			LEFT JOIN T_EQUIPMENT_INSPECT S ON S.INSPECT_SCHEMA_ID = T.INSPECT_SCHEMA_ID 
			WHERE T.DEL_FLAG=1 AND T.CYCLE_ACTIVATE_DATE >= DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0)  --当月第一天
			AND T.CYCLE_ACTIVATE_DATE < DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0)	--下月第一天
			GROUP BY T.INSPECT_SCHEMA_ID 
		) P ON EIS.INSPECT_SCHEMA_ID=P.INSPECT_SCHEMA_ID
	]]>	
	</select>
	
	<!-- 设备看板（本季度巡检排行） -->
	<select id="equip_inspect_quarter_ranking">
	<![CDATA[
		SELECT a.depId,a.depName,a.equipCount,ISNULL(inspectCompletion,0.00) inspectCompletion FROM (
			SELECT 			
					ee.depId,
					(SELECT dt.DEP_NAME FROM DEPARTMENT dt WHERE dt.DEP_ID = ee.depId) depName,
					SUM(ee.equipCount) equipCount,
					(CAST(CAST((select COUNT(EQUIP_ID) from (SELECT te.EQUIP_ID,eic.CYCLE_ACTIVATE_DATE,eic.INSPECT_SCHEMA_ID,
						(SELECT COUNT(ei.INSPECT_SCHEMA_ID) FROM T_EQUIPMENT_INSPECT ei WHERE eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID) c
					FROM T_EQUIPMENT te
					INNER JOIN DEPARTMENT d ON d.dep_id = te.dep_id
					INNER JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_ID = te.EQUIP_ID
					INNER JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.EQUIP_DIARY_ID = ed.EQUIP_DIARY_ID AND DATEDIFF(QQ,eic.CYCLE_ACTIVATE_DATE,GETDATE())=0
					WHERE eic.INSPECT_TIMES = (SELECT COUNT(ei.INSPECT_SCHEMA_ID) FROM T_EQUIPMENT_INSPECT ei WHERE eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID) 
								AND (te.DEP_ID = ee.depId OR (CASE WHEN d.DEP_LEVEL=4 THEN d.PARENT_ID ELSE d.DEP_ID END) = ee.depId) ) b 
					WHERE b.c != 0)*1.0*100/NULLIF(SUM(ee.equipCount),0) as decimal(10,2)) as varchar(50))) AS inspectCompletion
			FROM 
					(SELECT 
						COUNT(EQUIP_ID) equipCount,
						(CASE WHEN d.DEP_LEVEL= 4 THEN d.PARENT_ID ELSE d.DEP_ID END) depId
					FROM
						(SELECT  e.* FROM T_EQUIPMENT e
						LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_ID = e.EQUIP_ID
						LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.EQUIP_DIARY_ID = ed.EQUIP_DIARY_ID 
						WHERE DATEDIFF(	QQ,eic.CYCLE_ACTIVATE_DATE,GETDATE()) = 0 AND e.DEL_FLAG=1 AND eic.DEL_FLAG=1
						) a RIGHT JOIN DEPARTMENT d ON a.DEP_ID = d.DEP_ID
					WHERE
						d.DEP_NAME LIKE '%分公司%' OR d.PARENT_ID IN ( 90, 91, 92, 93, 94, 95, 109, 110 )
					GROUP BY d.DEP_ID,d.DEP_LEVEL,d.PARENT_ID) ee
			GROUP BY ee.depId 
		)AS a ORDER BY CONVERT(FLOAT,inspectCompletion) desc
	]]>
	</select>
	<!-- 各公司的设备统计 -->
	<select id="corp_equip_distribution">
	<![CDATA[
		SELECT
			d.DEP_ID,
			d.DEP_NAME,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1) CorpEquipTotalCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.EQUIP_GENERIC='T') CorpTowerCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.STATUS = 0 AND e.EQUIP_GENERIC='T') CorpTowerInuseCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.STATUS = 1 AND e.EQUIP_GENERIC='T') CorpTowerIdleCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.EQUIP_GENERIC='S') CorpLiftCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.STATUS = 0 AND e.EQUIP_GENERIC='S') CorpLiftInuseCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.STATUS = 1 AND e.EQUIP_GENERIC='S') CorpLiftIdleCount
		FROM
			DEPARTMENT d 
		WHERE
			d.DEP_NAME like '%分公司%' AND d.DELFLAG = 1 AND d.DEP_ID NOT IN (92,95,109)
	]]>
	</select>
		<!--看板本月巡检管理表格 -->
	<select id="current_month_inspect_table">
	<![CDATA[
		WITH QUERY1 AS (
			SELECT 
			DEP_ID,
			DEP_NAME,
			COUNT(*) AS 'currentMonthInstallCount'
			FROM (
				SELECT PD.DEP_ID,PD.DEP_NAME,E.EQUIP_SERIAL,E.EQUIP_ID,EF.EMPLOY_INSPECT_SCHEMA_ID FROM T_EQUIPMENT_INSTALL EI
					LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID=EF.FLOW_ID
					LEFT JOIN T_EQUIPMENT E ON EF.EQUIP_ID=E.EQUIP_ID
					LEFT JOIN DEPARTMENT D ON D.DEP_ID=E.DEP_ID
					LEFT JOIN DEPARTMENT PD ON D.PARENT_ID=PD.DEP_ID
					WHERE EI.DEL_FLAG=1 AND EI.STARTIN_DATE >= DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0) 
					AND EI.STARTIN_DATE < DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0)
					AND D.DEP_LEVEL=4 
					GROUP BY PD.DEP_ID,PD.DEP_NAME,E.EQUIP_SERIAL,E.EQUIP_ID,EF.EMPLOY_INSPECT_SCHEMA_ID
				
				UNION ALL
				SELECT D.DEP_ID,D.DEP_NAME,E.EQUIP_SERIAL,E.EQUIP_ID,EF.EMPLOY_INSPECT_SCHEMA_ID FROM T_EQUIPMENT_INSTALL EI
					LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID=EF.FLOW_ID
					LEFT JOIN T_EQUIPMENT E ON EF.EQUIP_ID=E.EQUIP_ID
					LEFT JOIN DEPARTMENT D ON D.DEP_ID=E.DEP_ID
					WHERE EI.DEL_FLAG=1 AND EI.STARTIN_DATE >= DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0) 
					AND EI.STARTIN_DATE < DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0)
					AND D.DEP_LEVEL=3
					GROUP BY D.DEP_ID,D.DEP_NAME,E.EQUIP_SERIAL,E.EQUIP_ID,EF.EMPLOY_INSPECT_SCHEMA_ID
			) T GROUP BY DEP_ID,DEP_NAME
		), QUERY2 AS (
			SELECT 
			DEP_ID,
			DEP_NAME,
			COUNT(*) AS 'depAbnormalCount'
			FROM (
				SELECT PD.DEP_ID,PD.DEP_NAME,E.EQUIP_ID,EI.* FROM T_EQUIPMENT_INSPECT EI 
				LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EI.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
				LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = EIS.FLOW_ID
				LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EF.EQUIP_ID
				LEFT JOIN DEPARTMENT D ON D.DEP_ID=E.DEP_ID
				LEFT JOIN DEPARTMENT PD ON D.PARENT_ID=PD.DEP_ID
				WHERE EI.INSPECT_DATE >= DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0) 
				AND EI.INSPECT_DATE < DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0) 
				AND (EI.RECTIFICATION ='1' OR CHARINDEX(EI.INSPECT_RESULT,'012')>0) 
				AND D.DEP_LEVEL=4 
				
				UNION ALL 
				SELECT D.DEP_ID,D.DEP_NAME,E.EQUIP_ID,EI.* FROM T_EQUIPMENT_INSPECT EI 
				LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EI.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
				LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = EIS.FLOW_ID
				LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EF.EQUIP_ID
				LEFT JOIN DEPARTMENT D ON D.DEP_ID=E.DEP_ID
				WHERE EI.INSPECT_DATE >= DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0) 
				AND EI.INSPECT_DATE < DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0) 
				AND (EI.RECTIFICATION ='1' OR CHARINDEX(EI.INSPECT_RESULT,'012')>0) 
				AND D.DEP_LEVEL=3 
			) T GROUP BY DEP_ID, DEP_NAME
		), QUERY3 AS (
			SELECT 
			DEP_ID,
			DEP_NAME,
			SUM(CASE WHEN T.CREATE_TIMES<>0 AND T.CREATE_TIMES=T.INSPECT_TIMES THEN 1 ELSE 0 END) AS 'finishedCount'
			FROM (
				SELECT PD.DEP_ID,PD.DEP_NAME,P.CREATE_TIMES,EIS.INSPECT_TIMES
				FROM T_EQUIPMENT_INSPECT_SCHEMA EIS INNER JOIN
				(
					SELECT COUNT(S.INSPECT_SCHEMA_ID) AS 'CREATE_TIMES',T.INSPECT_SCHEMA_ID 
					FROM T_EQUIPMENT_INSPECT_SCHEMA T 
					LEFT JOIN T_EQUIPMENT_INSPECT S ON S.INSPECT_SCHEMA_ID = T.INSPECT_SCHEMA_ID 
					WHERE T.DEL_FLAG=1 AND T.CYCLE_ACTIVATE_DATE >= DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0)  --当月第一天
					AND T.CYCLE_ACTIVATE_DATE < DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0)	--下月第一天
					GROUP BY T.INSPECT_SCHEMA_ID 
				) P ON EIS.INSPECT_SCHEMA_ID=P.INSPECT_SCHEMA_ID
				LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = EIS.FLOW_ID
				LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EF.EQUIP_ID
				LEFT JOIN DEPARTMENT D ON D.DEP_ID=E.DEP_ID
				LEFT JOIN DEPARTMENT PD ON D.PARENT_ID=PD.DEP_ID
				WHERE D.DEP_LEVEL=4 
						
				UNION ALL
				SELECT D.DEP_ID,D.DEP_NAME,P.CREATE_TIMES,EIS.INSPECT_TIMES
				FROM T_EQUIPMENT_INSPECT_SCHEMA EIS INNER JOIN
				(
					SELECT COUNT(S.INSPECT_SCHEMA_ID) AS 'CREATE_TIMES',T.INSPECT_SCHEMA_ID 
					FROM T_EQUIPMENT_INSPECT_SCHEMA T 
					LEFT JOIN T_EQUIPMENT_INSPECT S ON S.INSPECT_SCHEMA_ID = T.INSPECT_SCHEMA_ID 
					WHERE T.DEL_FLAG=1 AND T.CYCLE_ACTIVATE_DATE >= DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0)  --当月第一天
					AND T.CYCLE_ACTIVATE_DATE < DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0)	--下月第一天
					GROUP BY T.INSPECT_SCHEMA_ID 
				) P ON EIS.INSPECT_SCHEMA_ID=P.INSPECT_SCHEMA_ID
				LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = EIS.FLOW_ID
				LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EF.EQUIP_ID
				LEFT JOIN DEPARTMENT D ON D.DEP_ID=E.DEP_ID
				WHERE D.DEP_LEVEL=3
				) T GROUP BY DEP_ID,DEP_NAME
		),QUERY4 AS (
			SELECT 
			DEP_ID,
			DEP_NAME,
			COUNT(*) AS 'currentMonthInspectCount'
			FROM (
				SELECT PD.DEP_ID,PD.DEP_NAME,EIS.INSPECT_SCHEMA_ID
				FROM T_EQUIPMENT_INSPECT_SCHEMA EIS 
				LEFT JOIN T_EQUIPMENT_FLOW EF ON EIS.FLOW_ID=EF.FLOW_ID
				LEFT JOIN T_EQUIPMENT E ON EF.EQUIP_ID=E.EQUIP_ID
				LEFT JOIN DEPARTMENT D ON D.DEP_ID=E.DEP_ID
				LEFT JOIN DEPARTMENT PD ON D.PARENT_ID=PD.DEP_ID
				WHERE EIS.DEL_FLAG=1 AND D.DEP_LEVEL=4 
				AND CYCLE_ACTIVATE_DATE>= DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0) 
				AND CYCLE_ACTIVATE_DATE< DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0)
		
				UNION ALL
				SELECT D.DEP_ID,D.DEP_NAME,EIS.INSPECT_SCHEMA_ID
				FROM T_EQUIPMENT_INSPECT_SCHEMA EIS 
				LEFT JOIN T_EQUIPMENT_FLOW EF ON EIS.FLOW_ID=EF.FLOW_ID
				LEFT JOIN T_EQUIPMENT E ON EF.EQUIP_ID=E.EQUIP_ID
				LEFT JOIN DEPARTMENT D ON D.DEP_ID=E.DEP_ID
				WHERE EIS.DEL_FLAG=1 AND D.DEP_LEVEL=3 
				AND CYCLE_ACTIVATE_DATE>= DATEADD(MM,DATEDIFF(MM,0,GETDATE()),0) 
				AND CYCLE_ACTIVATE_DATE< DATEADD(MM,DATEDIFF(MM,0,GETDATE())+1,0)
			) T GROUP BY DEP_ID,DEP_NAME
		)SELECT 
		D.DEP_ID AS 'depId',
		D.DEP_NAME AS 'depName',
		ISNULL(Q1.currentMonthInstallCount,0) AS 'currentMonthInstallCount',
		ISNULL(Q4.currentMonthInspectCount,0) AS 'currentMonthInspectCount',
		ISNULL(Q3.finishedCount,0) AS 'finishedCount',
		ISNULL(Q2.depAbnormalCount,0) AS 'depAbnormalCount',
		CASE WHEN Q4.currentMonthInspectCount IS NULL THEN 0 ELSE CONVERT(DECIMAL(5,1),100.0*ISNULL(Q3.finishedCount,0)/Q4.currentMonthInspectCount) END AS 'corpInspectCompleted'
		FROM DEPARTMENT D 
		LEFT JOIN QUERY1 Q1 ON D.DEP_ID=Q1.DEP_ID
		LEFT JOIN QUERY2 Q2 ON D.DEP_ID=Q2.DEP_ID
		LEFT JOIN QUERY3 Q3 ON D.DEP_ID=Q3.DEP_ID
		LEFT JOIN QUERY4 Q4 ON D.DEP_ID=Q4.DEP_ID
		WHERE D.DEP_NAME LIKE '%分公司%'
		ORDER BY corpInspectCompleted DESC
	]]>	
	</select>
	
	<select id="corp_equip_list">
	<![CDATA[
		SELECT
			d.PARENT_ID AS DEP_ID,
			(SELECT dt.DEP_NAME FROM DEPARTMENT dt WHERE dt.DEP_ID=d.PARENT_ID) DEP_NAME
		FROM
			T_EQUIPMENT e
			LEFT JOIN DEPARTMENT d ON d.dep_id = e.dep_id
			WHERE  d.DELFLAG=1 AND d.DEP_LEVEL=4 AND e.DEL_FLAG=1 
		GROUP BY
			d.PARENT_ID
	]]>
	</select>
	<!-- 各公司的设备统计 -->
	<select id="corp_equip_distribution2">
	<![CDATA[
		SELECT
			d.PARENT_ID AS DEP_ID,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1) CorpEquipTotalCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.EQUIP_GENERIC='T') CorpTowerCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.STATUS = 0 AND te.EQUIP_GENERIC='T') CorpTowerInuseCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.STATUS = 1 AND te.EQUIP_GENERIC='T') CorpTowerIdleCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.EQUIP_GENERIC='S') CorpLiftCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.STATUS = 0 AND te.EQUIP_GENERIC='S') CorpLiftInuseCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.STATUS = 1 AND te.EQUIP_GENERIC='S') CorpLiftIdleCount
		FROM
			T_EQUIPMENT e
			LEFT JOIN DEPARTMENT d ON d.dep_id = e.dep_id
			WHERE  d.DELFLAG=1 AND d.DEP_LEVEL=4 AND e.DEL_FLAG=1 
		GROUP BY
			d.DEP_ID,d.PARENT_ID
	]]>
	</select>
</mapper>