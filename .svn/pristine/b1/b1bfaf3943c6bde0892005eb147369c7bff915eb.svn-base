<?xml version="1.0" encoding="UTF-8"?>
<mapper namespace="equipdoc">
	<!-- 设备所属部件及使用信息 -->
	<select id="include_compon_diary">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT C.COMPON_ID,
		       C.STATUS,
		       (SELECT CG.VALUE FROM BM_COMPONENT_GENERIC CG WHERE CG.CODE = C.COMPON_GENERIC) COMPON_GENERIC,
		       (SELECT CG.VALUE FROM BM_COMPONENT_SPECIFIC CG WHERE CG.CODE = C.COMPON_SPECIFIC) COMPON_SPECIFIC,
		       CONVERT(VARCHAR(10), C.PURCHASE_DATE, 23) PURCHASE_DATE,
		       CONVERT(VARCHAR(10), CD.START_DATE, 23) START_DATE,
		       CONVERT(VARCHAR(10), CD.END_DATE, 23) END_DATE,
		       CD.PROJECT_NAME,
		       CD.ADDRESS
		  FROM T_COMPONENT C
		  LEFT JOIN T_COMPONENT_DIARY CD ON CD.COMPON_ID = C.COMPON_ID
		 WHERE C.DEL_FLAG = '1'
		   AND C.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 总出租次数 -->
	<select id="rent_out_count">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT COUNT(*) COUNTS
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D
		 WHERE (D.APPLYFOR_STATE = '3' OR D.APPLYFOR_STATE = '5')
		   AND D.DISPATCH_ID = DE.DISPATCH_ID
		   AND DE.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 总收入（元） -->
	<select id="receive_sum">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT ISNULL(SUM(AES.PRESENT_AMOUNT), 0) PRESENT_AMOUNT
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_RECEIVE AR
		 WHERE AR.APPLYFOR_STATE = '3'
		   AND AR.AMOUNT_RECEIVE_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_RECEIVE'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 总支出（元） -->
	<select id="payment_sum">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT ISNULL(SUM(AES.PRESENT_AMOUNT), 0) PRESENT_AMOUNT
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_PAYMENT AP
		 WHERE AP.APPLYFOR_STATE = '3'
		   AND AP.AMOUNT_PAYMENT_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_PAYMENT'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 总出租率 -->
	<select id="occupancy_rate">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CAST(CAST(ISNULL(SUM(DATEDIFF(DAY, ED.START_DATE, (CASE WHEN ED.END_DATE > GETDATE() THEN GETDATE() ELSE ED.END_DATE END))), 0) AS FLOAT) /
		       CAST(ISNULL((SELECT (DATEDIFF(DAY, E.PURCHASE_DATE, GETDATE())) FROM T_EQUIPMENT E WHERE E.EQUIP_ID = @EQUIP_ID), 1) AS FLOAT) * 100 AS DEC(5, 2)) OCCUPANCY_RATE
		  FROM T_EQUIPMENT_DIARY ED
		 WHERE ED.ACTIVE = '1'
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 最近调配记录(当前、上一次) -->
	<select id="top2_diary">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT TOP 2 P.PROJECT_NAME,
		       P.ADDRESS,
		       ED.ACTIVATE_DATE,
		       P.UN_CUSTOM_NAME,
		       DE.WORK_STATUS
		  FROM T_DISPATCH_EQUIP DE, T_EQUIPMENT_DIARY ED LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID
		 WHERE ED.ACTIVE = '1'
		   AND ED.EQUIP_ID = @EQUIP_ID
		   AND ED.PROJECT_ID > 0
		   AND DE.DISPATCH_EQUIP_ID = ED.BUSINESS_EQUIP_ID
		 ORDER BY ED.START_DATE DESC
	]]>
	</select>
	<!-- 租赁合同 -->
	<select id="contract">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CL.APPLYFOR_STATE,
		       CL.CONTRACT_SERIAL,
		       CL.PB_ENT_NAME,
		       CL.PROJECT_NAME,
		       CL.SIGNING_TIME,
		       CL.CONTRACT_AMOUNT,
		       CL.SALESMAN
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D, T_CONTRACT_LEASE CL
		 WHERE DE.DISPATCH_ID = D.DISPATCH_ID
		   AND DE.EQUIP_ID = @EQUIP_ID
		   AND (D.APPLYFOR_STATE = '3' OR D.APPLYFOR_STATE = '5')
		   AND D.RELATE_ID = CL.CONTRACT_ID
		   AND D.RELATE_MODULE = 'CONTRACT_LEASE'
	]]>
	</select>
	<!-- 租赁合同-资料打印 -->
	<select id="contractByPE">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		DECLARE @PROJECT_ID BIGINT
		SET @EQUIP_ID = ?
		SET @PROJECT_ID = ?
		SELECT * FROM T_CONTRACT_EQUIP CE
		LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = CE.CONTRACT_ID
		WHERE CE.EQUIP_ID = @EQUIP_ID
		AND CL.PROJECT_ID = @PROJECT_ID
	]]>
	</select>
	<!-- 结算信息 -->
	<select id="settle">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT SC.FUND_STATUS,
		       SC.SETTLE_SERIAL,
		       SC.START_SETTLE_DATE,
		       SC.END_SETTLE_DATE,
		       SC.SETTLE_AMOUNT,
		       SC.PROJECT_NAME,
		       SC.PA_ENT_NAME
		  FROM T_SETTLE_EQUIP_BRIEF SEB, T_SETTLE_CONTRACT SC
		 WHERE SEB.EQUIP_ID = @EQUIP_ID
		   AND SEB.SETTLE_ID = SC.SETTLE_ID
		   AND SC.EFFECTIVE = '1'
	]]>
	</select>
	<!-- 调度信息 -->
	<select id="dispatch">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT D.APPLYFOR_STATE,
		       D.PROJECT_NAME,
		       D.ADDRESS,
		       CONVERT(VARCHAR(10), DE.START_DATE, 23) START_DATE,
		       D.PROJECT_MANAGER
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D
		 WHERE DE.EQUIP_ID = @EQUIP_ID
		   AND DE.DISPATCH_ID = D.DISPATCH_ID
		   AND (D.APPLYFOR_STATE = '3' OR D.APPLYFOR_STATE = '5')
	]]>
	</select>
	<!-- 安装启用 -->
	<select id="install">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CONVERT(VARCHAR(10), EI.STARTIN_DATE, 23) STARTIN_DATE,
		       CONVERT(VARCHAR(10), EI.ENDIN_DATE, 23) ENDIN_DATE,
		       EA.ACTIVATE_DATE,
		       ED.PROJECT_NAME,
		       EI.INSTALL_HEIGHT,
		       EI.PRINCIPAL
		  FROM T_EQUIPMENT_INSTALL EI, T_EQUIPMENT_DIARY ED LEFT JOIN T_EQUIPMENT_ACTIVATE EA ON EA.FLOW_ID = ED.FLOW_ID
		 WHERE ED.FLOW_ID = EI.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
		   AND (EI.APPLYFOR_STATE = '3' OR EI.APPLYFOR_STATE = '4')
	]]>
	</select>
	<!-- 顶升加节 -->
	<select id="jj">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CD.COMPON_GENERIC,
		CD.COUNTS,
		CD.PROJECT_NAME,
		CD.JJUSERNAME,
		CD.START_DATE
		FROM T_COMPONENT_DIARY CD
		WHERE CD.JJSTAUTS = '2'
	]]>
	</select>
	<!-- 检测信息 -->
	<select id="detect">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EDE.DETECT_SERIAL,
		       EDE.DETECT_ENT_NAME,
		       EDE.DETECT_DATE,
		       ED.PROJECT_NAME,
		       EDE.DETECT_RESULT
		  FROM T_EQUIPMENT_DETECT EDE, T_EQUIPMENT_DIARY ED
		 WHERE EDE.DEL_FLAG = '1'
		   AND ED.FLOW_ID = EDE.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 验收信息 -->
	<select id="verify">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EV.VERIFY_SERIAL,
		       EV.EM_ENT_NAME,
		       EV.VERIFY_RESULT,
		       ED.PROJECT_NAME,
		       ED.ADDRESS
		  FROM T_EQUIPMENT_VERIFY EV, T_EQUIPMENT_DIARY ED
		 WHERE EV.DEL_FLAG = '1'
		   AND ED.FLOW_ID = EV.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 使用信息 -->
	<select id="employ">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CONVERT(VARCHAR(10), EE.EMPLOY_DATE, 23) EMPLOY_DATE,
			   CONVERT(VARCHAR(10), EE.END_PLAN_DATE, 23) END_PLAN_DATE,
		       P.UN_CUSTOM_NAME,
		       ED.PROJECT_NAME,
		       ED.ADDRESS
		  FROM T_EQUIPMENT_EMPLOY EE, T_EQUIPMENT_DIARY ED LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID
		 WHERE (EE.APPLYFOR_STATE = '3' OR EE.APPLYFOR_STATE = '4')
		   AND ED.FLOW_ID = EE.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 巡检信息 -->
	<select id="inspect">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EI.INSPECT_SERIAL,
		       CONVERT(VARCHAR(10), EI.INSPECT_DATE, 23) INSPECT_DATE,
		       EI.INSPECT_PEPOLES,
		       (SELECT IR.VALUE FROM BM_INSPECT_RESULT IR WHERE IR.CODE = EI.INSPECT_RESULT) INSPECT_RESULT,
		       ED.PROJECT_NAME
		  FROM T_EQUIPMENT_INSPECT EI, T_EQUIPMENT_INSPECT_SCHEMA EIS, T_EQUIPMENT_DIARY ED
		 WHERE EI.INSPECT_SCHEMA_ID = EIS.INSPECT_SCHEMA_ID
		   AND EIS.FLOW_ID = ED.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 维保记录 -->
	<select id="maint">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EM.MAINT_SERIAL,
		       CONVERT(VARCHAR(10), EM.MAINT_DATE, 23) MAINT_DATE,
		       EM.MAINT_PEPOLES,
		       (SELECT MT.VALUE FROM BM_MAINT_TYPE MT WHERE MT.CODE = EMS.MAINT_TYPE) MAINT_TYPE,
		       CONVERT(VARCHAR(10), EM.THIS_END_CYCLE_DATE, 23) THIS_END_CYCLE_DATE,
		       (SELECT IR.VALUE FROM BM_INSPECT_RESULT IR WHERE IR.CODE = EM.MAINT_RESULT) MAINT_RESULT
		  FROM T_EQUIPMENT_MAINT EM, T_EQUIPMENT_MAINT_SCHEMA EMS, T_EQUIPMENT_DIARY ED
		 WHERE EM.MAINT_SCHEMA_ID = EMS.MAINT_SCHEMA_ID
		   AND EMS.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
		   AND EM.STATUS > '0'
	]]>
	</select>
	<!-- 拆卸信息 -->
	<select id="dismantle">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CONVERT(VARCHAR(10), DIS.STARTDIS_DATE, 23) STARTDIS_DATE,
			   CONVERT(VARCHAR(10), DIS.ENDDIS_DATE, 23) ENDDIS_DATE,
		       DBO.F_MERGE_DISMANTLE_PRACTI(DIS.DISMANTLE_ID, 'EQUIP_DISMANTLE') PRACTI_NAMES,
		       ED.PROJECT_NAME,
		       DIS.DISMANTLE_HEIGHT,
		       DIS.PRINCIPAL
		  FROM T_EQUIPMENT_DISMANTLE DIS, T_EQUIPMENT_DIARY ED
		 WHERE (DIS.APPLYFOR_STATE = '3' OR DIS.APPLYFOR_STATE = '4')
		   AND DIS.FLOW_ID = ED.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 保险信息 -->
	<select id="insure">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT IE.INSURANCE_COMPANY,
		       IE.START_INSURE_DATE,
		       IE.END_INSURE_DATE,
		       IE.INSURE_SERIAL,
		       IE.PREMIUM,
		       (SELECT SUM(IC.COMPENSATE_AMOUNT) FROM T_INSURE_CLAIM IC WHERE IC.INSURE_ID = IE.INSURE_ID) COMPENSATE_AMOUNT
		  FROM T_INSURE_EQUIPMENT IE 
		 WHERE IE.DEL_FLAG = '1'
		   AND IE.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 收款明细 -->
	<select id="receive">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT AR.AMOUNT_SERIAL,
		       AR.PAYMENT_NAME,
		       AR.RECEIVE_DATE,
		       AR.RECEIVE_AMOUNT,
		       AR.RECEIVE_STATUS
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_RECEIVE AR
		 WHERE AR.APPLYFOR_STATE = '3'
		   AND AR.AMOUNT_RECEIVE_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_RECEIVE'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- 支出明细 -->
	<select id="payment">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT AP.RELATE_THEME,
		       AP.RECEIVE_NAME,
		       AP.PAYMENT_DATE,
		       AP.PAYMENT_AMOUNT,
		       AP.PAYMENT_STATUS
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_PAYMENT AP
		 WHERE AP.APPLYFOR_STATE = '3'
		   AND AP.AMOUNT_PAYMENT_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_PAYMENT'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
	</select>
	<!-- ==============================================设备分布==================================== -->
	<!-- 设备省份分布 -->
	<select id="province_map_info">
        <![CDATA[
		SELECT '0' AREA_TYPE, A.CODE AREA_ID, A.VALUE AREA_NAME, A.LONGITUDE, A.LATITUDE, CAST(A.COUNTS AS VARCHAR) + ' 台' STAT_COUNTS
		  FROM (SELECT B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE, COUNT(B.VALUE) COUNTS
		          FROM T_EQUIPMENT       E,
		               T_EQUIPMENT_DIARY ED,
		               T_PROJECT         P,
		               BM_PROVINCE       B
		         WHERE E.FLOW_ID = ED.FLOW_ID
		           AND ED.PROJECT_ID = P.PROJECT_ID
		           AND P.PROVINCE = B.CODE
		           AND P.DEL_FLAG=1
		         GROUP BY B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE) A
		  WHERE 1 = 1
	]]>
	</select>
	<!-- 设备城市分布 -->
	<select id="city_map_info">
        <![CDATA[
		SELECT '1' AREA_TYPE, A.CODE AREA_ID, A.VALUE AREA_NAME, A.LONGITUDE, A.LATITUDE, CAST(A.COUNTS AS VARCHAR) + ' 台' STAT_COUNTS
		  FROM (SELECT P.PROVINCE, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE, COUNT(B.VALUE) COUNTS
		          FROM T_EQUIPMENT       E,
		               T_EQUIPMENT_DIARY ED,
		               T_PROJECT         P,
		               BM_CITY           B
		         WHERE E.FLOW_ID = ED.FLOW_ID
		           AND ED.PROJECT_ID = P.PROJECT_ID
		           AND P.CITY = B.CODE
		           AND P.DEL_FLAG=1
		         GROUP BY P.PROVINCE, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE) A
		  WHERE 1 = 1
	]]>
	</select>
	<!-- 设备区县分布 -->
	<select id="country_map_info">
        <![CDATA[
		SELECT '2' AREA_TYPE, A.CODE AREA_ID, A.VALUE AREA_NAME, A.LONGITUDE, A.LATITUDE, CAST(A.COUNTS AS VARCHAR) + ' 台' STAT_COUNTS
		  FROM (SELECT P.PROVINCE, P.CITY, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE, COUNT(B.VALUE) COUNTS
		          FROM T_EQUIPMENT       E,
		               T_EQUIPMENT_DIARY ED,
		               T_PROJECT         P,
		               BM_COUNTY         B
		         WHERE E.FLOW_ID = ED.FLOW_ID
		           AND ED.PROJECT_ID = P.PROJECT_ID
		           AND P.COUNTY = B.CODE
		           AND P.DEL_FLAG=1
		         GROUP BY P.PROVINCE, P.CITY, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE) A
		  WHERE 1 = 1
	]]>
	</select>
	<select id="settleEquipByPE">
        <![CDATA[
            SELECT * FROM T_SETTLE_EQUIP_BRIEF SE
            LEFT JOIN T_SETTLE_CONTRACT SC ON SC.SETTLE_ID = SE.SETTLE_ID
            WHERE SE.EQUIP_ID = ?
            AND SC.PROJECT_ID = ?
        ]]>
	</select>
	<select id="indisSchemaByPE">
        <![CDATA[
            SELECT * FROM T_INDIS_SCHEMA S
            WHERE S.EQUIP_ID = ?
            AND S.PROJECT_ID = ?
            AND S.RELATE_MODULE = 'EQUIP_INSTALL'
        ]]>
	</select>

	<!-- 设备分布情况看板 -->
	>
	<select id="equip_distribution">
	<![CDATA[
		DECLARE @province VARCHAR(2)
		SET @province=?
		SELECT 
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 WHERE e.DEL_FLAG = 1 AND 
			e.BUSINESS_STATUS!='B' AND p.CITY=bc.code) counts,
			bc.CODE code,
	 		bc.[VALUE] value,
	 		bc.LONGITUDE longitude, 
			bc.LATITUDE latitude,
	 		(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.STATUS =0  AND e.DEL_FLAG = 1 AND e.BUSINESS_STATUS!='B') inuseCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e  WHERE e.STATUS =1  AND e.DEL_FLAG = 1 AND e.BUSINESS_STATUS!='B') idleCount,
			round(cast(isnull(cast((SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 WHERE e.STATUS =0  AND e.DEL_FLAG = 1 AND e.BUSINESS_STATUS!='B')*1.0/
				nullif((SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEL_FLAG = 1 AND te.BUSINESS_STATUS!='B'),0) as decimal(10,2)),0)*100 as int),2) inuseRate,
			round(cast(isnull(cast((SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1  WHERE e.STATUS =1  AND e.DEL_FLAG = 1 AND e.BUSINESS_STATUS!='B' )*1.0/
				nullif((SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEL_FLAG = 1 AND te.BUSINESS_STATUS!='B'),0) as decimal(10,2)),0)*100 as int),2) idleRate,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 WHERE  p.CITY = bc.CODE AND e.EQUIP_GENERIC='T' AND e.DEL_FLAG = 1 AND e.BUSINESS_STATUS!='B') towerCityCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='T' AND e.DEL_FLAG = 1 AND e.STATUS =0 AND e.BUSINESS_STATUS!='B') towerCityInuseCount,	
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='T' AND e.DEL_FLAG = 1 AND e.STATUS =1 AND e.BUSINESS_STATUS!='B') towerCityIdleCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='S' AND e.DEL_FLAG = 1 AND e.BUSINESS_STATUS!='B') liftCityCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='S' AND e.DEL_FLAG = 1 AND e.STATUS =0 AND e.BUSINESS_STATUS!='B') liftCityInuseCount,	
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.FLOW_ID= E.FLOW_ID LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID AND P.DEL_FLAG= 1 
				WHERE  P.CITY = bc.CODE AND e.EQUIP_GENERIC='S' AND e.DEL_FLAG = 1 AND e.STATUS =1 AND e.BUSINESS_STATUS!='B') liftCityIdleCount,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='T' AND tt.DEL_FLAG = 1 AND tt.BUSINESS_STATUS!='B') towerTotalCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='T' AND tt.DEL_FLAG = 1 AND tt.STATUS =0 AND tt.BUSINESS_STATUS!='B') towerInuseCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='T' AND tt.DEL_FLAG = 1 AND tt.STATUS =1 AND tt.BUSINESS_STATUS!='B') towerIdleCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='S' AND tt.DEL_FLAG = 1 AND tt.BUSINESS_STATUS!='B') liftTotalCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='S' AND tt.DEL_FLAG = 1 AND tt.STATUS =0 AND tt.BUSINESS_STATUS!='B') liftInuseCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.EQUIP_GENERIC='S' AND tt.DEL_FLAG = 1 AND tt.STATUS =1 AND tt.BUSINESS_STATUS!='B') liftIdleCounts,
			(SELECT COUNT(tt.EQUIP_ID) FROM T_EQUIPMENT tt WHERE tt.DEL_FLAG = 1 AND tt.BUSINESS_STATUS!='B') totalCounts,
			(SELECT COUNT(p.PROJECT_ID) FROM T_PROJECT p WHERE p.CITY = bc.CODE AND p.DEL_FLAG=1) cityProjectCount
		FROM 
			BM_CITY bc 
		 WHERE 
		     bc.CODE LIKE @province+'%'
	]]>
	</select>

	<!-- 设备看板（巡检预警提醒） -->
	<select id="equip_inspect_warning">
	<![CDATA[
		SELECT (SELECT COUNT(*) FROM T_EQUIPMENT_INSPECT WHERE STATUS = 2) AS overdueNotInspect,
		round(cast(isnull(cast((SELECT COUNT(*) 
								FROM T_EQUIPMENT_INSPECT 
								WHERE STATUS = 1 OR STATUS = 3)*1.0/
					NULLIF((SELECT COUNT(*) 
							FROM T_EQUIPMENT_INSPECT ),0) as decimal(10,2)),0)*100 as int),2) AS inspectCompleted,
		(SELECT COUNT(*) FROM 
				(SELECT e.EQUIP_ID AS i FROM T_EQUIPMENT e 
					WHERE e.EQUIP_ID IN (
						SELECT ef.EQUIP_ID FROM T_EQUIPMENT_FLOW ef 
						LEFT JOIN T_EQUIPMENT_INSTALL ei ON ei.INSTALL_ID = ef.INSTALL_ID AND ei.APPLYFOR_STATE = 3  
						WHERE ei.DEL_FLAG = 1) 
					AND e.DEL_FLAG=1) j 
		WHERE j.i NOT IN ( SELECT efw.EQUIP_ID FROM T_EQUIPMENT_FLOW efw LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.FLOW_ID = efw.FLOW_ID ))AS installNotPlan,
		round(cast(isnull(cast(
						(SELECT COUNT(e.EQUIP_ID) 
							FROM T_EQUIPMENT e 
							WHERE e.EQUIP_ID IN (SELECT ef.EQUIP_ID FROM T_EQUIPMENT_FLOW ef 
													LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eis ON eis.FLOW_ID = ef.FLOW_ID) 
							AND e.DEL_FLAG=1)*1.0/
				NULLIF((SELECT COUNT(*) 
						FROM T_EQUIPMENT e 
						LEFT JOIN T_EQUIPMENT_FLOW ef ON ef.EQUIP_ID=e.EQUIP_ID 
						LEFT JOIN T_EQUIPMENT_INSTALL tei ON tei.FLOW_ID=ef.FLOW_ID
						WHERE e.DEL_FLAG=1 AND tei.DEL_FLAG=1),0) as decimal(10,2)),0)*100 as int),2) AS inspectPlanRate,
		(SELECT COUNT(*) AS a FROM T_APP_REPAIR WHERE STATE = 1) AS maintNotManage,
		(CONVERT(decimal(18, 1),(SELECT COUNT(*) FROM T_APP_REPAIR apr WHERE apr.STATE = 0 OR apr.STATE = 4) * 1.0 / 
		nullif((SELECT COUNT(*) FROM T_APP_REPAIR apr),0)) * 100) AS maintCompleted
	]]>
	</select>

	<!-- 设备看板（本周巡检排行） -->
	<select id="equip_inspect_week_ranking">
	<![CDATA[
		DECLARE @START INT
		DECLARE @PAGE_SIZE INT
		SET @START = ?
		SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT _a.DEP_ID depId,
			_a.DEP_NAME depName,
			ROW_NUMBER() OVER (ORDER BY _a.corpInspectCompleted DESC) AS _ROWNUM,
			_a.corpInspectCompleted,
			_a.corpInspectPlan,
			_a.corpMaintCompleted 
		FROM (
			SELECT
				ci.DEP_ID,
				ci.DEP_NAME,
				(CONVERT(decimal(18, 2),(
						SELECT COUNT(e.EQUIP_ID) 
						FROM T_EQUIPMENT e 
						WHERE  e.EQUIP_ID IN (SELECT ef.EQUIP_ID FROM T_EQUIPMENT_FLOW ef 
													LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eis ON eis.FLOW_ID = ef.FLOW_ID
													WHERE DATEDIFF(week,eis.CYCLE_ACTIVATE_DATE,GETDATE())=0) 
															AND e.DEP_ID = ci.DEP_ID 
							AND e.DEL_FLAG = 1) * 1.0 / 
				NULLIF((SELECT COUNT(*) FROM T_EQUIPMENT e 
							LEFT JOIN T_EQUIPMENT_FLOW ef ON ef.EQUIP_ID=e.EQUIP_ID 
							LEFT JOIN T_EQUIPMENT_INSTALL tei ON tei.FLOW_ID=ef.FLOW_ID
							WHERE e.DEP_ID = ci.DEP_ID 
									AND tei.APPLYFOR_STATE = 3
									AND e.DEL_FLAG = 1 
									AND	tei.DEL_FLAG = 1 AND DATEDIFF(week,tei.ENDIN_DATE,GETDATE())=0),0)
				)* 100 ) corpInspectPlan,
				(CONVERT(decimal(18, 2),(
						SELECT COUNT(ei.INSPECT_ID) 
							FROM T_EQUIPMENT_INSPECT ei 
							LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID 
							LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_DIARY_ID = eic.EQUIP_DIARY_ID 
							LEFT JOIN T_EQUIPMENT e ON e.EQUIP_ID=ed.EQUIP_ID
							WHERE e.DEP_ID = ci.DEP_ID 
								AND (ei.STATUS = 1 
								OR ei.STATUS = 3)
								AND DATEDIFF(week,ei.INSPECT_DATE,GETDATE())=0
								AND e.DEL_FLAG = 1) * 1.0 / 
						nullif((SELECT COUNT(ei.INSPECT_ID) FROM T_EQUIPMENT_INSPECT ei 
									LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID 
									LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_DIARY_ID = eic.EQUIP_DIARY_ID 
									LEFT JOIN T_EQUIPMENT e ON e.EQUIP_ID=ed.EQUIP_ID
									WHERE e.DEP_ID = ci.DEP_ID 
												AND DATEDIFF(week,ei.INSPECT_DATE,GETDATE())=0
												AND e.DEL_FLAG = 1),0)) * 100 
				) AS corpInspectCompleted,
				(CONVERT(decimal(18, 1),(
								SELECT count(apr.REPID) FROM T_APP_REPAIR apr 
									LEFT JOIN T_EQUIPMENT e ON apr.EQUIP_ID = e.EQUIP_ID 
									WHERE apr.STATE=4 
										AND e.DEP_ID = ci.DEP_ID 
										AND DATEDIFF(week,apr.REPORT_DT,GETDATE())=0
										AND e.DEL_FLAG = 1) * 1.0 / 
						nullif((SELECT count(apr.REPID) FROM T_APP_REPAIR apr 
									LEFT JOIN T_EQUIPMENT e ON apr.EQUIP_ID = e.EQUIP_ID 
									WHERE  DATEDIFF(week,apr.REPORT_DT,GETDATE())=0
										AND e.DEL_FLAG = 1),0)) * 100) AS corpMaintCompleted
			FROM
					DEPARTMENT ci
			WHERE ci.DEP_ID IN(90,91,93,94,110) AND ci.DELFLAG=1	
			)  _a
		)
		SELECT * FROM QUERY q WHERE _ROWNUM >@START AND _ROWNUM <= (@START +  @PAGE_SIZE)  ORDER BY q.corpInspectCompleted DESC
	]]>
	</select>

	<!-- 设备看板（本月巡检排行） -->
	<select id="equip_inspect_month_ranking">
	<![CDATA[
		WITH QUERY AS (
		SELECT _a.DEP_ID depId,
			_a.DEP_NAME depName,
			ROW_NUMBER() OVER (ORDER BY _a.corpInspectCompleted DESC) AS _ROWNUM,
			_a.corpInspectCompleted,
			_a.corpInspectPlan,
			_a.corpMaintCompleted 
		FROM (
			SELECT
				ci.DEP_ID,
				ci.DEP_NAME,
				(CONVERT(decimal(18, 2),(
						SELECT COUNT(e.EQUIP_ID) 
						FROM T_EQUIPMENT e 
						WHERE  e.EQUIP_ID  IN (SELECT ef.EQUIP_ID FROM T_EQUIPMENT_FLOW ef 
													LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eis ON eis.FLOW_ID = ef.FLOW_ID
													WHERE DATEDIFF(month,eis.CYCLE_ACTIVATE_DATE,GETDATE())=0) 
															AND e.DEP_ID = ci.DEP_ID 
							AND e.DEL_FLAG = 1) * 1.0 / 
				NULLIF((SELECT COUNT(*) FROM T_EQUIPMENT e 
							LEFT JOIN T_EQUIPMENT_FLOW ef ON ef.EQUIP_ID=e.EQUIP_ID 
							LEFT JOIN T_EQUIPMENT_INSTALL tei ON tei.FLOW_ID=ef.FLOW_ID
							WHERE e.DEP_ID = ci.DEP_ID 
									AND tei.APPLYFOR_STATE = 3
									AND e.DEL_FLAG = 1 
									AND	tei.DEL_FLAG = 1 AND DATEDIFF(month,tei.ENDIN_DATE,GETDATE())=0),0)
				)* 100 ) corpInspectPlan,
				(CONVERT(decimal(18, 2),(
						SELECT COUNT(ei.INSPECT_ID) 
							FROM T_EQUIPMENT_INSPECT ei 
							LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID 
							LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_DIARY_ID = eic.EQUIP_DIARY_ID 
							LEFT JOIN T_EQUIPMENT e ON e.EQUIP_ID=ed.EQUIP_ID
							WHERE e.DEP_ID = ci.DEP_ID 
								AND (ei.STATUS = 1 
								OR ei.STATUS = 3)
								AND DATEDIFF(month,ei.INSPECT_DATE,GETDATE())=0
								AND e.DEL_FLAG = 1) * 1.0 / 
						nullif((SELECT COUNT(ei.INSPECT_ID) FROM T_EQUIPMENT_INSPECT ei 
									LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA eic ON eic.INSPECT_SCHEMA_ID = ei.INSPECT_SCHEMA_ID 
									LEFT JOIN T_EQUIPMENT_DIARY ed ON ed.EQUIP_DIARY_ID = eic.EQUIP_DIARY_ID 
									LEFT JOIN T_EQUIPMENT e ON e.EQUIP_ID=ed.EQUIP_ID
									WHERE e.DEP_ID = ci.DEP_ID 
												AND DATEDIFF(month,ei.INSPECT_DATE,GETDATE())=0
												AND e.DEL_FLAG = 1),0)) * 100 
				) AS corpInspectCompleted,
				(CONVERT(decimal(18, 1),(
								SELECT count(apr.REPID) FROM T_APP_REPAIR apr 
									LEFT JOIN T_EQUIPMENT e ON apr.EQUIP_ID = e.EQUIP_ID 
									WHERE apr.STATE=4 
										AND e.DEP_ID = ci.DEP_ID 
										AND DATEDIFF(month,apr.REPORT_DT,GETDATE())=0
										AND e.DEL_FLAG = 1) * 1.0 / 
						nullif((SELECT count(apr.REPID) FROM T_APP_REPAIR apr 
									LEFT JOIN T_EQUIPMENT e ON apr.EQUIP_ID = e.EQUIP_ID 
									WHERE  DATEDIFF(month,apr.REPORT_DT,GETDATE())=0
										AND e.DEL_FLAG = 1),0)) * 100) AS corpMaintCompleted
			FROM
					DEPARTMENT ci
			WHERE ci.DEP_ID IN(90,91,93,94,110) AND ci.DELFLAG=1
			)  _a
		)
		SELECT 
		depId,
		depName,
		ISNULL(corpInspectCompleted, 0) as 'corpInspectCompleted',
		ISNULL(corpInspectPlan, 0) as 'corpInspectPlan',
		ISNULL(corpMaintCompleted, 0) as 'corpMaintCompleted'		
		FROM QUERY 
	]]>
	</select>

	<!-- 设备看板（本年巡检排行） -->
	<select id="equip_inspect_year_ranking">
	<![CDATA[
		WITH QUERY AS (
			SELECT 
			T.*, 
			EIS.INSPECT_SCHEMA_ID,
			EIS.DEL_FLAG AS 'SCHEMA_DEL_FLAG',
			EIS.ACTIVE AS 'SCHEMA_ACTIVE',
			EIT.INSPECT_SERIAL,
			EIT.STATUS AS 'INSPECT_STATUS',
			EIT.INSPECT_RESULT,
			EIT.INSPECT_DATE
			FROM 
			(
				SELECT DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID,MAX(FLOW_ID) AS 'FLOW_ID'
				FROM (
				SELECT 
					PD.DEP_ID,
					PD.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D,DEPARTMENT PD
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.PARENT_ID=PD.DEP_ID
					AND D.DEP_LEVEL=4 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1
				union all 
		
				SELECT 
					D.DEP_ID,
					D.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.DEP_LEVEL=3 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1) T
				GROUP BY DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID
			) T LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.FLOW_ID=T.FLOW_ID
					LEFT JOIN T_EQUIPMENT_INSPECT EIT ON EIT.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
		) 
		SELECT 
		depId,
		depName,
		ISNULL(currentMonthInspectCount,0) as 'equipCount',
			CASE WHEN T.currentMonthInstallCount IS NULL OR T.currentMonthInstallCount=0 THEN 0 
				ELSE CONVERT(DECIMAL(5,1), 100.0*ISNULL(T.currentMonthInspectCount,0) / T.currentMonthInstallCount) 
					END AS 'inspectCompletion'
			FROM (
				SELECT 
				Q.DEP_ID AS 'depId',
				Q.DEP_NAME AS 'depName',
				COUNT(DISTINCT FLOW_ID) AS 'currentMonthInstallCount',
				(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
					AND DEP_ID=Q.DEP_ID AND DATEDIFF(YEAR, INSPECT_DATE, GETDATE())=0) AS 'currentMonthInspectCount'
				FROM QUERY Q GROUP BY Q.DEP_ID, Q.DEP_NAME
			) T ORDER BY inspectCompletion DESC
	]]>
	</select>
	<!--查询设备的权限归属 -->
	<select id="equip_permission_flag">
		<![CDATA[
		SELECT FULLNAME as fullName FROM APP_USER WHERE CHARINDEX('s'+CONVERT(VARCHAR,USERID)+'e',?)>0
			]]>
	</select>
	<select id="province_list">
	<![CDATA[
		SELECT
			bp.* 
		FROM
			BM_PROVINCE bp
		WHERE 
			bp.CODE IN (SELECT P.PROVINCE FROM T_PROJECT p LEFT JOIN T_EQUIPMENT e ON p.PROJECT_ID = e.PROJECT_ID WHERE p.DEL_FLAG=1 and e.PROJECT_ID is not null)
	]]>
	</select>

	<!--本月巡检管理4个圈 -->
	<select id="current_month_inspect_collect">
	<![CDATA[
		WITH QUERY AS (
			SELECT 
			T.*, 
			EIS.INSPECT_SCHEMA_ID,
			EIS.DEL_FLAG AS 'SCHEMA_DEL_FLAG',
			EIS.ACTIVE AS 'SCHEMA_ACTIVE',
			EIT.INSPECT_SERIAL,
			EIT.STATUS AS 'INSPECT_STATUS',
			EIT.INSPECT_RESULT,
			EIT.INSPECT_DATE
			FROM 
			(
				SELECT DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID,MAX(FLOW_ID) AS 'FLOW_ID'
				FROM (
				SELECT 
					PD.DEP_ID,
					PD.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D,DEPARTMENT PD
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.PARENT_ID=PD.DEP_ID
					AND D.DEP_LEVEL=4 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1
				union all 
		
				SELECT 
					D.DEP_ID,
					D.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.DEP_LEVEL=3 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1) T
				GROUP BY DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID
			) T LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.FLOW_ID=T.FLOW_ID
					LEFT JOIN T_EQUIPMENT_INSPECT EIT ON EIT.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
		) 
		SELECT 
		COUNT(DISTINCT FLOW_ID) AS 'unfinishedCount',
		(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1) AS 'finishedCount',
		(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
			AND DATEDIFF(MONTH, INSPECT_DATE, GETDATE())=0) AS 'normalCount',
		(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
			AND DATEDIFF(MONTH, INSPECT_DATE, GETDATE())=0 AND CHARINDEX(INSPECT_RESULT,'345')>0) AS 'abnormalCount'
		FROM QUERY Q 
	]]>
	</select>

	<!-- 设备看板（本季度巡检排行） -->
	<select id="equip_inspect_quarter_ranking">
	<![CDATA[
		WITH QUERY AS (
			SELECT 
			T.*, 
			EIS.INSPECT_SCHEMA_ID,
			EIS.DEL_FLAG AS 'SCHEMA_DEL_FLAG',
			EIS.ACTIVE AS 'SCHEMA_ACTIVE',
			EIT.INSPECT_SERIAL,
			EIT.STATUS AS 'INSPECT_STATUS',
			EIT.INSPECT_RESULT,
			EIT.INSPECT_DATE
			FROM 
			(
				SELECT DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID,MAX(FLOW_ID) AS 'FLOW_ID'
				FROM (
				SELECT 
					PD.DEP_ID,
					PD.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D,DEPARTMENT PD
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.PARENT_ID=PD.DEP_ID
					AND D.DEP_LEVEL=4 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1
				union all 
		
				SELECT 
					D.DEP_ID,
					D.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.DEP_LEVEL=3 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1) T
				GROUP BY DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID
			) T LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.FLOW_ID=T.FLOW_ID
					LEFT JOIN T_EQUIPMENT_INSPECT EIT ON EIT.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
		) 
		SELECT 
		depId,
		depName,
		ISNULL(currentMonthInspectCount,0) as 'equipCount',
			CASE WHEN T.currentMonthInstallCount IS NULL OR T.currentMonthInstallCount=0 THEN 0 
				ELSE CONVERT(DECIMAL(5,1), 100.0*ISNULL(T.currentMonthInspectCount,0) / T.currentMonthInstallCount) 
					END AS 'inspectCompletion'
			FROM (
				SELECT 
				Q.DEP_ID AS 'depId',
				Q.DEP_NAME AS 'depName',
				COUNT(DISTINCT FLOW_ID) AS 'currentMonthInstallCount',
				(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
					AND DEP_ID=Q.DEP_ID AND DATEDIFF(Quarter, INSPECT_DATE, GETDATE())=0) AS 'currentMonthInspectCount'
				FROM QUERY Q GROUP BY Q.DEP_ID, Q.DEP_NAME
			) T ORDER BY inspectCompletion DESC
	]]>
	</select>
	<!-- 各公司的设备统计 -->
	<select id="corp_equip_distribution">
	<![CDATA[
		SELECT
			d.DEP_ID,
			d.DEP_NAME,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.BUSINESS_STATUS!='B') CorpEquipTotalCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.EQUIP_GENERIC='T' AND e.BUSINESS_STATUS!='B') CorpTowerCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.STATUS = 0 AND e.EQUIP_GENERIC='T' AND e.BUSINESS_STATUS!='B') CorpTowerInuseCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.STATUS = 1 AND e.EQUIP_GENERIC='T' AND e.BUSINESS_STATUS!='B') CorpTowerIdleCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.EQUIP_GENERIC='S' AND e.BUSINESS_STATUS!='B') CorpLiftCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.STATUS = 0 AND e.EQUIP_GENERIC='S' AND e.BUSINESS_STATUS!='B') CorpLiftInuseCount,
			(SELECT COUNT(e.EQUIP_ID) FROM T_EQUIPMENT e WHERE e.DEP_ID = d.DEP_ID AND e.DEL_FLAG=1 AND e.STATUS = 1 AND e.EQUIP_GENERIC='S'AND e.BUSINESS_STATUS!='B') CorpLiftIdleCount
		FROM
			DEPARTMENT d 
		WHERE
			d.DEP_NAME like '%分公司%' AND d.DELFLAG = 1 AND d.DEP_ID NOT IN (92,95,109)
	]]>
	</select>
	<!--看板本月巡检管理表格 -->
	<select id="current_month_inspect_table">
	<![CDATA[
		WITH QUERY AS (
			SELECT 
			T.*, 
			EIS.INSPECT_SCHEMA_ID,
			EIS.DEL_FLAG AS 'SCHEMA_DEL_FLAG',
			EIS.ACTIVE AS 'SCHEMA_ACTIVE',
			EIT.INSPECT_SERIAL,
			EIT.STATUS AS 'INSPECT_STATUS',
			EIT.INSPECT_RESULT,
			EIT.INSPECT_DATE
			FROM 
			(
				SELECT DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID,MAX(FLOW_ID) AS 'FLOW_ID'
				FROM (
				SELECT 
					PD.DEP_ID,
					PD.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D,DEPARTMENT PD
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.PARENT_ID=PD.DEP_ID
					AND D.DEP_LEVEL=4 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1
				union all 
		
				SELECT 
					D.DEP_ID,
					D.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.DEP_LEVEL=3 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1) T
				GROUP BY DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID
			) T LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.FLOW_ID=T.FLOW_ID
					LEFT JOIN T_EQUIPMENT_INSPECT EIT ON EIT.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
		) 
		SELECT *,
			CASE WHEN T.currentMonthInstallCount IS NULL OR T.currentMonthInstallCount=0 THEN 0 
				ELSE CONVERT(DECIMAL(5,1), 100.0*ISNULL(T.currentMonthInspectCount,0) / T.currentMonthInstallCount) 
					END AS 'corpInspectCompleted'
			FROM (
				SELECT 
				Q.DEP_ID AS 'depId',
				Q.DEP_NAME AS 'depName',
				COUNT(DISTINCT FLOW_ID) AS 'currentMonthInstallCount',
				(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 AND DEP_ID=Q.DEP_ID) AS 'finishedCount',
				(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
					AND DEP_ID=Q.DEP_ID AND DATEDIFF(MONTH, INSPECT_DATE, GETDATE())=0) AS 'currentMonthInspectCount',
				(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
					AND DEP_ID=Q.DEP_ID AND DATEDIFF(MONTH, INSPECT_DATE, GETDATE())=0 AND CHARINDEX(INSPECT_RESULT,'345')>0) AS 'depAbnormalCount'
				FROM QUERY Q GROUP BY Q.DEP_ID, Q.DEP_NAME
			) T ORDER BY corpInspectCompleted DESC
	]]>
	</select>

	<select id="corp_equip_list">
	<![CDATA[
		SELECT
			d.PARENT_ID AS DEP_ID,
			(SELECT dt.DEP_NAME FROM DEPARTMENT dt WHERE dt.DEP_ID=d.PARENT_ID) DEP_NAME
		FROM
			T_EQUIPMENT e
			LEFT JOIN DEPARTMENT d ON d.dep_id = e.dep_id
			WHERE  d.DELFLAG=1 AND d.DEP_LEVEL=4 AND e.DEL_FLAG=1 
		GROUP BY
			d.PARENT_ID
	]]>
	</select>
	<!-- 各公司的设备统计 -->
	<select id="corp_equip_distribution2">
	<![CDATA[
		SELECT
			d.PARENT_ID AS DEP_ID,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.BUSINESS_STATUS!='B') CorpEquipTotalCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.EQUIP_GENERIC='T' AND te.BUSINESS_STATUS!='B') CorpTowerCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.STATUS = 0 AND te.EQUIP_GENERIC='T' AND te.BUSINESS_STATUS!='B') CorpTowerInuseCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.STATUS = 1 AND te.EQUIP_GENERIC='T' AND te.BUSINESS_STATUS!='B') CorpTowerIdleCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.EQUIP_GENERIC='S' AND te.BUSINESS_STATUS!='B') CorpLiftCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.STATUS = 0 AND te.EQUIP_GENERIC='S' AND te.BUSINESS_STATUS!='B') CorpLiftInuseCount,
			(SELECT COUNT(te.EQUIP_ID) FROM T_EQUIPMENT te WHERE te.DEP_ID IN (d.DEP_ID) AND te.DEL_FLAG=1 AND te.STATUS = 1 AND te.EQUIP_GENERIC='S' AND te.BUSINESS_STATUS!='B') CorpLiftIdleCount
		FROM
			T_EQUIPMENT e
			LEFT JOIN DEPARTMENT d ON d.dep_id = e.dep_id
			WHERE  d.DELFLAG=1 AND d.DEP_LEVEL=4 AND e.DEL_FLAG=1 
		GROUP BY
			d.DEP_ID,d.PARENT_ID
	]]>
	</select>
	<!-- 设备档案中与设备关联的巡检计划 -->
	<select id="equip_inspect_schema_info">
	<![CDATA[
	    DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EIS.INSPECT_SCHEMA_ID
	    FROM T_EQUIPMENT_INSPECT_SCHEMA EIS
	    WHERE EIS.FLOW_ID IN(
	    SELECT F.FLOW_ID
	    FROM T_EQUIPMENT_FLOW F
	    WHERE F.EQUIP_ID = @EQUIP_ID)
		
	]]>
	</select>
	<!-- 设备档案中与设备关联的巡检管理信息 -->
	<select id="equip_inspect_info">
	<![CDATA[
	    DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EI.INSPECT_ID
	    FROM T_EQUIPMENT_INSPECT EI
	    WHERE EI.INSPECT_SCHEMA_ID IN(SELECT EIS.INSPECT_SCHEMA_ID
	    FROM T_EQUIPMENT_INSPECT_SCHEMA EIS
	    WHERE EIS.FLOW_ID IN(
	    SELECT F.FLOW_ID
	    FROM T_EQUIPMENT_FLOW F
	    WHERE F.EQUIP_ID = @EQUIP_ID)
	)
		
	]]>
	</select>
	<!-- 设备档案中设备相关连的投保信息 -->
	<select id="equip_insureance_record_info">
		<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT T.* 
		FROM (SELECT 
			EI.START_INSURE_DATE AS startInsureDate,
			EI.END_INSURE_DATE AS endInsureDate,
			EI.INSURE_SERIAL AS insureSerial,
			EI.INSURANCE_COMPANY AS insuranceCompany,
			EI.CLAIM_PHONE AS claimPhone,
			EI.LINKMAN AS linkman,
			EI.LINKMAN_PHONE AS linkmanPhone,
			EID.INSURANCE_CATEGORY AS insuranceCategory,
			EID.EQUIP_WORTH AS equipWorth,
			EID.PREMIUM AS premium,
			EID.CONTRACT_ID AS contractId,
			EID.PROJECT_NAME AS projectName,
			EID.EQUIP_ID,
			EI.EFFECTIVE,
			EI.DEL_FLAG,
			EID.REMARK AS remark
		FROM T_EQUIP_INSURANCE_DETAIL EID
		LEFT JOIN T_EQUIP_INSURANCE EI ON EI.INSURE_ID = EID.INSURE_ID 
		LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EID.EQUIP_ID)T
		WHERE T.EQUIP_ID = @EQUIP_ID 
		AND T.EFFECTIVE != '0'
		AND T.DEL_FLAG = '1'
		ORDER BY T.startInsureDate DESC
		]]>
	</select>
		<!-- 设备档案中设备相关连的投保信息中的累计理赔-->
	<select id="equip_insureance_claim_amount">
		<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT SUM(EI.CLAIM_AMOUNT) AS claimAmount FROM T_EQUIP_INSURANCE_CLAIM_RECORD EI WHERE EXISTS (SELECT ED.INSURE_ID FROM 
		T_EQUIP_INSURANCE_DETAIL ED WHERE ED.EQUIP_ID =@EQUIP_ID AND ED.INSURE_ID = EI.INSURE_ID )
		]]>
	</select>
	<!-- 设备档案中设备相关连的理赔信息 -->
	<select id="equip_insureance_claim_info">
		<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?	
        SELECT
	        EICR.CLAIM_ID AS claimId,
	        E.EQUIP_ID AS equipId,
	        EICR.INSURE_ID AS insureId,
			EI.INSURE_SERIAL AS insureSerial,
			EI.INSURANCE_COMPANY AS insuranceCompany,
			EICR.BANK_DEPOSIT AS bankDeposit,
	        EICR.DEPOSIT_ACCOUNT AS depositAccount,
	        EICR.CLAIM_DATE AS claimDate,
	        EICR.COST_AMOUNT AS costAmount,
	        EICR.CLAIM_AMOUNT AS claimAmount,
	        EICR.CLAIM_REASON AS claimReason, 
			EICR.PROJECT_NAME AS projectName,
			E.EQUIP_SERIAL AS equipSerial,
		    ES.VALUE AS equipSpecific,
			EG.VALUE AS equipGeneric,
			E.EXW_SERIAL AS exwSerial,    
	        EID.INSURANCE_CATEGORY AS insuranceCategory,
			SH.STORE_NAME AS storeName
    	FROM T_EQUIP_INSURANCE_CLAIM_RECORD EICR
		LEFT JOIN T_EQUIP_INSURANCE EI ON EI.INSURE_ID = EICR.INSURE_ID
		LEFT JOIN T_EQUIP_INSURANCE_DETAIL EID ON EICR.INSURE_ID = EID.INSURE_ID
		LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EID.EQUIP_ID
		LEFT JOIN T_STORE_HOUSE SH ON E.STORE_ID = SH.STORE_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON EG.CODE = E.EQUIP_GENERIC
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON ES.CODE = E.EQUIP_SPECIFIC
       	WHERE EID.EQUIP_ID = @EQUIP_ID
       	AND EICR.DEL_FLAG = 1
        ORDER BY claimDate  DESC
		]]>
	</select>
	<!-- 设备档案中设备相关连的投保信息 -->
	<select id="equip_insureance_record_detail">
		<![CDATA[
		DECLARE @DETAIL_ID BIGINT
		SET @DETAIL_ID = ?
			SELECT 
			    EID.INSURANCE_CATEGORY AS insuranceCategory, 
			    EI.INSURE_ID AS insuerId,
			    EI.INSURE_SERIAL AS insureSerial,
				EI.LINKMAN AS linkman,
		        SH.STORE_NAME AS storeName,
		        EID.PROJECT_NAME AS projectName,
		        EI.START_INSURE_DATE AS startInsureDate,
				EI.END_INSURE_DATE AS endInsureDate,
				E.EXW_SERIAL AS exwSerial,
				EID.ADDRESS AS address,
				E.EQUIP_SERIAL AS equipSerial,
				EID.EQUIP_WORTH AS equipWorth,
				EI.INSURANCE_COMPANY AS insuranceCompany,
				EI.CLAIM_PHONE AS claimPhone,
				EG.VALUE AS equipGeneric,
				ES.VALUE AS equipSpecific,
				EI.LINKMAN_PHONE AS linkmanPhone,
				EID.PREMIUM AS premium
		FROM T_EQUIP_INSURANCE_DETAIL EID
		LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EID.EQUIP_ID
		LEFT JOIN T_STORE_HOUSE SH ON E.STORE_ID = SH.STORE_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON EG.CODE = E.EQUIP_GENERIC
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON ES.CODE = E.EQUIP_SPECIFIC
		LEFT JOIN T_EQUIP_INSURANCE EI ON EI.INSURE_ID = EID.INSURE_ID
		WHERE EID.DETAIL_ID = @DETAIL_ID
		ORDER BY  EI.INSURE_ID DESC 
		]]>
	</select>
		<!-- 设备档案中设备相关连的投保信息 -->
	<select id="equip_insureance_record_detail_manager">
		<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
			SELECT 
			    TOP 1 EID.INSURANCE_CATEGORY AS insuranceCategory, 
			    EI.INSURE_ID AS insuerId,
			    EI.INSURE_SERIAL AS insureSerial,
				EI.LINKMAN AS linkman,
		        SH.STORE_NAME AS storeName,
		        P.PROJECT_NAME AS projectName,
		        EI.START_INSURE_DATE AS startInsureDate,
				EI.END_INSURE_DATE AS endInsureDate,
				E.EXW_SERIAL AS exwSerial,
				EID.ADDRESS AS address,
				E.EQUIP_SERIAL AS equipSerial,
				EID.EQUIP_WORTH AS equipWorth,
				EI.INSURANCE_COMPANY AS insuranceCompany,
				EI.CLAIM_PHONE AS claimPhone,
				EG.VALUE AS equipGeneric,
				ES.VALUE AS equipSpecific,
				EI.LINKMAN_PHONE AS linkmanPhone,
				EID.PREMIUM AS premium
		FROM T_EQUIP_INSURANCE_DETAIL EID
		LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EID.EQUIP_ID
		LEFT JOIN T_PROJECT P ON E.PROJECT_ID = P.PROJECT_ID
		LEFT JOIN T_STORE_HOUSE SH ON E.STORE_ID = SH.STORE_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON EG.CODE = E.EQUIP_GENERIC
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON ES.CODE = E.EQUIP_SPECIFIC
		LEFT JOIN T_EQUIP_INSURANCE EI ON EI.INSURE_ID = EID.INSURE_ID
		WHERE EID.EQUIP_ID = @EQUIP_ID
		ORDER BY  EI.INSURE_ID DESC 
		]]>
	</select>
	<!-- 添加理赔信息时查找关联的信息 -->
	<select id="equip_insureance_claim_info_before_add">
		<![CDATA[
		DECLARE @DETAIL_ID BIGINT
		SET @DETAIL_ID = ?	
        SELECT  
		        EID.INSURANCE_CATEGORY AS insuranceCategory,
                EID.EQUIP_ID AS equipId,
			    EI.INSURE_ID AS insureId,
			    EI.INSURE_SERIAL AS insureSerial,
				EI.LINKMAN AS linkman,
		        SH.STORE_NAME AS storeName,
		       	P.PROJECT_NAME AS projectName,
		        EI.START_INSURE_DATE AS startInsureDate,
				EI.END_INSURE_DATE AS endInsureDate,
				E.EXW_SERIAL AS exwSerial,
				EID.ADDRESS AS address,
				E.EQUIP_SERIAL AS equipSerial,
				EID.EQUIP_WORTH AS equipWorth,
				EI.INSURANCE_COMPANY AS insuranceCompany,
				EI.CLAIM_PHONE AS claimPhone,
				EG.VALUE AS equipGeneric,
				ES.VALUE AS equipSpecific,
				EI.INSURE_SERIAL AS insureSerial,
				EI.LINKMAN AS linkMan,
				EID.PREMIUM AS premium,
				EI.CLAIM_PHONE AS claimPhone,
				EI.LINKMAN_PHONE AS linkmanPhone
		FROM T_EQUIP_INSURANCE_DETAIL EID
		LEFT JOIN T_EQUIP_INSURANCE EI ON EI.INSURE_ID = EID.INSURE_ID
		LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EID.EQUIP_ID
		LEFT JOIN T_PROJECT P ON E.PROJECT_ID = P.PROJECT_ID
		LEFT JOIN T_STORE_HOUSE SH ON E.STORE_ID = SH.STORE_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON EG.CODE = E.EQUIP_GENERIC
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON ES.CODE = E.EQUIP_SPECIFIC
		WHERE EID.DETAIL_ID = @DETAIL_ID
		]]>
	</select>

	<!-- 保险管理查看中的理赔明细 -->
	<select id="equip_insureance_claim_detail">
		<![CDATA[
		DECLARE @INSURE_ID BIGINT
		SET @INSURE_ID = ?	
        SELECT
       			E.EQUIP_ID AS equipId,
		        EICR.INSURE_ID AS insureId,
		        EICR.CLAIM_ID AS claimId,
				EI.INSURE_SERIAL AS insureSerial,
				EI.INSURANCE_COMPANY AS insureCompany,
				EICR.BANK_DEPOSIT AS bankDeposit,
		        EICR.DEPOSIT_ACCOUNT AS depositAccount,
		        EICR.CLAIM_DATE AS claimDate,
		        EICR.COST_AMOUNT AS costAmount,
		        EICR.CLAIM_AMOUNT AS claimAmount,
		        EICR.CLAIM_REASON AS claimReason, 
				E.PROJECT_NAME AS projectName,
				E.EQUIP_SERIAL AS equipSerial,
				ES.VALUE AS equipSpecific,
				EG.VALUE AS equipGeneric,
				E.EXW_SERIAL AS exwSerial,    
       			EID.INSURANCE_CATEGORY AS insureCategory,
				SH.STORE_NAME AS storeName
    	FROM T_EQUIP_INSURANCE_CLAIM_RECORD EICR
		LEFT JOIN T_EQUIP_INSURANCE EI ON EI.INSURE_ID = EICR.INSURE_ID
		LEFT JOIN T_EQUIP_INSURANCE_DETAIL EID ON EICR.INSURE_ID = EID.INSURE_ID
		LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = EID.EQUIP_ID
		LEFT JOIN T_STORE_HOUSE SH ON E.STORE_ID = SH.STORE_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON EG.CODE = E.EQUIP_GENERIC
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON ES.CODE = E.EQUIP_SPECIFIC
	    WHERE EICR.INSURE_ID = @INSURE_ID
	    AND EICR.DEL_FLAG = 1
	    ORDER BY claimDate  DESC
		]]>
	</select>
	<!-- 安拆的验收列表查询 -->
	<select id="equip_install_dismantle_detail">
		<![CDATA[
       DECLARE @recordId VARCHAR(64)
       DECLARE @exwSerial  VARCHAR(64)
       DECLARE @projectName  VARCHAR(64)
       DECLARE @equipSerial  VARCHAR(64)
		SET @recordId = ?
	    SET @exwSerial =?
		SET @projectName =?
		SET @equipSerial =?
		 
SELECT 
            IR.REVIEW_ID AS reviewId,
        	EDI.BUILDING_NUM AS buildingNum,
			EDI.PROJECT_NAME AS projectName,
			EDI.RECORD_ID AS recordId,
			CL.ADDRESS AS address,
			EDI.EQUIP_SERIAL AS equipSerial,
			EDI.EXW_SERIAL AS exwSerial,
			EG.VALUE AS equipGenericName,
			IR.REVIW_CHECK_ATTACH AS reviwCheckAttach,
			IR.REVIEW_CONCLUSION AS reviewConclusion,
			IR.INSTALL_ID AS installId,
			IR.REVIE_STATUS AS reviewStatus,
			(CASE WHEN IR.RELATE_MODULE ='EQUIP_INSTALL' THEN '安装验收' END) AS relateModule,
			IR.REJECT_REASON AS rejectReason,
			IR.RELATE_ID AS relateId
		FROM T_INSTALL_REVIEW IR
		LEFT JOIN T_EQUIPMENT_INSTALL EI ON EI.INSTALL_ID = IR.RELATE_ID
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = EI.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EDI ON EDI.EQUIP_ID = EF.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON EG.CODE = EDI.EQUIP_GENERIC
		LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = EF.CONTRACT_ID
		WHERE IR.RELATE_MODULE ='EQUIP_INSTALL'
		AND (EDI.RECORD_ID LIKE '%'+@recordId+'%' OR @recordId = '' OR @recordId IS NULL )
		AND (EDI.EXW_SERIAL LIKE '%'+@exwSerial+'%' OR @exwSerial = '' OR @exwSerial IS NULL )
	    AND (EDI.PROJECT_NAME LIKE '%'+@projectName+'%' OR @projectName = '' OR @projectName IS NULL )
		AND (EDI.EQUIP_SERIAL LIKE '%'+@equipSerial+'%' OR @equipSerial = '' OR @equipSerial IS NULL )
		UNION ALL
		SELECT 
		    IR.REVIEW_ID AS reviewId,
			EDI.BUILDING_NUM AS buildingNum,
			EDI.PROJECT_NAME AS projectName,
			EDI.RECORD_ID AS recordId,
			CL.ADDRESS AS address,
			EDI.EQUIP_SERIAL AS equipSerial,
			EDI.EXW_SERIAL AS exwSerial,
			EG.VALUE AS equipGenericName,
			IR.REVIW_CHECK_ATTACH AS reviwCheckAttach,
			IR.REVIEW_CONCLUSION AS reviewConclusion,
			IR.INSTALL_ID AS installId,
			IR.REVIE_STATUS AS reviewStatus,
			(CASE WHEN IR.RELATE_MODULE ='EQUIP_DISMANTLE' THEN '拆卸验收' END) AS relateModule,
			IR.REJECT_REASON AS rejectReason,
			IR.RELATE_ID AS relateId
		FROM T_INSTALL_REVIEW IR
		LEFT JOIN T_EQUIPMENT_DISMANTLE ED ON ED.DISMANTLE_ID = IR.RELATE_ID
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = ED.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EDI ON EDI.EQUIP_ID = EF.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON EG.CODE = EDI.EQUIP_GENERIC
		LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = EF.CONTRACT_ID
		WHERE IR.RELATE_MODULE ='EQUIP_DISMANTLE'
		AND (EDI.RECORD_ID LIKE '%'+@recordId+'%' OR @recordId = '' OR @recordId IS NULL )
		AND (EDI.EXW_SERIAL LIKE '%'+@exwSerial+'%' OR @exwSerial = '' OR @exwSerial IS NULL )
	    AND (EDI.PROJECT_NAME LIKE '%'+@projectName+'%' OR @projectName = '' OR @projectName IS NULL )
		AND (EDI.EQUIP_SERIAL LIKE '%'+@equipSerial+'%' OR @equipSerial = '' OR @equipSerial IS NULL )
		]]>
	</select>
<!-- 小程序领导首页之年度装机统计 -->
	<select id="equip_install_year_count">
		<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		DECLARE @EQUIP_SOURCE VARCHAR(1)
		SET @STARTIN_DATE = ?	
		SET @EQUIP_SOURCE = ?	
        SELECT 
			yearCount = (COUNT(0)),
			sCount = (COUNT(CASE WHEN (E.EQUIP_GENERIC = 'S') THEN '2' END)),
			tCount = (COUNT(CASE WHEN (E.EQUIP_GENERIC = 'T') THEN '3' END))
		FROM T_EQUIPMENT_INSTALL EI 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT E ON EF.EQUIP_ID = E.EQUIP_ID
		WHERE EI.DEL_FLAG = '1'
		AND LEFT(convert(DATE,EI.STARTIN_DATE),4) = @STARTIN_DATE
		AND (E.EQUIP_SOURCE = @EQUIP_SOURCE OR @EQUIP_SOURCE = '' OR @EQUIP_SOURCE IS NULL )
		AND EI.APPLYFOR_STATE = '3'
		]]>
	</select>


	<!-- 小程序领导首页之月度装机统计 -->
	<select id="equip_install_month_count">
		<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		DECLARE @EQUIP_SOURCE VARCHAR(1)
		SET @STARTIN_DATE = ?	
		SET @EQUIP_SOURCE = ?	
       	SELECT 
			SUM(1) AS monthCount,
			LEFT(convert(VARCHAR,EI.STARTIN_DATE),2) AS STARTIN_DATE,
			E.EQUIP_GENERIC
		FROM T_EQUIPMENT_INSTALL EI 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT E ON EF.EQUIP_ID = E.EQUIP_ID
		WHERE EI.DEL_FLAG = '1'
		AND LEFT(convert(DATE,EI.STARTIN_DATE),4) = @STARTIN_DATE
		AND (E.EQUIP_SOURCE = @EQUIP_SOURCE OR @EQUIP_SOURCE = '' OR @EQUIP_SOURCE IS NULL )
		AND EI.APPLYFOR_STATE = '3' 
		GROUP BY LEFT(convert(VARCHAR,EI.STARTIN_DATE),2),	E.EQUIP_GENERIC
		]]>
	</select>


	<!-- 小程序领导首页之年度财务收款历史和年度统计 -->
	<select id="receive_year_count">
		<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		DECLARE @COOPERATION_WAY VARCHAR(1)
		SET @STARTIN_DATE = ?	
		SET @COOPERATION_WAY = ?	
		SELECT 
				SUM(T.receiveAmount) AS receiveAmountAll,
				SUM(T.summryReceiveble) AS receivebleAll,
				(CASE WHEN SUM(T.summryReceiveble)-SUM(T.receiveAmount)<0 THEN 0 ELSE SUM(T.summryReceiveble)-SUM(T.receiveAmount) END) AS notReceive,
				0 AS yearReceiveAmountAll,
				0 AS yearSummryReceivebleAll,
				0 AS yearNotReceive
		FROM 
		(SELECT 
			ISNULL(SC.SETTLE_AMOUNT,0) AS summryReceiveble,0 AS receiveAmount
		FROM T_SETTLE_CONTRACT SC
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE SC.EFFECTIVE = '1'  AND SC.DEL_FLAG ='1'
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		UNION ALL
		SELECT 
			0 AS summryReceiveble,ISNULL(AR.RECEIVE_AMOUNT,0) AS receiveAmount
		FROM T_AMOUNT_RECEIVE AR
		LEFT JOIN T_SETTLE_CONTRACT SC ON AR.RELATE_ID = SC.SETTLE_ID
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AR.APPLYFOR_STATE = '3' AND AR.DEL_FLAG ='1' AND AR.RELATE_MODULE = 'SETTLE_CONTRACT' 
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		UNION ALL
		SELECT
			0 AS summryReceiveble,ISNULL(AD.ADVANCE_RECEIVE_AMOUNT,0) AS receiveAmount
		FROM T_ADVANCE_RECEIVE AD
		LEFT JOIN T_CONTRACT_LEASE CL ON AD.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AD.APPLYFOR_STATE = '3' AND AD.DEL_FLAG ='1' 
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		)T
		UNION ALL 
		SELECT 
				0 AS receiveAmountAll,
				0 AS summryReceivebleAll,
				0  AS notReceive,
				SUM(G.receiveAmount) AS yearReceiveAmountAll,
				SUM(G.summryReceiveble) AS yearSummryReceivebleAll,
				(CASE WHEN SUM(G.summryReceiveble)-SUM(G.receiveAmount)<0 THEN 0 ELSE SUM(G.summryReceiveble)-SUM(G.receiveAmount) END)  AS yearNotReceive
		FROM 
		(SELECT 
			ISNULL(SC.SETTLE_AMOUNT,0) AS summryReceiveble,0 AS receiveAmount
		FROM T_SETTLE_CONTRACT SC
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE SC.EFFECTIVE = '1' AND LEFT(SC.START_SETTLE_DATE, 4) = @STARTIN_DATE AND SC.DEL_FLAG ='1'
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		UNION ALL
		SELECT 
			0 AS summryReceiveble,ISNULL(AR.RECEIVE_AMOUNT,0) AS receiveAmount
		FROM T_AMOUNT_RECEIVE AR
		LEFT JOIN T_SETTLE_CONTRACT SC ON AR.RELATE_ID = SC.SETTLE_ID
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AR.APPLYFOR_STATE = '3' AND AR.DEL_FLAG ='1' AND AR.RELATE_MODULE = 'SETTLE_CONTRACT' AND LEFT(AR.RECEIVE_DATE, 4) = @STARTIN_DATE
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		UNION ALL
		SELECT
			0 AS summryReceiveble,ISNULL(AD.ADVANCE_RECEIVE_AMOUNT,0) AS receiveAmount
		FROM T_ADVANCE_RECEIVE AD
		LEFT JOIN T_CONTRACT_LEASE CL ON AD.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AD.APPLYFOR_STATE = '3' AND AD.DEL_FLAG ='1' AND LEFT(AD.ADVANCE_DATE, 4) = @STARTIN_DATE
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		)G
		]]>
	</select>

	<!-- 小程序领导首页之年度财务收款每月统计 -->
	<select id="receive_month_count">
		<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		DECLARE @COOPERATION_WAY VARCHAR(1)
		SET @STARTIN_DATE = ?	
		SET @COOPERATION_WAY = ?	
		SELECT 
				SUM(T.receiveAmount) AS receiveAmountAll,
				SUM(T.summryReceiveble) AS summryReceivebleAll,
				(CASE WHEN SUM(T.summryReceiveble)-SUM(T.receiveAmount)<0 THEN 0 ELSE SUM(T.summryReceiveble)-SUM(T.receiveAmount) END) AS notReceive,
				Convert(decimal(18,2),(CASE WHEN SUM(T.summryReceiveble)=0 THEN 0
			ELSE SUM(T.receiveAmount)/SUM(T.summryReceiveble)*100
		END)) AS proportion,
				T.NEW_DATE
		FROM 
		(SELECT 
			ISNULL(SC.SETTLE_AMOUNT,0) AS summryReceiveble,0 AS receiveAmount,SUBSTRING(SC.START_SETTLE_DATE, 6,2) AS NEW_DATE
		FROM T_SETTLE_CONTRACT SC
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE SC.EFFECTIVE = '1' AND LEFT(SC.START_SETTLE_DATE, 4) = @STARTIN_DATE  AND SC.DEL_FLAG ='1'
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		UNION ALL
		SELECT 
			0 AS summryReceiveble,ISNULL(AR.RECEIVE_AMOUNT,0) AS receiveAmount,SUBSTRING(AR.RECEIVE_DATE, 6,2) AS NEW_DATE
		FROM T_AMOUNT_RECEIVE AR
		LEFT JOIN T_SETTLE_CONTRACT SC ON AR.RELATE_ID = SC.SETTLE_ID
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AR.APPLYFOR_STATE = '3' AND AR.DEL_FLAG ='1' AND AR.RELATE_MODULE = 'SETTLE_CONTRACT' AND LEFT(AR.RECEIVE_DATE, 4) = @STARTIN_DATE 
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		UNION ALL
		SELECT
			0 AS summryReceiveble,ISNULL(AD.ADVANCE_RECEIVE_AMOUNT,0) AS receiveAmount,SUBSTRING(AD.ADVANCE_DATE, 6,2) AS NEW_DATE
		FROM T_ADVANCE_RECEIVE AD
		LEFT JOIN T_CONTRACT_LEASE CL ON AD.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AD.APPLYFOR_STATE = '3' AND AD.DEL_FLAG ='1' AND LEFT(AD.ADVANCE_DATE, 4) = @STARTIN_DATE  
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		)T  GROUP BY T.NEW_DATE
		]]>
	</select>

	<!-- 小程序领导首页之月度合同签署情况 -->
	<select id="contract_month_count">
		<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		DECLARE @COOPERATION_WAY VARCHAR(1)
		SET @STARTIN_DATE = ?	
		SET @COOPERATION_WAY = ?	
		SELECT 
			SUM(1) AS allCount,
			0 AS otherCount,
			SUBSTRING(CL.SIGNING_TIME, 6,2) AS STARTIN_DATE
		FROM T_CONTRACT_LEASE CL 
		WHERE CL.DEL_FLAG = '1'
		AND LEFT(CL.SIGNING_TIME,4) = @STARTIN_DATE 
		AND (CL.APPLYFOR_STATE = '6' OR CL.APPLYFOR_STATE = '5')
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )
		GROUP BY SUBSTRING(CL.SIGNING_TIME, 6,2)
		UNION ALL
		SELECT 
			0 AS allCount,
			SUM(1) AS otherCount,
			SUBSTRING(CL.SIGNING_TIME, 6,2) AS STARTIN_DATE
		FROM T_CONTRACT_LEASE CL 
		WHERE CL.DEL_FLAG = '1'
		AND LEFT(CL.SIGNING_TIME,4) = @STARTIN_DATE 
		AND CL.APPLYFOR_STATE <  '5'
		AND (CL.COOPERATION_WAY = @COOPERATION_WAY OR @COOPERATION_WAY = '' OR @COOPERATION_WAY IS NULL )	
		GROUP BY SUBSTRING(CL.SIGNING_TIME, 6,2)
		]]>
	</select>
	<!-- 小程序领导首页之租赁设备情况 -->
	<select id="equip_count">
	<![CDATA[
		DECLARE @EQUIP_SOURCE VARCHAR(1)
		DECLARE @EQUIP_GENERIC VARCHAR(1)
		SET @EQUIP_SOURCE = ?	
		SET @EQUIP_GENERIC = ?
		Select inuse=(COUNT(case when((BUSINESS_STATUS >= '3' or BUSINESS_STATUS <='6') AND (STATUS =0 or STATUS=8 or STATUS =9)) then '1' end))
		,notInuse=(COUNT(case when(BUSINESS_STATUS ='0'  AND STATUS =1) then '2' end))
		,broken=(COUNT(case when(BUSINESS_STATUS='7' or BUSINESS_STATUS ='9' or STATUS =4) then '3' end)) 
		,out=(COUNT(case when(BUSINESS_STATUS ='2' AND STATUS =1) then '4' end))
		,scrap= (COUNT(case when(STATUS =6) then '1' end))
		from T_EQUIPMENT t where DEL_FLAG = 1
		AND (EQUIP_SOURCE = @EQUIP_SOURCE OR @EQUIP_SOURCE = '' OR @EQUIP_SOURCE IS NULL )
		AND (EQUIP_GENERIC = @EQUIP_GENERIC OR @EQUIP_GENERIC = '' OR @EQUIP_GENERIC IS NULL )
	]]>
	</select>
	<!--看板本月巡检管理表格 -->
	<select id="lead_month_inspect_table">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		DECLARE @EQUIP_SOURCE VARCHAR(1)
		SET @STARTIN_DATE = ?
		SET @EQUIP_SOURCE = ?	
		;WITH QUERY AS (
			SELECT 
			T.*, 
			EIS.INSPECT_SCHEMA_ID,
			EIS.DEL_FLAG AS 'SCHEMA_DEL_FLAG',
			EIS.ACTIVE AS 'SCHEMA_ACTIVE',
			EIT.INSPECT_SERIAL,
			EIT.STATUS AS 'INSPECT_STATUS',
			EIT.INSPECT_RESULT,
			EIT.INSPECT_DATE
			FROM 
			(
				SELECT DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID,MAX(FLOW_ID) AS 'FLOW_ID'
				FROM (
				SELECT 
					PD.DEP_ID,
					PD.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D,DEPARTMENT PD
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.PARENT_ID=PD.DEP_ID
					AND D.DEP_LEVEL=4 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1
					AND (E.EQUIP_SOURCE = @EQUIP_SOURCE OR @EQUIP_SOURCE = '' OR @EQUIP_SOURCE IS NULL )
				union all 
				SELECT 
					D.DEP_ID,
					D.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.DEP_LEVEL=3 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1
					AND (E.EQUIP_SOURCE = @EQUIP_SOURCE OR @EQUIP_SOURCE = '' OR @EQUIP_SOURCE IS NULL )
					) T
				GROUP BY DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID
			) T LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.FLOW_ID=T.FLOW_ID
				LEFT JOIN T_EQUIPMENT_INSPECT EIT ON EIT.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
				WHERE datename(year,EIT.INSPECT_DATE)  = @STARTIN_DATE	
		) 
		SELECT *,
			CASE WHEN T.currentMonthInstallCount IS NULL OR T.currentMonthInstallCount=0 THEN 0 
				ELSE CONVERT(DECIMAL(5,1), 100.0*ISNULL(T.currentMonthInspectCount,0) / T.currentMonthInstallCount) 
					END AS 'corpInspectCompleted'
			FROM (
				SELECT 
				Q.DEP_ID AS 'depId',
				Q.DEP_NAME AS 'depName',
				COUNT(DISTINCT FLOW_ID) AS 'currentMonthInstallCount',
				(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 AND DEP_ID=Q.DEP_ID) AS 'finishedCount',
				(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
					AND DEP_ID=Q.DEP_ID AND DATEDIFF(MONTH, INSPECT_DATE, GETDATE())=0) AS 'currentMonthInspectCount',
				(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
					AND DEP_ID=Q.DEP_ID AND DATEDIFF(MONTH, INSPECT_DATE, GETDATE())=0 AND CHARINDEX(INSPECT_RESULT,'345')>0) AS 'depAbnormalCount'
				FROM QUERY Q GROUP BY Q.DEP_ID, Q.DEP_NAME
			) T ORDER BY corpInspectCompleted DESC
	]]>
	</select>

	<!--本月巡检管理4个圈 -->
	<select id="lead_month_inspect_collect">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		DECLARE @EQUIP_SOURCE VARCHAR(1)
		SET @STARTIN_DATE = ?
		SET @EQUIP_SOURCE = ?	
		;WITH QUERY AS (
			SELECT 
			T.*, 
			EIS.INSPECT_SCHEMA_ID,
			EIS.DEL_FLAG AS 'SCHEMA_DEL_FLAG',
			EIS.ACTIVE AS 'SCHEMA_ACTIVE',
			EIT.INSPECT_SERIAL,
			EIT.STATUS AS 'INSPECT_STATUS',
			EIT.INSPECT_RESULT,
			EIT.INSPECT_DATE
			FROM 
			(
				SELECT DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID,MAX(FLOW_ID) AS 'FLOW_ID'
				FROM (
				SELECT 
					PD.DEP_ID,
					PD.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D,DEPARTMENT PD
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.PARENT_ID=PD.DEP_ID
					AND D.DEP_LEVEL=4 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1
					AND (E.EQUIP_SOURCE = @EQUIP_SOURCE OR @EQUIP_SOURCE = '' OR @EQUIP_SOURCE IS NULL )
				union all 
				SELECT 
					D.DEP_ID,
					D.DEP_NAME,
					E.EQUIP_SERIAL,
					E.EQUIP_ID,
					EF.FLOW_ID
					FROM T_EQUIPMENT_INSTALL EI,T_EQUIPMENT_FLOW EF,T_EQUIPMENT E, DEPARTMENT D
					WHERE EI.FLOW_ID=EF.FLOW_ID 
					AND EF.EQUIP_ID=E.EQUIP_ID
					AND EI.DEL_FLAG=1 AND EI.APPLYFOR_STATE=3 
					AND D.DEP_ID=E.DEP_ID 
					AND D.DEP_LEVEL=3 
					AND EF.FLOW_STATE=2
					AND E.DEL_FLAG=1
					AND (E.EQUIP_SOURCE = @EQUIP_SOURCE OR @EQUIP_SOURCE = '' OR @EQUIP_SOURCE IS NULL )
					) T
				GROUP BY DEP_ID,DEP_NAME,EQUIP_SERIAL,EQUIP_ID
			) T LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.FLOW_ID=T.FLOW_ID
				LEFT JOIN T_EQUIPMENT_INSPECT EIT ON EIT.INSPECT_SCHEMA_ID=EIS.INSPECT_SCHEMA_ID
				WHERE datename(year,EIT.INSPECT_DATE)  = @STARTIN_DATE	
		) 
		SELECT 
		COUNT(DISTINCT FLOW_ID) AS 'unfinishedCount',
		(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1) AS 'finishedCount',
		(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
			AND DATEDIFF(MONTH, INSPECT_DATE, GETDATE())=0) AS 'normalCount',
		(SELECT COUNT(DISTINCT INSPECT_SCHEMA_ID) FROM QUERY WHERE SCHEMA_DEL_FLAG=1 AND SCHEMA_ACTIVE=1 
			AND DATEDIFF(MONTH, INSPECT_DATE, GETDATE())=0 AND CHARINDEX(INSPECT_RESULT,'345')>0) AS 'abnormalCount'
		FROM QUERY Q 
	]]>
	</select>

	<!--故障维修统计 -->
	<select id="lead_repair_count">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		SET @STARTIN_DATE = ?
		SELECT COUNT(0) AS allRepair 
		FROM(SELECT 
				DISTINCT AR.EQUIP_ID
		FROM T_APP_REPAIR AR
		WHERE LEFT(AR.REPORT_DT,4) = @STARTIN_DATE)T
	]]>
	</select>
	<!--巡检异常统计 -->
	<select id="lead_repair_inspect">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		SET @STARTIN_DATE = ?
		SELECT 
			SUM(T.allCount) AS allCount,
			SUM(T.rectiCount) AS rectiCount
		FROM (SELECT
				COUNT(0) AS allCount,
				0 AS rectiCount
		FROM T_EQUIPMENT_INSPECT EI
		WHERE CHARINDEX(EI.INSPECT_RESULT,'345')>0
		AND DATENAME(YEAR, EI.INSPECT_DATE) = @STARTIN_DATE
		UNION  ALL
		SELECT 
			0 AS allCount,
		    COUNT(0) AS rectiCount
		FROM T_EQUIPMENT_INSPECT ES
		WHERE ES.RECTIFICATION = '2'
		AND DATENAME(YEAR, ES.INSPECT_DATE) = @STARTIN_DATE)T
	]]>
	</select>
	<!--合同未超期或超期统计 -->
	<select id="lead_contract_time_count">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		SET @STARTIN_DATE = ?
		SELECT 
		SUM (CASE WHEN G.startDate < CONVERT(varchar(10), getDate(),120) THEN 1 ELSE 0 END) AS inTimeCount,
		SUM (CASE WHEN G.startDate > CONVERT(varchar(10), getDate(),120) THEN 1 ELSE 0 END) AS outTimeCount
		FROM (SELECT
				CL.CONTRACT_ID,		
				MAX(CE.START_DATE) AS startDate
		FROM T_CONTRACT_LEASE CL
		LEFT JOIN T_CONTRACT_EQUIP_BRIEF CE ON CL.CONTRACT_ID = CE.CONTRACT_ID
		WHERE CL.DEL_FLAG = '1'
		AND CL.APPLYFOR_STATE ='6'
		AND LEFT(CE.START_DATE, 4) = @STARTIN_DATE
		GROUP BY CL.CONTRACT_ID)G
	]]>
	</select>

	<!--装机统计 -->
	<select id="lead_equip_review_count">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		SET @STARTIN_DATE = ?
				SELECT SUM(T.installCount) AS  installCount,SUM(T.dismantleCount) AS dismantleCount FROM (SELECT 
		COUNT(0) AS installCount,
		0 AS dismantleCount
		FROM T_INSTALL_REVIEW IR
		LEFT JOIN T_EQUIPMENT_INSTALL EI ON EI.INSTALL_ID = IR.RELATE_ID
		WHERE IR.RELATE_MODULE = 'EQUIP_INSTALL'
		AND IR.REVIE_STATUS = '驳回'
		AND DATENAME(YEAR, EI.STARTIN_DATE) = @STARTIN_DATE
		UNION ALL
		SELECT 
			0 AS installCount,
			COUNT(0) AS dismantleCount
		FROM T_INSTALL_REVIEW IR
		LEFT JOIN T_EQUIPMENT_DISMANTLE ED ON ED.DISMANTLE_ID = IR.RELATE_ID
		WHERE IR.RELATE_MODULE = 'EQUIP_DISMANTLE'
		AND IR.REVIE_STATUS = '驳回'
		AND DATENAME(YEAR, ED.STARTDIS_DATE) = @STARTIN_DATE)T
	]]>
	</select>

	<!--设备租赁情况 -->
	<select id="lead_equip_broken_count">
	<![CDATA[
		Select 
			broken=(COUNT(case when(BUSINESS_STATUS='7' or BUSINESS_STATUS ='9' or STATUS =4) then '3' end)) 
			  ,out=(COUNT(case when(BUSINESS_STATUS ='2' AND STATUS =1) then '4' end))
		from T_EQUIPMENT t where DEL_FLAG = 1
	]]>
	</select>
	<!--未收款情况 -->
	<select id="lead_receive_not_count">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		SET @STARTIN_DATE = ?
		SELECT 
		(CASE WHEN SUM(G.summryReceiveble)-SUM(G.receiveAmount)<0 THEN 0 ELSE SUM(G.summryReceiveble)-SUM(G.receiveAmount) END)  AS yearNotReceive
		FROM 
		(SELECT 
			ISNULL(SC.SETTLE_AMOUNT,0) AS summryReceiveble,0 AS receiveAmount
		FROM T_SETTLE_CONTRACT SC
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE SC.EFFECTIVE = '1' AND LEFT(SC.START_SETTLE_DATE, 4) = @STARTIN_DATE AND SC.DEL_FLAG ='1'
		UNION ALL
		SELECT 
			0 AS summryReceiveble,ISNULL(AR.RECEIVE_AMOUNT,0) AS receiveAmount
		FROM T_AMOUNT_RECEIVE AR
		LEFT JOIN T_SETTLE_CONTRACT SC ON AR.RELATE_ID = SC.SETTLE_ID
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AR.APPLYFOR_STATE = '3' AND AR.DEL_FLAG ='1' AND AR.RELATE_MODULE = 'SETTLE_CONTRACT' AND LEFT(AR.RECEIVE_DATE, 4) = @STARTIN_DATE
		UNION ALL
		SELECT
			0 AS summryReceiveble,ISNULL(AD.ADVANCE_RECEIVE_AMOUNT,0) AS receiveAmount
		FROM T_ADVANCE_RECEIVE AD
		LEFT JOIN T_CONTRACT_LEASE CL ON AD.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AD.APPLYFOR_STATE = '3' AND AD.DEL_FLAG ='1' AND LEFT(AD.ADVANCE_DATE, 4) = @STARTIN_DATE
		)G
	]]>
	</select>
	<!--未结算项目情况 -->
	<select id="lead_contract_settle_count">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		SET @STARTIN_DATE = ?
		SELECT
				COUNT(0) AS contractCount
		FROM T_CONTRACT_LEASE CL
		WHERE NOT EXISTS (SELECT SP.CONTRACT_ID FROM T_SETTLE_CONTRACT SP
		WHERE CL.CONTRACT_ID = SP.CONTRACT_ID )
		AND LEFT(CL.SIGNING_TIME,4) = @STARTIN_DATE 
	]]>
	</select>

	<!--未结算项目情况 -->
	<select id="lead_contract_settle_month">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		SET @STARTIN_DATE = ?
			SELECT G.startDate,SUM(G.allCount) AS allCount,SUM(G.notReceive) AS notReceive
		FROM (SELECT
				1 AS allCount,
				0 AS notReceive,
				SUBSTRING(CL.SIGNING_TIME,6,2) AS startDate
		FROM T_CONTRACT_LEASE CL
		WHERE NOT EXISTS (SELECT SP.CONTRACT_ID FROM T_SETTLE_CONTRACT SP
		WHERE CL.CONTRACT_ID = SP.CONTRACT_ID )
		AND LEFT(CL.SIGNING_TIME,4) = @STARTIN_DATE 
		UNION ALL
		SELECT 
					0 AS allCount,	
				(CASE WHEN SUM(T.summryReceiveble)-SUM(T.receiveAmount)<0 THEN 0 ELSE SUM(T.summryReceiveble)-SUM(T.receiveAmount) END) AS notReceive,
				T.startDate
		FROM 
		(SELECT 
			ISNULL(SC.SETTLE_AMOUNT,0) AS summryReceiveble,0 AS receiveAmount,SUBSTRING(SC.START_SETTLE_DATE, 6,2) AS startDate
		FROM T_SETTLE_CONTRACT SC
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE SC.EFFECTIVE = '1' AND LEFT(SC.START_SETTLE_DATE, 4) = @STARTIN_DATE  AND SC.DEL_FLAG ='1'
		UNION ALL
		SELECT 
			0 AS summryReceiveble,ISNULL(AR.RECEIVE_AMOUNT,0) AS receiveAmount,SUBSTRING(AR.RECEIVE_DATE, 6,2) AS NEW_DATE
		FROM T_AMOUNT_RECEIVE AR
		LEFT JOIN T_SETTLE_CONTRACT SC ON AR.RELATE_ID = SC.SETTLE_ID
		LEFT JOIN T_CONTRACT_LEASE CL ON SC.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AR.APPLYFOR_STATE = '3' AND AR.DEL_FLAG ='1' AND AR.RELATE_MODULE = 'SETTLE_CONTRACT' AND LEFT(AR.RECEIVE_DATE, 4) = @STARTIN_DATE 
		UNION ALL
		SELECT
			0 AS summryReceiveble,ISNULL(AD.ADVANCE_RECEIVE_AMOUNT,0) AS receiveAmount,SUBSTRING(AD.ADVANCE_DATE, 6,2) AS NEW_DATE
		FROM T_ADVANCE_RECEIVE AD
		LEFT JOIN T_CONTRACT_LEASE CL ON AD.CONTRACT_ID = CL.CONTRACT_ID 
		WHERE AD.APPLYFOR_STATE = '3' AND AD.DEL_FLAG ='1' AND LEFT(AD.ADVANCE_DATE, 4) = @STARTIN_DATE  
		)T  GROUP BY T.startDate)G  GROUP BY G.startDate
	]]>
	</select>

	<select id="lead_equip_review_month">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		SET @STARTIN_DATE = ?
		SELECT T.startDate,SUM(T.installCount) AS installCount,SUM(T.dismantleCount)  AS dismantleCount FROM (SELECT 
			SUM(1) AS installCount,
			NULL AS dismantleCount,
			DATENAME(MONTH, EI.STARTIN_DATE) AS startDate
		FROM T_INSTALL_REVIEW IR
		LEFT JOIN T_EQUIPMENT_INSTALL EI ON EI.INSTALL_ID = IR.RELATE_ID
		WHERE IR.RELATE_MODULE = 'EQUIP_INSTALL'
		AND IR.REVIE_STATUS = '驳回'
		AND DATENAME(YEAR, EI.STARTIN_DATE) = @STARTIN_DATE
		GROUP BY DATENAME(MONTH, EI.STARTIN_DATE)
		UNION ALL
		SELECT 
			NULL AS installCount,
			SUM(1) AS dismantleCount,
			DATENAME(MONTH, ED.STARTDIS_DATE) AS startDate
		FROM T_INSTALL_REVIEW IR
		LEFT JOIN T_EQUIPMENT_DISMANTLE ED ON ED.DISMANTLE_ID = IR.RELATE_ID
		WHERE IR.RELATE_MODULE = 'EQUIP_DISMANTLE'
		AND IR.REVIE_STATUS = '驳回'
		AND DATENAME(YEAR, ED.STARTDIS_DATE) =  @STARTIN_DATE
		GROUP BY DATENAME(MONTH, ED.STARTDIS_DATE))T GROUP BY T.startDate
	]]>
	</select>
	<!-- 小程序数据统计之故障异常分月 -->
	<select id="lead_repair_inspect_month">
	<![CDATA[
		DECLARE @STARTIN_DATE VARCHAR(4)
		SET @STARTIN_DATE = ?
				SELECT  
			T.startDate,
			SUM(T.reportCount) AS reportCount,
			SUM(T.inspectCount) AS inspectCount
		FROM (
		SELECT 
				1 AS reportCount,
		    0 AS inspectCount,
				SUBSTRING(AR.REPORT_DT,6,2) AS startDate
		FROM T_APP_REPAIR AR
		WHERE LEFT(AR.REPORT_DT,4) = @STARTIN_DATE
		UNION ALL
		SELECT
				0 AS reportCount,
				1 AS inspectCount,
		    DATENAME(MONTH, EI.INSPECT_DATE) AS startDate
		FROM T_EQUIPMENT_INSPECT EI
		WHERE CHARINDEX(EI.INSPECT_RESULT,'345')>0
		AND DATENAME(YEAR, EI.INSPECT_DATE) = @STARTIN_DATE
		)T
		GROUP BY T.startDate
	]]>
	</select>

	<!-- 小程序数据统计之分月 -->
	<select id="lead_inspect_month_detail">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		DECLARE @STARTIN_DATE VARCHAR(7)
		SET @START = ?
   	    SET @PAGE_SIZE =?
		SET @STARTIN_DATE = ?
		;WITH QUERY AS (SELECT 
		T.* ,
			(SELECT D.DEP_NAME FROM T_CONTRACT_LEASE L LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.CONTRACT_ID=L.CONTRACT_ID
				LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIC ON EIC.FLOW_ID=EF.FLOW_ID LEFT JOIN T_EQUIPMENT_INSPECT EI ON EI.INSPECT_SCHEMA_ID=EIC.INSPECT_SCHEMA_ID
				LEFT JOIN DEPARTMENT D ON D.DEP_ID = L.COMPETENT_DEPARTMET_ID
				WHERE EI.INSPECT_ID=T.inspectId ) AS paEntName,
				ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (SELECT
			ED.PROJECT_NAME AS projectName,
			ED.RECORD_ID AS recordId,
			EI.REMARK AS remark,
			EI.INSPECT_ID AS inspectId
		FROM T_EQUIPMENT_INSPECT EI
		LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA ES ON EI.INSPECT_SCHEMA_ID = ES.INSPECT_SCHEMA_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = ES.EQUIP_DIARY_ID
		WHERE CHARINDEX(EI.INSPECT_RESULT,'345')>0
		AND LEFT(CONVERT(varchar(100), EI.INSPECT_DATE, 23),7) = @STARTIN_DATE)T
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	<!--安全巡检列表 -->
	<select id="wechat_construction_inspect_list">
	<![CDATA[
	    DECLARE @START INT
        DECLARE @PAGE_SIZE INT
	    DECLARE	@keyword  VARCHAR(64)
		SET @START = ?
   	    SET @PAGE_SIZE =?
        SET @keyword =?
        ;WITH QUERY AS(SELECT 
	        EI.INSPECT_DATE AS inspectDate,
	        E.EXW_SERIAL AS exwSerial,
	        EI.INSPECT_PEPOLES AS inspectPeople,
	        (CASE EI.RECTIFICATION WHEN '1' THEN '待整改' 
					WHEN '2' THEN '已整改'  ELSE ''END) AS rectificationName,
	        BEG.VALUE AS equipGeneric,
	        BES.VALUE AS equipSpecific,
	        ED.PROJECT_ID AS projectId,
	        ED.PROJECT_NAME AS projectName,
	        ED.BUILDING_NUM AS buildingNum,
	        ISNULL(EI.INSPECT_RESULT,6) AS inspectResult,
	        ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
        FROM T_EQUIPMENT_INSPECT EI
        LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID
        LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EIS.EQUIP_DIARY_ID
        LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = ED.EQUIP_ID
        LEFT JOIN BM_EQUIP_GENERIC BEG ON BEG.CODE = E.EQUIP_GENERIC
        LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = E.EQUIP_SPECIFIC
        LEFT JOIN BM_INSPECT_RESULT BIR ON BIR.CODE = EI.INSPECT_RESULT
        WHERE ((ED.PROJECT_NAME LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
        OR (BES.VALUE LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (ED.BUILDING_NUM LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (E.EXW_SERIAL LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL ))
		)
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	<!--安全巡检列表详情接口 -->
	<select id="wechat_construction_inspect_detail">
	<![CDATA[
	    DECLARE @INSPECT_ID BIGINT
        SET @INSPECT_ID=?
        SELECT 
	        EI.INSPECT_DATE AS inspectDate,
	        EI.INSPECT_PEPOLES AS inspectPeople,
	        BIR.VALUE AS inspectResult,
	        BEG.VALUE AS equipGeneric,
	        BES.VALUE AS equipSpecific,
	        ED.PROJECT_NAME AS projectName,
	        ED.BUILDING_NUM AS buildingNum,
	        EI.FILE_ATTACHES AS fileAttaches,
	        E.RECORD_SERIAL AS recordSerial,
	        E.EXW_SERIAL AS exwSerial,
	        EI.REMARK AS remark
        FROM T_EQUIPMENT_INSPECT EI
        LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID
        LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EIS.EQUIP_DIARY_ID
        LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = ED.EQUIP_ID
        LEFT JOIN BM_EQUIP_GENERIC BEG ON BEG.CODE = E.EQUIP_GENERIC
        LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = E.EQUIP_SPECIFIC
        LEFT JOIN BM_INSPECT_RESULT BIR ON BIR.CODE = EI.INSPECT_RESULT
        WHERE EI.INSPECT_ID= @INSPECT_ID
        AND E.DEL_FLAG='1'
	]]>
	</select>
	<!--施工段故障报修列表 -->
	<select id="wechat_construction_call_repair_list">
	<![CDATA[
	    DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
         ;WITH QUERY AS(SELECT 
	        BES.VALUE AS equipSpecific,
	        E.EXW_SERIAL AS exwSerial,
	        E.RECORD_SERIAL AS recordSerical,
	        ED.PROJECT_NAME AS projectName,
	        ED.BUILDING_NUM AS buildingNum,
	        EI.ENDIN_DATE AS installDate,
	        ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
        FROM T_EQUIPMENT E
        LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = E.EQUIP_SPECIFIC
        LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_ID = E.EQUIP_ID
        LEFT JOIN T_EQUIPMENT_INSTALL EI ON EI.INSTALL_ID = ED.RELATE_ID
        WHERE E.DEL_FLAG='1'
        AND ED.RELATE_MODULE='EQUIP_INSTALL'
        AND EI.DEL_FLAG='1'
        AND EI.APPLYFOR_STATE='3')
        SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	<!--施工端故障报修报修前查询信息 -->
	<select id="wechat_construction_before_repair">
	<![CDATA[
        DECLARE @EQUIPID BIGINT
   	    SET @EQUIPID  = ?
        SELECT TOP 1
	         E.EXW_SERIAL AS exwSerial,
	         ED.PROJECT_NAME AS projectName,
	         ED.BUILDING_NUM AS buildingNum
        FROM T_EQUIPMENT E
        LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_ID = E.EQUIP_ID
        WHERE E.EQUIP_ID=@EQUIPID
	]]>
	</select>
	<!--报修进度列表 -->
	<select id="wechat_construction_repair_process_list">
	<![CDATA[
	    DECLARE	@keyword  VARCHAR(64)
	    DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
   	    SET @keyword =?
       ;WITH QUERY AS(SELECT
           AR.REPID AS repId,
           AR.PROC_MAN AS procMan,
               (CASE AR.STATE WHEN '0' THEN '报修中' 
				WHEN '1' THEN '已派工'  ELSE '已维修'END) AS stateName,
           BES.VALUE AS equipSpecific,
           AR.REPORT_DT AS reportDate,
           AR.PROC_MAN_ID AS procManId,
           ED.PROJECT_NAME AS projectName,
           ED.BUILDING_NUM AS buildingNum,
           E.EXW_SERIAL AS exwSerial,
	        ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
      FROM T_APP_REPAIR AR
      LEFT JOIN T_EQUIPMENT E ON AR.EQUIP_ID = E.EQUIP_ID
      LEFT JOIN BM_EQUIP_SPECIFIC BES ON E.EQUIP_SPECIFIC = BES.CODE
      LEFT JOIN T_EQUIPMENT_DIARY ED ON E.EQUIP_ID = ED.EQUIP_ID
       WHERE ((ED.PROJECT_NAME LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
        OR (BES.VALUE LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (ED.BUILDING_NUM LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (E.EXW_SERIAL LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )))
        SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	<!--报修进度详情接口 -->
	<select id="wechat_construction_repair_process_detail">
	<![CDATA[
	    DECLARE @REPID BIGINT
        SET @REPID=?
         SELECT
               AR.PROC_MAN AS procMan,
               (CASE AR.STATE WHEN '0' THEN '报修中' 
				WHEN '1' THEN '已派工'  ELSE '已维修'END) AS stateName,
              AR.FAULT_LEVEL AS faultLevel,
              E.EXW_SERIAL AS exwSerial,
              AR.CREATE_BY AS createByname,
              AR.CREATE_BY_PHONE AS createByPhone,
              AR.FAULT_DESC AS faultDesc,
              AR.REPAIR_BEFORE_IMAGE AS repairBeforeImage,
              BES.VALUE AS equipSpecific,
              AR.REPORT_DT AS reportDate,
              AR.PROC_MAN AS procMan,
              ED.PROJECT_NAME AS projectName,
              ED.BUILDING_NUM AS buildingNum,
              P.MOBILE AS mobile
      FROM T_APP_REPAIR AR
      LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = AR.EQUIP_ID
      LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = E.EQUIP_SPECIFIC
      LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_ID = E.EQUIP_ID
      LEFT JOIN T_PRACTITIONER P ON CHARINDEX(','+CONVERT(VARCHAR,P.PRACTI_ID),','+AR.PROC_MAN_ID)>0
      WHERE AR.REPID = @REPID
	]]>
	</select>
	<!--整改反馈列表 -->
	<select id="wechat_construction_repair_feedback_list">
	<![CDATA[
	    DECLARE	@keyword  VARCHAR(64)
	    DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
   	    SET @keyword = ?
       ;WITH QUERY AS(SELECT 
           IR.INSPECT_RECTIFY_ID AS inspectRectifyId,
           ED.PROJECT_NAME AS projectName,
           (CASE EI.RECTIFICATION WHEN '1' THEN '待整改' 
					WHEN '2' THEN '已整改'  ELSE ''END) AS rectificationName,
           IR.RECTIFY_RESULT AS rectifyResultName,
           BES.VALUE AS equipSpecific,
           EI.INSPECT_PEPOLES AS inspectPeople,
           EI.INSPECT_DATE AS inspectDate,
           EI.BUILDING_NUM AS buildingNum,
           E.EXW_SERIAL AS exwSerial,
           ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
    FROM T_INSPECT_RECTIFY IR
    LEFT JOIN T_EQUIPMENT_INSPECT EI ON EI.INSPECT_ID = IR.INSPECT_ID
    LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID
    LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EIS.EQUIP_DIARY_ID
    LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = ED.EQUIP_ID
    LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = E.EQUIP_SPECIFIC
    WHERE ((ED.PROJECT_NAME LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
        OR (BES.VALUE LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (ED.BUILDING_NUM LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (E.EXW_SERIAL LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )))
        SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	<!--整改反馈详情接口 -->
	<select id="wechat_construction_repair_feedback_detail">
	<![CDATA[
        DECLARE @INSPECTRECTIFYID BIGINT
        SET @INSPECTRECTIFYID=?
        SELECT 
            IR.REMARK AS remark,
            IR.RECTIFY_RESULT AS rectifyResult,
            BES.VALUE AS equipSpecific,
            IR.RECTIFY_USERNAME AS rectifyUserName,
            IR.RECTIFY_DATE AS rectifyDate,
            EI.BUILDING_NUM AS buildingNum,
            ED.PROJECT_NAME AS projectName,
            E.RECORD_SERIAL AS recordSerial,
			E.EXW_SERIAL AS exwSerial,
            IR.FILE_ATTACHES AS fileAttaches
    FROM T_INSPECT_RECTIFY IR
    LEFT JOIN T_EQUIPMENT_INSPECT EI ON EI.INSPECT_ID = IR.INSPECT_ID
    LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EIS ON EIS.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID
    LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EIS.EQUIP_DIARY_ID
    LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = ED.EQUIP_ID
    LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = E.EQUIP_SPECIFIC
      WHERE IR.INSPECT_RECTIFY_ID=@INSPECTRECTIFYID
	]]>
	</select>
	<!--施工端项目动态 -->
	<select id="wechat_construction_project_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
				FROM (SELECT
				AR.REPID AS relateId,
				'APP_REPAIR' AS relateModule,
				AR.PROJECT_ID AS projectId,
				AR.PROJ_NAME AS projectName,
				AR.BUILDING_NUM AS buildingNum,
				AR.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				AR.REPORT_DT AS creatyDate
		FROM T_APP_REPAIR AR
		LEFT JOIN T_EQUIPMENT E ON AR.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		UNION ALL
		SELECT
				R.INSPECT_RECTIFY_ID AS relateId,
				'EQUIP_INSPECT' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				ED.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				R.RECTIFY_DATE AS creatyDate
		FROM T_INSPECT_RECTIFY R
		LEFT JOIN T_EQUIPMENT_INSPECT ES ON R.INSPECT_ID = ES.INSPECT_ID
		LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EI ON ES.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID 
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EI.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		UNION ALL
		SELECT
				EI.INSTALL_ID AS relateId,
				'EQUIP_INSTALL' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				EI.STARTIN_DATE AS creatyDate
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		WHERE EI.DEL_FLAG = '1' AND EI.APPLYFOR_STATE = '3' AND EI.APP_INSTALL_STATE = '2'
		AND EF.FLOW_STATE<6 AND EF.FLOW_STATE >= 2
		UNION ALL
		SELECT
				ED.DISMANTLE_ID AS relateId,
				'EQUIP_DISMANTLE' AS relateModule,
				EI.PROJECT_ID AS projectId,
				EI.PROJECT_NAME AS projectName,
				EI.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				ED.STARTDIS_DATE AS creatyDate
		FROM T_EQUIPMENT_DISMANTLE ED 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON ED.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EI ON EF.EQUIP_DIARY_ID = EI.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON EI.EQUIP_GENERIC = BG.CODE
		WHERE ED.DEL_FLAG = '1' AND ED.APPLYFOR_STATE = '3' AND EF.FLOW_STATE = '6'
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之安拆信息 -->
	<select id="wechat_construction_dismantling_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				EI.INSTALL_ID AS relateId,
				'EQUIP_INSTALL' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				BS.VALUE AS equipSpecificName,
				EI.STARTIN_DATE AS creatyDate
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC BS ON ED.EQUIP_SPECIFIC = BS.CODE
		WHERE EI.DEL_FLAG = '1' AND EI.APPLYFOR_STATE = '3' AND EI.APP_INSTALL_STATE = '2'
		AND EF.FLOW_STATE<6 AND EF.FLOW_STATE >= 2
		UNION ALL
		SELECT
				ED.DISMANTLE_ID AS relateId,
				'EQUIP_DISMANTLE' AS relateModule,
				EI.PROJECT_ID AS projectId,
				EI.PROJECT_NAME AS projectName,
				EI.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				BS.VALUE AS equipSpecificName,
				ED.STARTDIS_DATE AS creatyDate
		FROM T_EQUIPMENT_DISMANTLE ED 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON ED.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EI ON EF.EQUIP_DIARY_ID = EI.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON EI.EQUIP_GENERIC = BG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC BS ON EI.EQUIP_SPECIFIC = BS.CODE
		WHERE ED.DEL_FLAG = '1' AND ED.APPLYFOR_STATE = '3' AND EF.FLOW_STATE = '6'
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之整改信息 -->
	<select id="wechat_construction_inspect_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				R.INSPECT_RECTIFY_ID AS relateId,
				'EQUIP_INSPECT' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				ED.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				R.RECTIFY_DATE AS creatyDate
		FROM T_INSPECT_RECTIFY R
		LEFT JOIN T_EQUIPMENT_INSPECT ES ON R.INSPECT_ID = ES.INSPECT_ID
		LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EI ON ES.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID 
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EI.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之维修信息 -->
	<select id="wechat_construction_repair_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				AR.REPID AS relateId,
				'APP_REPAIR' AS relateModule,
				AR.PROJECT_ID AS projectId,
				AR.PROJ_NAME AS projectName,
				AR.BUILDING_NUM AS buildingNum,
				AR.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				AR.REPORT_DT AS creatyDate,
				AR.PROC_MAN AS procMan,
				AR.PROC_MAN_ID AS procManId,
				P.MOBILE AS mobile
		FROM T_APP_REPAIR AR
		LEFT JOIN T_PRACTITIONER P ON CHARINDEX(','+CONVERT(VARCHAR,P.PRACTI_ID),','+AR.PROC_MAN_ID)>0
		LEFT JOIN T_EQUIPMENT E ON AR.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目列表 -->
	<select id="wechat_construction_project_list">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT 
			P.PROJECT_ID AS projectId,
			P.PROJECT_NAME AS projectName,
			ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM T_PROJECT P
		WHERE P.DEL_FLAG = '1'
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
		<!--施工端项目详情之需求设备 -->
	<select id="wechat_construction_project_equip">
	<![CDATA[
		DECLARE @PROJECT_ID BIGINT
		SET @PROJECT_ID =?
		SELECT
			SUM(T.allNum) AS allNum,
			SUM(T.disNum) AS disNum,
			T.equipGenericName
		FROM(SELECT
			1 AS allNum,
			0 AS disNum,
			BG.VALUE AS equipGenericName
		FROM T_DISPATCH D
		LEFT JOIN T_DISPATCH_EQUIP DE ON D.DISPATCH_ID = DE.DISPATCH_ID
		LEFT JOIN T_EQUIPMENT E ON DE.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		WHERE D.PROJECT_ID = @PROJECT_ID AND D.DEL_FLAG = '1'
		UNION ALL
		SELECT
			0 AS allNum,
			1 AS disNum,
			BG.VALUE AS equipGenericName
		FROM T_DISPATCH D
		LEFT JOIN T_DISPATCH_EQUIP DE ON D.DISPATCH_ID = DE.DISPATCH_ID
		LEFT JOIN T_EQUIPMENT E ON DE.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		WHERE D.PROJECT_ID = @PROJECT_ID AND D.DEL_FLAG = '1' AND D.APPLYFOR_STATE = '3')T
		GROUP BY T.equipGenericName
	]]>
	</select>
			<!--施工端项目详情之设备列表 -->
	<select id="wechat_construction_project_detail">
	<![CDATA[
		DECLARE @START INT
		DECLARE @PAGE_SIZE INT
		DECLARE @PROJECT_ID BIGINT
		DECLARE @keyword VARCHAR(64)
		SET @START = ?
		SET @PAGE_SIZE =?
		SET @PROJECT_ID =?
		SET @keyword =?
		;WITH QUERY AS (
		SELECT
			E.EQUIP_ID AS equipId,
			EG.VALUE AS equipGenericName,
			ES.VALUE AS equipSpecificName,
			EI.STARTIN_DATE AS startinDate,
			ED.BUILDING_NUM AS buildingNum,
			E.EXW_SERIAL AS exwSerial,
		 	ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EF.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN T_EQUIPMENT E ON ED.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON E.EQUIP_GENERIC = EG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON E.EQUIP_SPECIFIC = ES.CODE
		WHERE ED.PROJECT_ID = @PROJECT_ID
		AND EI.DEL_FLAG = '1'
		AND ((ES.VALUE LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (E.EXW_SERIAL LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL ))
		)
		SELECT  (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	
	<!--施工端项目动态 -->
	<select id="wechat_construction_project_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
				FROM (SELECT
				AR.REPID AS relateId,
				'APP_REPAIR' AS relateModule,
				AR.PROJECT_ID AS projectId,
				AR.PROJ_NAME AS projectName,
				AR.BUILDING_NUM AS buildingNum,
				AR.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				AR.REPORT_DT AS creatyDate
		FROM T_APP_REPAIR AR
		LEFT JOIN T_EQUIPMENT E ON AR.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		UNION ALL
		SELECT
				ES.INSPECT_ID AS relateId,
				'EQUIP_INSPECT' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				ED.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				R.RECTIFY_DATE AS creatyDate
		FROM T_EQUIPMENT_INSPECT ES
		LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EI ON ES.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID 
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EI.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		LEFT JOIN T_INSPECT_RECTIFY R ON ES.INSPECT_RECTIFY_ID = R.INSPECT_RECTIFY_ID
		WHERE (ES.RECTIFICATION = '1' OR ES.RECTIFICATION = '2')
		UNION ALL
		SELECT
				EI.INSTALL_ID AS relateId,
				'EQUIP_INSTALL' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				EI.STARTIN_DATE AS creatyDate
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		WHERE EI.DEL_FLAG = '1' AND EI.APPLYFOR_STATE = '3' AND EI.APP_INSTALL_STATE = '2'
		AND EF.FLOW_STATE<6 AND EF.FLOW_STATE >= 2
		UNION ALL
		SELECT
				ED.DISMANTLE_ID AS relateId,
				'EQUIP_DISMANTLE' AS relateModule,
				EI.PROJECT_ID AS projectId,
				EI.PROJECT_NAME AS projectName,
				EI.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				ED.STARTDIS_DATE AS creatyDate
		FROM T_EQUIPMENT_DISMANTLE ED 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON ED.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EI ON EF.EQUIP_DIARY_ID = EI.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON EI.EQUIP_GENERIC = BG.CODE
		WHERE ED.DEL_FLAG = '1' AND ED.APPLYFOR_STATE = '3' AND EF.FLOW_STATE = '6'
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之安拆信息 -->
	<select id="wechat_construction_dismantling_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				EI.INSTALL_ID AS relateId,
				'EQUIP_INSTALL' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				BS.VALUE AS equipSpecificName,
				EI.STARTIN_DATE AS creatyDate
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC BS ON ED.EQUIP_SPECIFIC = BS.CODE
		WHERE EI.DEL_FLAG = '1' AND EI.APPLYFOR_STATE = '3' AND EI.APP_INSTALL_STATE = '2'
		AND EF.FLOW_STATE<6 AND EF.FLOW_STATE >= 2
		UNION ALL
		SELECT
				ED.DISMANTLE_ID AS relateId,
				'EQUIP_DISMANTLE' AS relateModule,
				EI.PROJECT_ID AS projectId,
				EI.PROJECT_NAME AS projectName,
				EI.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				BS.VALUE AS equipSpecificName,
				ED.STARTDIS_DATE AS creatyDate
		FROM T_EQUIPMENT_DISMANTLE ED 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON ED.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EI ON EF.EQUIP_DIARY_ID = EI.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON EI.EQUIP_GENERIC = BG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC BS ON EI.EQUIP_SPECIFIC = BS.CODE
		WHERE ED.DEL_FLAG = '1' AND ED.APPLYFOR_STATE = '3' AND EF.FLOW_STATE = '6'
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之整改信息 -->
	<select id="wechat_construction_inspect_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				R.INSPECT_RECTIFY_ID AS relateId,
				'EQUIP_INSPECT' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				ED.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				R.RECTIFY_DATE AS creatyDate
		FROM T_INSPECT_RECTIFY R
		LEFT JOIN T_EQUIPMENT_INSPECT ES ON R.INSPECT_ID = ES.INSPECT_ID
		LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EI ON ES.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID 
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EI.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之维修信息 -->
	<select id="wechat_construction_repair_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				AR.REPID AS relateId,
				'APP_REPAIR' AS relateModule,
				AR.PROJECT_ID AS projectId,
				AR.PROJ_NAME AS projectName,
				AR.BUILDING_NUM AS buildingNum,
				AR.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				AR.REPORT_DT AS creatyDate,
				AR.PROC_MAN AS procMan,
				AR.PROC_MAN_ID AS procManId,
				P.MOBILE AS mobile
		FROM T_APP_REPAIR AR
		LEFT JOIN T_PRACTITIONER P ON CHARINDEX(','+CONVERT(VARCHAR,P.PRACTI_ID),','+AR.PROC_MAN_ID)>0
		LEFT JOIN T_EQUIPMENT E ON AR.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目列表 -->
	<select id="wechat_construction_project_list">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT 
			P.PROJECT_ID AS projectId,
			P.PROJECT_NAME AS projectName,
			ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM T_PROJECT P
		WHERE P.DEL_FLAG = '1'
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	<!--施工端项目详情之需求设备 -->
	<select id="wechat_construction_project_equip">
	<![CDATA[
		DECLARE @PROJECT_ID BIGINT
		SET @PROJECT_ID =?
		SELECT
			SUM(T.allNum) AS allNum,
			SUM(T.disNum) AS disNum,
			T.equipGenericName
		FROM(SELECT
			1 AS allNum,
			0 AS disNum,
			BG.VALUE AS equipGenericName
		FROM T_DISPATCH D
		LEFT JOIN T_DISPATCH_EQUIP DE ON D.DISPATCH_ID = DE.DISPATCH_ID
		LEFT JOIN T_EQUIPMENT E ON DE.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		WHERE D.PROJECT_ID = @PROJECT_ID AND D.DEL_FLAG = '1'
		UNION ALL
		SELECT
			0 AS allNum,
			1 AS disNum,
			BG.VALUE AS equipGenericName
		FROM T_DISPATCH D
		LEFT JOIN T_DISPATCH_EQUIP DE ON D.DISPATCH_ID = DE.DISPATCH_ID
		LEFT JOIN T_EQUIPMENT E ON DE.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		WHERE D.PROJECT_ID = @PROJECT_ID AND D.DEL_FLAG = '1' AND D.APPLYFOR_STATE = '3')T
		GROUP BY T.equipGenericName
	]]>
	</select>
			<!--施工端项目详情之设备列表 -->
	<select id="wechat_construction_project_detail">
	<![CDATA[
		DECLARE @START INT
		DECLARE @PAGE_SIZE INT
		DECLARE @PROJECT_ID BIGINT
		DECLARE @keyword VARCHAR(64)
		SET @START = ?
		SET @PAGE_SIZE =?
		SET @PROJECT_ID =?
		SET @keyword =?
		;WITH QUERY AS (
		SELECT
			E.EQUIP_ID AS equipId,
			EG.VALUE AS equipGenericName,
			ES.VALUE AS equipSpecificName,
			EI.STARTIN_DATE AS startinDate,
			ED.BUILDING_NUM AS buildingNum,
			E.EXW_SERIAL AS exwSerial,
		 	ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EF.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN T_EQUIPMENT E ON ED.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON E.EQUIP_GENERIC = EG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON E.EQUIP_SPECIFIC = ES.CODE
		WHERE ED.PROJECT_ID = @PROJECT_ID
		AND EI.DEL_FLAG = '1'
		AND ((ES.VALUE LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (E.EXW_SERIAL LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL ))
		)
		SELECT  (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	
	<!--施工端项目动态 -->
	<select id="wechat_construction_project_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
				FROM (SELECT
				AR.REPID AS relateId,
				'APP_REPAIR' AS relateModule,
				AR.PROJECT_ID AS projectId,
				AR.PROJ_NAME AS projectName,
				AR.BUILDING_NUM AS buildingNum,
				AR.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				AR.REPORT_DT AS creatyDate
		FROM T_APP_REPAIR AR
		LEFT JOIN T_EQUIPMENT E ON AR.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		UNION ALL
		SELECT
				R.INSPECT_RECTIFY_ID AS relateId,
				'EQUIP_INSPECT' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				ED.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				R.RECTIFY_DATE AS creatyDate
		FROM T_INSPECT_RECTIFY R
		LEFT JOIN T_EQUIPMENT_INSPECT ES ON R.INSPECT_ID = ES.INSPECT_ID
		LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EI ON ES.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID 
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EI.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		UNION ALL
		SELECT
				EI.INSTALL_ID AS relateId,
				'EQUIP_INSTALL' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				EI.STARTIN_DATE AS creatyDate
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		WHERE EI.DEL_FLAG = '1' AND EI.APPLYFOR_STATE = '3' AND EI.APP_INSTALL_STATE = '2'
		AND EF.FLOW_STATE<6 AND EF.FLOW_STATE >= 2
		UNION ALL
		SELECT
				ED.DISMANTLE_ID AS relateId,
				'EQUIP_DISMANTLE' AS relateModule,
				EI.PROJECT_ID AS projectId,
				EI.PROJECT_NAME AS projectName,
				EI.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				ED.STARTDIS_DATE AS creatyDate
		FROM T_EQUIPMENT_DISMANTLE ED 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON ED.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EI ON EF.EQUIP_DIARY_ID = EI.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON EI.EQUIP_GENERIC = BG.CODE
		WHERE ED.DEL_FLAG = '1' AND ED.APPLYFOR_STATE = '3' AND EF.FLOW_STATE = '6'
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之安拆信息 -->
	<select id="wechat_construction_dismantling_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				EI.INSTALL_ID AS relateId,
				'EQUIP_INSTALL' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				BS.VALUE AS equipSpecificName,
				EI.STARTIN_DATE AS creatyDate
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC BS ON ED.EQUIP_SPECIFIC = BS.CODE
		WHERE EI.DEL_FLAG = '1' AND EI.APPLYFOR_STATE = '3' AND EI.APP_INSTALL_STATE = '2'
		AND EF.FLOW_STATE<6 AND EF.FLOW_STATE >= 2
		UNION ALL
		SELECT
				ED.DISMANTLE_ID AS relateId,
				'EQUIP_DISMANTLE' AS relateModule,
				EI.PROJECT_ID AS projectId,
				EI.PROJECT_NAME AS projectName,
				EI.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				BS.VALUE AS equipSpecificName,
				ED.STARTDIS_DATE AS creatyDate
		FROM T_EQUIPMENT_DISMANTLE ED 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON ED.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EI ON EF.EQUIP_DIARY_ID = EI.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON EI.EQUIP_GENERIC = BG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC BS ON EI.EQUIP_SPECIFIC = BS.CODE
		WHERE ED.DEL_FLAG = '1' AND ED.APPLYFOR_STATE = '3' AND EF.FLOW_STATE = '6'
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之整改信息 -->
	<select id="wechat_construction_inspect_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				ES.INSPECT_ID AS relateId,
				'EQUIP_INSPECT' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				ED.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				R.RECTIFY_DATE AS creatyDate
		FROM T_INSPECT_RECTIFY R
		LEFT JOIN T_EQUIPMENT_INSPECT ES ON R.INSPECT_ID = ES.INSPECT_ID
		LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EI ON ES.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID 
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EI.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之维修信息 -->
	<select id="wechat_construction_repair_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				AR.REPID AS relateId,
				'APP_REPAIR' AS relateModule,
				AR.PROJECT_ID AS projectId,
				AR.PROJ_NAME AS projectName,
				AR.BUILDING_NUM AS buildingNum,
				AR.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				AR.REPORT_DT AS creatyDate,
				AR.PROC_MAN AS procMan,
				AR.PROC_MAN_ID AS procManId,
				P.MOBILE AS mobile
		FROM T_APP_REPAIR AR
		LEFT JOIN T_PRACTITIONER P ON CHARINDEX(','+CONVERT(VARCHAR,P.PRACTI_ID),','+AR.PROC_MAN_ID)>0
		LEFT JOIN T_EQUIPMENT E ON AR.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目列表 -->
	<select id="wechat_construction_project_list">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT 
			P.PROJECT_ID AS projectId,
			P.PROJECT_NAME AS projectName,
			ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM T_PROJECT P
		WHERE P.DEL_FLAG = '1'
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	<!--施工端项目详情之需求设备 -->
	<select id="wechat_construction_project_equip">
	<![CDATA[
		DECLARE @PROJECT_ID BIGINT
		SET @PROJECT_ID =?
		SELECT
			SUM(T.allNum) AS allNum,
			SUM(T.disNum) AS disNum,
			T.equipGenericName
		FROM(SELECT
			1 AS allNum,
			0 AS disNum,
			BG.VALUE AS equipGenericName
		FROM T_DISPATCH D
		LEFT JOIN T_DISPATCH_EQUIP DE ON D.DISPATCH_ID = DE.DISPATCH_ID
		LEFT JOIN T_EQUIPMENT E ON DE.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		WHERE D.PROJECT_ID = @PROJECT_ID AND D.DEL_FLAG = '1'
		UNION ALL
		SELECT
			0 AS allNum,
			1 AS disNum,
			BG.VALUE AS equipGenericName
		FROM T_DISPATCH D
		LEFT JOIN T_DISPATCH_EQUIP DE ON D.DISPATCH_ID = DE.DISPATCH_ID
		LEFT JOIN T_EQUIPMENT E ON DE.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		WHERE D.PROJECT_ID = @PROJECT_ID AND D.DEL_FLAG = '1' AND D.APPLYFOR_STATE = '3')T
		GROUP BY T.equipGenericName
	]]>
	</select>
			<!--施工端项目详情之设备列表 -->
	<select id="wechat_construction_project_detail">
	<![CDATA[
		DECLARE @START INT
		DECLARE @PAGE_SIZE INT
		DECLARE @PROJECT_ID BIGINT
		DECLARE @keyword VARCHAR(64)
		SET @START = ?
		SET @PAGE_SIZE =?
		SET @PROJECT_ID =?
		SET @keyword =?
		;WITH QUERY AS (
		SELECT
			E.EQUIP_ID AS equipId,
			EG.VALUE AS equipGenericName,
			ES.VALUE AS equipSpecificName,
			EI.STARTIN_DATE AS startinDate,
			ED.BUILDING_NUM AS buildingNum,
			E.EXW_SERIAL AS exwSerial,
		 	ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EF.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN T_EQUIPMENT E ON ED.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON E.EQUIP_GENERIC = EG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON E.EQUIP_SPECIFIC = ES.CODE
		WHERE ED.PROJECT_ID = @PROJECT_ID
		AND EI.DEL_FLAG = '1'
		AND ((ES.VALUE LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (E.EXW_SERIAL LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL ))
		)
		SELECT  (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>

	<!--施工端项目动态 -->
	<select id="wechat_construction_project_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
				FROM (SELECT
				AR.REPID AS relateId,
				'APP_REPAIR' AS relateModule,
				AR.PROJECT_ID AS projectId,
				AR.PROJ_NAME AS projectName,
				AR.BUILDING_NUM AS buildingNum,
				AR.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				AR.REPORT_DT AS creatyDate
		FROM T_APP_REPAIR AR
		LEFT JOIN T_EQUIPMENT E ON AR.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		UNION ALL
		SELECT
				ES.INSPECT_ID AS relateId,
				'EQUIP_INSPECT' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				ED.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				R.RECTIFY_DATE AS creatyDate
		FROM T_INSPECT_RECTIFY R
		LEFT JOIN T_EQUIPMENT_INSPECT ES ON R.INSPECT_ID = ES.INSPECT_ID
		LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EI ON ES.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID 
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EI.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		LEFT JOIN T_INSPECT_RECTIFY R ON ES.INSPECT_RECTIFY_ID = R.INSPECT_RECTIFY_ID
		WHERE (ES.RECTIFICATION = '1' OR ES.RECTIFICATION = '2')
		UNION ALL
		SELECT
				EI.INSTALL_ID AS relateId,
				'EQUIP_INSTALL' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				EI.STARTIN_DATE AS creatyDate
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		WHERE EI.DEL_FLAG = '1' AND EI.APPLYFOR_STATE = '3' AND EI.APP_INSTALL_STATE = '2'
		AND EF.FLOW_STATE<6 AND EF.FLOW_STATE >= 2
		UNION ALL
		SELECT
				ED.DISMANTLE_ID AS relateId,
				'EQUIP_DISMANTLE' AS relateModule,
				EI.PROJECT_ID AS projectId,
				EI.PROJECT_NAME AS projectName,
				EI.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				ED.STARTDIS_DATE AS creatyDate
		FROM T_EQUIPMENT_DISMANTLE ED 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON ED.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EI ON EF.EQUIP_DIARY_ID = EI.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON EI.EQUIP_GENERIC = BG.CODE
		WHERE ED.DEL_FLAG = '1' AND ED.APPLYFOR_STATE = '3' AND EF.FLOW_STATE = '6'
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之安拆信息 -->
	<select id="wechat_construction_dismantling_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				EI.INSTALL_ID AS relateId,
				'EQUIP_INSTALL' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				BS.VALUE AS equipSpecificName,
				EI.STARTIN_DATE AS creatyDate
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC BS ON ED.EQUIP_SPECIFIC = BS.CODE
		WHERE EI.DEL_FLAG = '1' AND EI.APPLYFOR_STATE = '3' AND EI.APP_INSTALL_STATE = '2'
		AND EF.FLOW_STATE<6 AND EF.FLOW_STATE >= 2
		UNION ALL
		SELECT
				ED.DISMANTLE_ID AS relateId,
				'EQUIP_DISMANTLE' AS relateModule,
				EI.PROJECT_ID AS projectId,
				EI.PROJECT_NAME AS projectName,
				EI.BUILDING_NUM AS buildingNum,
				EF.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				BS.VALUE AS equipSpecificName,
				ED.STARTDIS_DATE AS creatyDate
		FROM T_EQUIPMENT_DISMANTLE ED 
		LEFT JOIN T_EQUIPMENT_FLOW EF ON ED.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY EI ON EF.EQUIP_DIARY_ID = EI.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON EI.EQUIP_GENERIC = BG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC BS ON EI.EQUIP_SPECIFIC = BS.CODE
		WHERE ED.DEL_FLAG = '1' AND ED.APPLYFOR_STATE = '3' AND EF.FLOW_STATE = '6'
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之整改信息 -->
	<select id="wechat_construction_inspect_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				R.INSPECT_RECTIFY_ID AS relateId,
				'EQUIP_INSPECT' AS relateModule,
				ED.PROJECT_ID AS projectId,
				ED.PROJECT_NAME AS projectName,
				ED.BUILDING_NUM AS buildingNum,
				ED.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				R.RECTIFY_DATE AS creatyDate
		FROM T_INSPECT_RECTIFY R
		LEFT JOIN T_EQUIPMENT_INSPECT ES ON R.INSPECT_ID = ES.INSPECT_ID
		LEFT JOIN T_EQUIPMENT_INSPECT_SCHEMA EI ON ES.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID 
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EI.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON ED.EQUIP_GENERIC = BG.CODE
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目动态之维修信息 -->
	<select id="wechat_construction_repair_dynamic">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT T.*,ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM (
		SELECT
				AR.REPID AS relateId,
				'APP_REPAIR' AS relateModule,
				AR.PROJECT_ID AS projectId,
				AR.PROJ_NAME AS projectName,
				AR.BUILDING_NUM AS buildingNum,
				AR.EQUIP_ID AS equipId,
				BG.VALUE AS equipGenericName,
				AR.REPORT_DT AS creatyDate,
				AR.PROC_MAN AS procMan,
				AR.PROC_MAN_ID AS procManId,
				P.MOBILE AS mobile
		FROM T_APP_REPAIR AR
		LEFT JOIN T_PRACTITIONER P ON CHARINDEX(','+CONVERT(VARCHAR,P.PRACTI_ID),','+AR.PROC_MAN_ID)>0
		LEFT JOIN T_EQUIPMENT E ON AR.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		)T 
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
		ORDER BY QUERY.creatyDate DESC
	]]>
	</select>
	<!--施工端项目列表 -->
	<select id="wechat_construction_project_list">
	<![CDATA[
		DECLARE @START INT
        DECLARE @PAGE_SIZE INT
		SET @START = ?
   	    SET @PAGE_SIZE =?
		;WITH QUERY AS (
		SELECT 
			P.PROJECT_ID AS projectId,
			P.PROJECT_NAME AS projectName,
			ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM T_PROJECT P
		WHERE P.DEL_FLAG = '1'
		 )
		SELECT (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
	<!--施工端项目详情之需求设备 -->
	<select id="wechat_construction_project_equip">
	<![CDATA[
		DECLARE @PROJECT_ID BIGINT
		SET @PROJECT_ID =?
		SELECT
			SUM(T.allNum) AS allNum,
			SUM(T.disNum) AS disNum,
			T.equipGenericName
		FROM(SELECT
			1 AS allNum,
			0 AS disNum,
			BG.VALUE AS equipGenericName
		FROM T_DISPATCH D
		LEFT JOIN T_DISPATCH_EQUIP DE ON D.DISPATCH_ID = DE.DISPATCH_ID
		LEFT JOIN T_EQUIPMENT E ON DE.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		WHERE D.PROJECT_ID = @PROJECT_ID AND D.DEL_FLAG = '1'
		UNION ALL
		SELECT
			0 AS allNum,
			1 AS disNum,
			BG.VALUE AS equipGenericName
		FROM T_DISPATCH D
		LEFT JOIN T_DISPATCH_EQUIP DE ON D.DISPATCH_ID = DE.DISPATCH_ID
		LEFT JOIN T_EQUIPMENT E ON DE.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC BG ON E.EQUIP_GENERIC = BG.CODE
		WHERE D.PROJECT_ID = @PROJECT_ID AND D.DEL_FLAG = '1' AND D.APPLYFOR_STATE = '3')T
		GROUP BY T.equipGenericName
	]]>
	</select>
	<!--施工端项目详情之设备列表 -->
	<select id="wechat_construction_project_detail">
	<![CDATA[
		DECLARE @START INT
		DECLARE @PAGE_SIZE INT
		DECLARE @PROJECT_ID BIGINT
		DECLARE @keyword VARCHAR(64)
		SET @START = ?
		SET @PAGE_SIZE =?
		SET @PROJECT_ID =?
		SET @keyword =?
		;WITH QUERY AS (
		SELECT
			E.EQUIP_ID AS equipId,
			EG.VALUE AS equipGenericName,
			ES.VALUE AS equipSpecificName,
			EI.STARTIN_DATE AS startinDate,
			ED.BUILDING_NUM AS buildingNum,
			E.EXW_SERIAL AS exwSerial,
		 	ROW_NUMBER() OVER (ORDER BY CURRENT_TIMESTAMP) AS _ROWNUM
		FROM T_EQUIPMENT_INSTALL EI
		LEFT JOIN T_EQUIPMENT_FLOW EF ON EI.FLOW_ID = EF.FLOW_ID
		LEFT JOIN T_EQUIPMENT_DIARY ED ON EF.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		LEFT JOIN T_EQUIPMENT E ON ED.EQUIP_ID = E.EQUIP_ID
		LEFT JOIN BM_EQUIP_GENERIC EG ON E.EQUIP_GENERIC = EG.CODE
		LEFT JOIN BM_EQUIP_SPECIFIC ES ON E.EQUIP_SPECIFIC = ES.CODE
		WHERE ED.PROJECT_ID = @PROJECT_ID
		AND EI.DEL_FLAG = '1' AND EI.APPLYFOR_STATE = '3' AND EI.APP_INSTALL_STATE = '2'
		AND EF.FLOW_STATE<6 AND EF.FLOW_STATE >= 2
		AND ((ES.VALUE LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL )
		OR (E.EXW_SERIAL LIKE '%'+@keyword+'%' OR @keyword = '' OR @keyword IS NULL ))
		)
		SELECT  (SELECT COUNT(*) FROM QUERY) AS 'count',* FROM QUERY WHERE _ROWNUM > @START AND _ROWNUM <= (@START + @PAGE_SIZE)	
	]]>
	</select>
		<!--pc端加节明细 -->
	<select id="pc_add_detail">
	<![CDATA[
		DECLARE @ADDREDUCEID BIGINT
		SET @ADDREDUCEID =?
		SELECT 
           BEG.VALUE AS equipGeneric,
           BES.VALUE AS equipSpecific,
           EARD.KNOT_NUM AS knotNum,
           EARD.WALL_ATTACHE_NUM AS wallAttacheNum,
           EARD.WALL_ATTACHE_POLE_NUM AS wallAttachePoleNum,
           EARD.WALL_ATTACHE_FRAME_NUM AS wallAttacheFrameNum,
           EARD.EXECUTER_NAME AS executerName,
           EARD.EXECUTE_DATE AS executeDate,
           EARD.RELATE_MODULE AS relateModule,
           EARD.RELATE_ID AS relateId,
           ED.PROJECT_NAME AS projectName,
           E.EXW_SERIAL AS exwSerial,
           E.EQUIP_SERIAL AS equipSerial,
           E.RECORD_SERIAL AS recordSerial,
           CL.CONTRACT_SERIAL AS contractSerial,
           EI.FILE_ATTACHES AS fileAttaches,
           EI.CHECK_ATTACH AS checkAttaches
    FROM T_EQUIP_ADD_REDUCE_DETAIL EARD
    LEFT JOIN T_EQUIPMENT_INSTALL EI ON EI.INSTALL_ID = EARD.RELATE_ID
    LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.INSTALL_ID = EI.INSTALL_ID
    LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
    LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = ED.EQUIP_ID
    LEFT JOIN BM_EQUIP_GENERIC BEG ON BEG.CODE = E.EQUIP_GENERIC
    LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = E.EQUIP_SPECIFIC
    LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = ED.CONTRACT_ID
       WHERE EARD.ADD_REDUCE_ID = @ADDREDUCEID
       AND EARD.RELATE_MODULE = 'EQUIP_INSTALL_ADD'
	]]>
	</select>
	<select id="pc_reduce_detail">
	<![CDATA[
		DECLARE @ADDREDUCEID BIGINT
		SET @ADDREDUCEID =?
		SELECT 
           BEG.VALUE AS equipGeneric,
           BES.VALUE AS equipSpecific,
           EARD.KNOT_NUM AS knotNum,
           EARD.WALL_ATTACHE_NUM AS wallAttacheNum,
           EARD.WALL_ATTACHE_POLE_QTY AS wallAttachePoleQty,
           EARD.WALL_ATTACHE_FRAME_QTY AS wallAttacheFrameQty,
           EARD.EXECUTER_NAME AS executerName,
           EARD.EXECUTE_DATE AS executeDate,
           EARD.RELATE_MODULE AS relateModule,
           EARD.RELATE_ID AS relateId,
           ED.PROJECT_NAME AS projectName,
           E.EXW_SERIAL AS exwSerial,
           E.EQUIP_SERIAL AS equipSerial,
           E.RECORD_SERIAL AS recordSerial,
           CL.CONTRACT_SERIAL AS contractSerial,
           EI.FILE_ATTACHES AS fileAttaches,
           EI.CHECK_ATTACH AS checkAttaches
    FROM T_EQUIP_ADD_REDUCE_DETAIL EARD
    LEFT JOIN T_EQUIPMENT_INSTALL EI ON EI.INSTALL_ID = EARD.RELATE_ID
    LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.INSTALL_ID = EI.INSTALL_ID
    LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
    LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = ED.EQUIP_ID
    LEFT JOIN BM_EQUIP_GENERIC BEG ON BEG.CODE = E.EQUIP_GENERIC
    LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = E.EQUIP_SPECIFIC
    LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = ED.CONTRACT_ID
       WHERE EARD.ADD_REDUCE_ID = @ADDREDUCEID
       AND EARD.RELATE_MODULE = 'EQUIP_DISMANTLE'
	]]>
	</select>
	<!--pc端整改验收明细 -->
	<select id="pc_rectify_review_detail">
	<![CDATA[
		DECLARE @REVIEWID BIGINT
		SET @REVIEWID =?
		SELECT 
           BEG.VALUE AS equipGeneric,
           BES.VALUE AS equipSpecific,
           IR.REVIW_CHECK_ATTACH AS reviewCheckAttach,
           IR.REVIEW_CONCLUSION AS reviewConclusion,
           IR.REVIE_STATUS AS reviewStatus,
           IR.REJECT_REASON AS rejectReason,
           IR.RELATE_ID AS relateId,
           IR.RELATE_MODULE AS relateModule,
           ED.PROJECT_NAME AS projectName,
           ED.EXW_SERIAL AS exwSerial,
           ED.EQUIP_SERIAL AS equipSerial,
           ED.RECORD_SERIAL AS recordSerial,
           CL.CONTRACT_SERIAL AS contractSerial,
           EI.FILE_ATTACHES AS fileAttaches,
           EI.CHECK_ATTACH AS checkAttaches
    FROM T_INSTALL_REVIEW IR
    LEFT JOIN T_EQUIPMENT_INSTALL EI ON EI.INSTALL_ID = IR.RELATE_ID
    LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = EI.FLOW_ID
    LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
    LEFT JOIN BM_EQUIP_GENERIC BEG ON BEG.CODE = ED.EQUIP_GENERIC
    LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = ED.EQUIP_SPECIFIC
    LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = ED.CONTRACT_ID
       WHERE IR.REVIEW_ID = @REVIEWID
			 AND IR.RELATE_MODULE ='EQUIP_INSTALL'
			 UNION ALL
			 SELECT 
           BEG.VALUE AS equipGeneric,
           BES.VALUE AS equipSpecific,
           IR.REVIW_CHECK_ATTACH AS reviewCheckAttach,
           IR.REVIEW_CONCLUSION AS reviewConclusion,
           IR.REVIE_STATUS AS reviewStatus,
           IR.REJECT_REASON AS rejectReason,
           IR.RELATE_ID AS relateId,
           IR.RELATE_MODULE AS relateModule,
           ED.PROJECT_NAME AS projectName,
           ED.EXW_SERIAL AS exwSerial,
           ED.EQUIP_SERIAL AS equipSerial,
           ED.RECORD_SERIAL AS recordSerial,
           CL.CONTRACT_SERIAL AS contractSerial,
           EDI.FILE_ATTACHES AS fileAttaches,
           EDI.CHECK_ATTACH AS checkAttaches
    FROM T_INSTALL_REVIEW IR
    LEFT JOIN T_EQUIPMENT_DISMANTLE EDI ON EDI.DISMANTLE_ID = IR.RELATE_ID
    LEFT JOIN T_EQUIPMENT_FLOW EF ON EF.FLOW_ID = EDI.FLOW_ID
    LEFT JOIN T_EQUIPMENT_DIARY ED ON ED.EQUIP_DIARY_ID = EF.EQUIP_DIARY_ID
    LEFT JOIN BM_EQUIP_GENERIC BEG ON BEG.CODE = ED.EQUIP_GENERIC
    LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = ED.EQUIP_SPECIFIC
    LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = ED.CONTRACT_ID
       WHERE IR.REVIEW_ID = @REVIEWID
			 AND IR.RELATE_MODULE ='EQUIP_DISMANTLE'
	]]>
	</select>
	<!--pc端安全交底明细 -->
	<select id="pc_technical_disclosure_detail">
	<![CDATA[
		DECLARE @DISCLOSUREID BIGINT
		SET @DISCLOSUREID =?
		SELECT 
           BEG.VALUE AS equipGeneric,
           BES.VALUE AS equipSpecific,
           TD.ACCEPTANCE_MAN AS acceptMan,
		   TD.DISCLOSURE_MAN AS disclosureMan,
           TD.DISCLOSURE_DATE AS disclosureDate,
           TD.DISCLOSURE_PHOTO AS disclosurePhoto,
           TD.RELATE_ID AS relateId,
           TD.RELATE_MODULE AS relateModule,
           P.PROJECT_NAME AS projectName,
           E.EXW_SERIAL AS exwSerial,
           E.EQUIP_SERIAL AS equipSerial,
           E.RECORD_SERIAL AS recordSerial,
           CL.CONTRACT_SERIAL AS contractSerial
    FROM T_TECHNICAL_DISCLOSURE TD
    LEFT JOIN T_EQUIPMENT E ON E.EQUIP_ID = TD.EQUIP_ID
	LEFT JOIN T_PROJECT P ON P.PROJECT_ID = TD.PROJECT_ID
    LEFT JOIN BM_EQUIP_GENERIC BEG ON BEG.CODE = E.EQUIP_GENERIC
    LEFT JOIN BM_EQUIP_SPECIFIC BES ON BES.CODE = E.EQUIP_SPECIFIC
    LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = TD.CONTRACT_ID
       WHERE TD.DISCLOSURE_ID = @DISCLOSUREID
	]]>
	</select>
	<!--pc端顶升加节列表 -->
	<select id="pc_equip_add_detail">
	<![CDATA[
		SELECT EARD.*
      FROM T_EQUIP_ADD_REDUCE_DETAIL EARD
      WHERE EARD.RELATE_MODULE = 'EQUIP_INSTALL'
	]]>
	</select>
		<!--pc端拆卸降节列表 -->
	<select id="pc_equip_reduce_detail">
	<![CDATA[
		SELECT EARD.*
      FROM T_EQUIP_ADD_REDUCE_DETAIL EARD
      WHERE EARD.RELATE_MODULE = 'EQUIP_DISMANTLE'
	]]>
	</select>
</mapper>