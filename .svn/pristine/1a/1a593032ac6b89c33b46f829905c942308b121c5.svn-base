<?xml version="1.0" encoding="UTF-8"?>
<mapper namespace="remaind">
	<!-- 企业设备信息 -->
	<select id="default_equip_corpremaind">
	<![CDATA[
		SELECT E.RECORD_ID, E.STATUS, E.EQUIP_ID, CI.DUTYMAN, CI.DUTYMAN_TEL1 DUTYMAN_TEL,CI.DUTYMAN_TEL1 DUTYMAN_TEL1,CI.DUTYMAN_TEL2 DUTYMAN_TEL2,CI.DUTYMAN_TEL3 DUTYMAN_TEL3, CI.FINANCE, CI.FINANCE_TEL, CI.CAPITAL, CI.CAPITAL_TEL
		  FROM T_EQUIPMENT E, T_CORP_INFO CI
		 WHERE E.DEL_FLAG = '1'
		   AND CI.DEL_FLAG = '1'
		   AND CI.CORP_STATUS = '1'
		   AND E.PROPERTY_ENT = CI.CORP_ID
	]]>
	</select>
	<!-- 合同设备信息 -->
	<select id="default_equip_contractremaind">
	<![CDATA[
		SELECT E.RECORD_ID, DE.EQUIP_ID, DE.END_DATE, E.PROPERTY_ENT, CL.CONTRACT_SERIAL, CL.SALESMAN, CL.SALESMAN_TEL, CL.PA_ENT_LINK_MAN, CL.PA_ENT_LINK_TEL
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D, T_CONTRACT_LEASE CL, T_EQUIPMENT E
		 WHERE DE.WORK_STATUS < '2'
		   AND D.APPLYFOR_STATE = '3'
		   AND D.RELATE_MODULE = 'CONTRACT_LEASE'
		   AND D.RELATE_ID = CL.CONTRACT_ID
		   AND DE.DISPATCH_ID = D.DISPATCH_ID
		   AND DE.EQUIP_ID = E.EQUIP_ID
	]]>
	</select>
	<!-- 采购单联系人信息 -->
	<select id="default_purchase_remainduser">
	<![CDATA[
		SELECT P.PURCHASE_ID, P.PUR_CORP_ID, P.APPLYFOR_STATE, P.ARRIVAL_DATE, P.PURCHASE_SERIAL, P.PURCHASE_THEME, CI.DUTYMAN REMAIND_NAME, CI.DUTYMAN_TEL1 REMAIND_TEL
		  FROM T_CORP_INFO CI, T_PURCHASE P
		 WHERE CI.CORP_ID = P.PUR_CORP_ID
		UNION ALL
		SELECT P.PURCHASE_ID, P.PUR_CORP_ID, P.APPLYFOR_STATE, P.ARRIVAL_DATE, P.PURCHASE_SERIAL, P.PURCHASE_THEME, CI.FINANCE REMAIND_NAME, CI.FINANCE_TEL REMAIND_TEL
		  FROM T_CORP_INFO CI, T_PURCHASE P
		 WHERE CI.CORP_ID = P.PUR_CORP_ID
		UNION ALL
		SELECT P.PURCHASE_ID, P.PUR_CORP_ID, P.APPLYFOR_STATE, P.ARRIVAL_DATE, P.PURCHASE_SERIAL, P.PURCHASE_THEME, CI.CAPITAL REMAIND_NAME, CI.CAPITAL_TEL REMAIND_TEL
		  FROM T_CORP_INFO CI, T_PURCHASE P
		 WHERE CI.CORP_ID = P.PUR_CORP_ID
		UNION ALL
		SELECT P.PURCHASE_ID, P.PUR_CORP_ID, P.APPLYFOR_STATE, P.ARRIVAL_DATE, P.PURCHASE_SERIAL, P.PURCHASE_THEME, P.PURCHASER_NAME REMAIND_NAME, P.PURCHASER_MOBILE REMAIND_TEL
		  FROM T_PURCHASE P
	]]>
	</select>
	<!-- 合同设备分类统计-设备数量是否充足 -->
	<select id="contract_equip_adequate_check">
	<![CDATA[
		DECLARE @CONTRACT_ID BIGINT
		SET @CONTRACT_ID = ?
		SELECT B.ASK_QUANTITY, B.EXISTS_QUANTITY, B.EQUIP_CATEGORY, C.VALUE EQUIP_CATEGORY_NAME
		  FROM (SELECT SUM(A.ASK_QUANTITY) ASK_QUANTITY, SUM(A.EXISTS_QUANTITY) EXISTS_QUANTITY, A.EQUIP_CATEGORY
		          FROM (SELECT COUNT(*) ASK_QUANTITY, 0 EXISTS_QUANTITY, EQUIP_CATEGORY
		                  FROM T_CONTRACT_EQUIP
		                 WHERE CONTRACT_ID = @CONTRACT_ID
		                 GROUP BY EQUIP_CATEGORY
		                UNION ALL
		                SELECT SUM(QUANTITY) ASK_QUANTITY, 0 EXISTS_QUANTITY, EQUIP_CATEGORY
		                  FROM T_CONTRACT_EQUIP_BRIEF
		                 WHERE CONTRACT_ID = @CONTRACT_ID
		                 GROUP BY EQUIP_CATEGORY
		                UNION ALL
		                SELECT 0 ASK_QUANTITY, COUNT(*) EXISTS_QUANTITY, EQUIP_CATEGORY
		                  FROM T_EQUIPMENT
		                 WHERE STATUS = '1'
		                   AND DEL_FLAG = '1'
		                 GROUP BY EQUIP_CATEGORY) AS A
		         GROUP BY A.EQUIP_CATEGORY) B
		  LEFT JOIN BM_REPERTORY_CATEGORY C ON B.EQUIP_CATEGORY = C.CODE
		 WHERE B.ASK_QUANTITY > B.EXISTS_QUANTITY
	]]>
	</select>
	<!-- 合同设备数量不足提醒 -->
	<!--<select id="contract_equip_lack">
        <![CDATA[
            DECLARE @CORP_ID BIGINT
            DECLARE @CONTRACT_ID BIGINT
            DECLARE @MESSAGE VARCHAR(1000)
            SET @CORP_ID = ?
            SET @CONTRACT_ID = ?
            SET @MESSAGE = ?
            INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
            SELECT A.REMAIND_NAME, A.REMAIND_TEL, @MESSAGE MESSAGE, '系统消息', '0', GETDATE()
              FROM (SELECT CI.DUTYMAN REMAIND_NAME, CI.DUTYMAN_TEL1 REMAIND_TEL FROM T_CORP_INFO CI WHERE CI.CORP_ID = @CORP_ID AND CI.DUTYMAN_TEL1 IS NOT NULL
                    UNION ALL
                    SELECT CI.DUTYMAN REMAIND_NAME, CI.DUTYMAN_TEL2 REMAIND_TEL FROM T_CORP_INFO CI WHERE CI.CORP_ID = @CORP_ID AND CI.DUTYMAN_TEL2 IS NOT NULL
                    UNION ALL
                    SELECT CI.DUTYMAN REMAIND_NAME, CI.DUTYMAN_TEL3 REMAIND_TEL FROM T_CORP_INFO CI WHERE CI.CORP_ID = @CORP_ID AND CI.DUTYMAN_TEL3 IS NOT NULL
                    UNION ALL
                    SELECT CI.CAPITAL REMAIND_NAME, CI.CAPITAL_TEL REMAIND_TEL FROM T_CORP_INFO CI WHERE CI.CORP_ID = @CORP_ID
                    UNION ALL
                    SELECT CL.SALESMAN REMAIND_NAME, CL.SALESMAN_TEL REMAIND_TEL FROM T_CONTRACT_LEASE CL WHERE CL.CONTRACT_ID = @CONTRACT_ID) A
             WHERE A.REMAIND_TEL IS NOT NULL
        ]]>
        </select>-->
	<!-- 合同设备调度完成提醒 -->
	<select id="dispatch_contract_approve" properties="default_equip_corpremaind">
	<![CDATA[
		DECLARE @DISPATCH_ID BIGINT
		DECLARE @CONTRACT_SERIAL VARCHAR(24)
		DECLARE @CONTRACT_THEME VARCHAR(24)
		SET @DISPATCH_ID = ?
		SET @CONTRACT_SERIAL = ?
		SET @CONTRACT_THEME = ?;
		WITH EQUIP_CORP AS ( #default_equip_corpremaind# )
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '合同编号:' + @CONTRACT_SERIAL + ',主题:' + @CONTRACT_THEME + '已完成调度,备案号为 ' + A.RECORD_ID + ' 的设备，将于 ' + A.START_DATE + ' 进场,请提前做好相关准备工作.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT CONVERT(CHAR(10), DE.START_DATE, 23) START_DATE, E.RECORD_ID, EC.DUTYMAN REMAIND_NAME, EC.DUTYMAN_TEL REMAIND_TEL FROM EQUIP_CORP EC, T_DISPATCH_EQUIP DE, T_EQUIPMENT E WHERE EC.EQUIP_ID = DE.EQUIP_ID AND DE.DISPATCH_ID = @DISPATCH_ID AND DE.EQUIP_ID = E.EQUIP_ID
		        UNION ALL
		        SELECT CONVERT(CHAR(10), DE.START_DATE, 23) START_DATE, E.RECORD_ID, EC.CAPITAL REMAIND_NAME, EC.CAPITAL_TEL REMAIND_TEL FROM EQUIP_CORP EC, T_DISPATCH_EQUIP DE, T_EQUIPMENT E WHERE EC.EQUIP_ID = DE.EQUIP_ID AND DE.DISPATCH_ID = @DISPATCH_ID AND DE.EQUIP_ID = E.EQUIP_ID
		        UNION ALL
		        SELECT CONVERT(CHAR(10), DE.START_DATE, 23) START_DATE, E.RECORD_ID, EC.FINANCE REMAIND_NAME, EC.FINANCE_TEL REMAIND_TEL FROM EQUIP_CORP EC, T_DISPATCH_EQUIP DE, T_EQUIPMENT E WHERE EC.EQUIP_ID = DE.EQUIP_ID AND DE.DISPATCH_ID = @DISPATCH_ID AND DE.EQUIP_ID = E.EQUIP_ID
		        UNION ALL
		        SELECT CONVERT(CHAR(10), DE.START_DATE, 23) START_DATE, E.RECORD_ID, CL.SALESMAN REMAIND_NAME, CL.SALESMAN_TEL REMAIND_TEL
				  FROM T_CONTRACT_LEASE CL, T_DISPATCH D, T_DISPATCH_EQUIP DE, T_EQUIPMENT E
				 WHERE CL.CONTRACT_ID = D.RELATE_ID
				   AND D.DISPATCH_ID = DE.DISPATCH_ID
				   AND DE.DISPATCH_ID = @DISPATCH_ID
				   AND DE.EQUIP_ID = E.EQUIP_ID
		        UNION ALL
		        SELECT CONVERT(CHAR(10), DE.START_DATE, 23) START_DATE, E.RECORD_ID, AU.FULLNAME REMAIND_NAME, AU.MOBILE REMAIND_TEL
				  FROM APP_USER AU, T_DISPATCH D, T_DISPATCH_EQUIP DE, T_EQUIPMENT E
				 WHERE AU.USERID = D.USER_ID
				   AND D.DISPATCH_ID = DE.DISPATCH_ID
				   AND DE.DISPATCH_ID = @DISPATCH_ID
				   AND DE.EQUIP_ID = E.EQUIP_ID ) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 借用归还验收提醒 -->
	<select id="borrow_acc">
	<![CDATA[
		DECLARE @BORROW_ID BIGINT
		DECLARE @MESSAGE VARCHAR(1000)
		SET @BORROW_ID = ?
		SET @MESSAGE = ?
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, @MESSAGE MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT B.IN_HANDLER REMAIND_NAME, B.IN_PHONE REMAIND_TEL FROM T_BORROW B WHERE B.BORROW_ID = @BORROW_ID
				UNION ALL
				SELECT B.OUT_HANDLER REMAIND_NAME, B.OUT_PHONE REMAIND_TEL FROM T_BORROW B WHERE B.BORROW_ID = @BORROW_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 采购单生效提醒 -->
	<select id="purchase_approve" properties="default_purchase_remainduser">
	<![CDATA[
		DECLARE @PURCHASE_ID BIGINT
		DECLARE @PURCHASE_SERIAL VARCHAR(24)
		DECLARE @PURCHASE_THEME VARCHAR(24)
		DECLARE @PAYFOR_DATE CHAR(10)
		SET @PURCHASE_ID = ?
		SET @PURCHASE_SERIAL = ?
		SET @PURCHASE_THEME = ?
		SET @PAYFOR_DATE = ?;
		WITH PURCHASE_REMAINDUSER AS ( #default_purchase_remainduser# )
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '采购单号:' + @PURCHASE_SERIAL + ',主题:' + @PURCHASE_THEME + ' 的采购申请已审批通过，首期款项计划于 ' + @PAYFOR_DATE + '（第1期的时间）支付，请注意及时跟进到货进度。' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT PR.REMAIND_NAME, PR.REMAIND_TEL FROM PURCHASE_REMAINDUSER PR WHERE PR.PURCHASE_ID = @PURCHASE_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 采购单验收提醒 -->
	<select id="purchase_acc" properties="default_purchase_remainduser">
	<![CDATA[
		DECLARE @PURCHASE_ID BIGINT
		DECLARE @MESSAGE VARCHAR(1000)
		SET @PURCHASE_ID = ?
		SET @MESSAGE = ?;
		WITH PURCHASE_REMAINDUSER AS ( #default_purchase_remainduser# )
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, @MESSAGE MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT PR.REMAIND_NAME, PR.REMAIND_TEL FROM PURCHASE_REMAINDUSER PR WHERE PR.PURCHASE_ID = @PURCHASE_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 设备安装审批完成提醒 -->
	<select id="equipinstall_approve" properties="default_equip_corpremaind">
	<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		DECLARE @ENDIN_DATE CHAR(10)
		SET @EQUIP_ID = ?
		SET @ENDIN_DATE = ?;
		WITH EQUIP_CORP AS ( #default_equip_corpremaind# )
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '备案号为 ' + A.RECORD_ID + ' 的设备，将于 ' + @ENDIN_DATE + ' 安装完成，请知悉。' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT EC.RECORD_ID, EC.DUTYMAN REMAIND_NAME, EC.DUTYMAN_TEL1 REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID AND EC.DUTYMAN_TEL1 IS NOT NULL
		        UNION ALL
		        SELECT EC.RECORD_ID, EC.DUTYMAN REMAIND_NAME, EC.DUTYMAN_TEL2 REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID AND EC.DUTYMAN_TEL2 IS NOT NULL
		        UNION ALL
		        SELECT EC.RECORD_ID, EC.DUTYMAN REMAIND_NAME, EC.DUTYMAN_TEL3 REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID AND EC.DUTYMAN_TEL3 IS NOT NULL
		        UNION ALL
		        SELECT EC.RECORD_ID, EC.CAPITAL REMAIND_NAME, EC.CAPITAL_TEL REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL		
	]]>
	</select>
	<!-- 设备拆卸审批完成提醒 -->
	<select id="equipdismantle_approve" properties="default_equip_corpremaind">
	<![CDATA[
		DECLARE @DISMANTLE_ID BIGINT
		DECLARE @EQUIP_ID BIGINT
		DECLARE @ENDIN_DATE CHAR(10)
		DECLARE @RECORD_ID VARCHAR(32)
		SET @DISMANTLE_ID = ?
		SET @EQUIP_ID = ?
		SET @ENDIN_DATE = ?
		SET @RECORD_ID = ?;
		WITH EQUIP_CORP AS ( #default_equip_corpremaind# )
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '备案号为 ' + @RECORD_ID + ' 的设备，将于 ' + @ENDIN_DATE + ' 拆卸完成，请知悉。' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT EC.DUTYMAN REMAIND_NAME, EC.DUTYMAN_TEL1 REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID AND EC.DUTYMAN_TEL1 IS NOT NULL
		        UNION ALL
		        SELECT EC.DUTYMAN REMAIND_NAME, EC.DUTYMAN_TEL2 REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID AND EC.DUTYMAN_TEL2 IS NOT NULL
		        UNION ALL
		        SELECT EC.DUTYMAN REMAIND_NAME, EC.DUTYMAN_TEL3 REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID AND EC.DUTYMAN_TEL3 IS NOT NULL
		        UNION ALL
		        SELECT EC.CAPITAL REMAIND_NAME, EC.CAPITAL_TEL REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID
		        UNION ALL
		        SELECT CL.SALESMAN REMAIND_NAME, CL.SALESMAN_TEL REMAIND_TEL FROM T_EQUIPMENT_FLOW EF, T_CONTRACT_LEASE CL WHERE CL.CONTRACT_ID = EF.CONTRACT_ID AND EF.DISMANTLE_ID = @DISMANTLE_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 开票提醒 -->
	<select id="invoice_issue_approve">
	<![CDATA[
		DECLARE @INVOICE_ISSUE_ID BIGINT
		SET @INVOICE_ISSUE_ID = ?
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '开票名称' + A.INVOICE_THEME + '开票金额为' + CONVERT(VARCHAR(20), A.ISSUE_AMOUNT) + '的票据已开据,票据状态为' + A.ISSUE_STATUS + ',请知悉.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT P.PRACTI_NAME REMAIND_NAME, P.MOBILE REMAIND_TEL, II.INVOICE_THEME, II.ISSUE_AMOUNT, CASE II.ISSUE_STATUS WHEN '2' THEN '完成' ELSE '未完成' END ISSUE_STATUS
				  FROM T_INVOICE_ISSUE II, T_PRACTITIONER P
				 WHERE II.INVOICE_ISSUE_ID = @INVOICE_ISSUE_ID
				   AND II.ISSUE_PRACTI_ID = P.PRACTI_ID
				   AND P.DEL_FLAG = '1'
				UNION ALL
				SELECT CI.DUTYMAN REMAIND_NAME, ISNULL(CI.DUTYMAN_TEL1, ISNULL(CI.DUTYMAN_TEL2, CI.DUTYMAN_TEL3)) REMAIND_TEL, II.INVOICE_THEME, II.ISSUE_AMOUNT, CASE II.ISSUE_STATUS WHEN '2' THEN '完成' ELSE '未完成' END ISSUE_STATUS
				  FROM T_INVOICE_ISSUE II, T_CORP_INFO CI
				 WHERE II.INVOICE_ISSUE_ID = @INVOICE_ISSUE_ID
				   AND II.HANDLE_ENT_ID = CI.CORP_ID
				   AND CI.DEL_FLAG = '1') A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 收款提醒 -->
	<select id="amount_receive_approve">
	<![CDATA[
		DECLARE @AMOUNT_RECEIVE_ID BIGINT
		SET @AMOUNT_RECEIVE_ID = ?
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, A.PAYMENT_NAME + '客户,于' + A.RECEIVE_DATE + '回款' + CONVERT(VARCHAR(20), A.RECEIVE_AMOUNT) + '元,回款状态:' + RECEIVE_STATUS + ',应收款额' + CONVERT(VARCHAR(20), A.RECEIVABLE_DEBIT) + ',请知悉' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT CI.DUTYMAN REMAIND_NAME, ISNULL(CI.DUTYMAN_TEL1, ISNULL(CI.DUTYMAN_TEL2, CI.DUTYMAN_TEL3)) REMAIND_TEL, AR.PAYMENT_NAME, AR.RECEIVE_DATE, AR.RECEIVE_AMOUNT, AR.RECEIVABLE_DEBIT, CASE AR.RECEIVE_STATUS WHEN '1' THEN '完成' ELSE '未完成' END RECEIVE_STATUS
				  FROM T_AMOUNT_RECEIVE AR, T_CORP_INFO CI
				 WHERE AR.AMOUNT_RECEIVE_ID = @AMOUNT_RECEIVE_ID
				   AND AR.RECEIVE_ENT_ID = CI.CORP_ID
				UNION ALL
				SELECT CI.FINANCE REMAIND_NAME, CI.FINANCE_TEL REMAIND_TEL, AR.PAYMENT_NAME, AR.RECEIVE_DATE, AR.RECEIVE_AMOUNT, AR.RECEIVABLE_DEBIT, CASE AR.RECEIVE_STATUS WHEN '1' THEN '完成' ELSE '未完成' END RECEIVE_STATUS
				  FROM T_AMOUNT_RECEIVE AR, T_CORP_INFO CI
				 WHERE AR.AMOUNT_RECEIVE_ID = @AMOUNT_RECEIVE_ID
				   AND AR.RECEIVE_ENT_ID = CI.CORP_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 薪资提醒 -->
	<select id="salary_approve">
	<![CDATA[
		DECLARE @SALARY_ID BIGINT
		SET @SALARY_ID = ?
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '亲爱的' + A.REMAIND_NAME + ', 感谢你辛苦的工作,' + A.SALARY_MONTH + '工资发放已经审批通过，您本月实发工资为' + CONVERT(VARCHAR(20), A.FINAL_AMOUNT) + '元，具体以到帐额为准.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT SP.SALARY_MONTH, SP.PRACTI_NAME REMAIND_NAME, SP.PRACTI_TEL REMAIND_TEL, SP.FINAL_AMOUNT FROM T_SALARY_PRACTI SP WHERE SP.SALARY_ID = @SALARY_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 借款通过提醒 -->
	<select id="money_lend_approve">
	<![CDATA[
		DECLARE @LEND_ID BIGINT
		SET @LEND_ID = ?
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '你申请的借款单号' + A.LEND_SERIAL + '已审批通过,请及时领取相关款项.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT ML.PRACTI_NAME REMAIND_NAME, ML.PRACTI_TEL REMAIND_TEL, ML.LEND_SERIAL FROM T_MONEY_LEND ML WHERE ML.LEND_ID = @LEND_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- ####################################################################计划任务提醒############################################################### -->
	<!-- 企业资质到期提醒 -->
	<select id="schedule_corpcert_dueto">
	<![CDATA[
		DECLARE @END_DATE CHAR(10)
		SET @END_DATE = ?
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '资质编号:' + A.CERT_NUM + ',将于' + @END_DATE + '到期，请提前安排办理相关手续.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT CC.CERT_NUM,
		               CI.DUTYMAN REMAIND_NAME,
		               ISNULL(CI.DUTYMAN_TEL1, ISNULL(CI.DUTYMAN_TEL2, CI.DUTYMAN_TEL3)) REMAIND_TEL
		          FROM T_CORP_CERT CC, T_CORP_INFO CI
		         WHERE CC.ISVALID = '1'
		           AND CC.DEL_FLAG = '1'
		           AND CI.CORP_STATUS = '1'
		           AND CI.DEL_FLAG = '1'
		           AND CC.CORP_ID = CI.CORP_ID
		           AND CC.END_DATE = @END_DATE) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 人员资质到期提醒 -->
	<select id="schedule_practicert_dueto">
	<![CDATA[
		DECLARE @END_DATE CHAR(10)
		SET @END_DATE = ?
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '从业工种' + A.KINDWORK_NAME + '资质证书:' + A.CERT_NUM + ',将于' + @END_DATE + '到期，请提前安排办理相关手续.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT PC.CERT_NUM,
		               P.PRACTI_NAME REMAIND_NAME,
		               P.MOBILE REMAIND_TEL,
		               KW.VALUE KINDWORK_NAME
		          FROM T_PRACTITIONER P, T_PRACTI_CERT PC
		          LEFT JOIN BM_KIND_WORK KW ON PC.PRACTI_KINDWORK = KW.CODE
		         WHERE PC.DEL_FLAG = '1'
		           AND PC.QSTATE = '1'
		           AND P.PRACTI_STATUS = '1'
		           AND P.DEL_FLAG = '1'
		           AND P.PRACTI_ID = PC.PRACTI_ID
		           AND PC.EFFECT_DATE = @END_DATE
		        UNION ALL
		        SELECT PC.CERT_NUM,
		               CI.DUTYMAN REMAIND_NAME,
		               ISNULL(CI.DUTYMAN_TEL1, ISNULL(CI.DUTYMAN_TEL2, CI.DUTYMAN_TEL3)) REMAIND_TEL,
		               KW.VALUE KINDWORK_NAME
		          FROM T_CORP_INFO CI, T_PRACTITIONER P, T_PRACTI_CERT PC
		          LEFT JOIN BM_KIND_WORK KW ON PC.PRACTI_KINDWORK = KW.CODE
		         WHERE PC.DEL_FLAG = '1'
		           AND PC.QSTATE = '1'
		           AND P.PRACTI_STATUS = '1'
		           AND P.DEL_FLAG = '1'
		           AND CI.CORP_STATUS = '1'
		           AND CI.DEL_FLAG = '1'
		           AND PC.PRACTI_ID = P.PRACTI_ID
		           AND P.CORP_ID = CI.CORP_ID
		           AND PC.EFFECT_DATE = @END_DATE) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 设备报废到期提醒 -->
	<select id="schedule_equipscrap_dueto">
	<![CDATA[
		DECLARE @END_DATE CHAR(10)
		SET @END_DATE = ?;
		WITH EQUIP_SCRAP AS (
		SELECT E.RECORD_ID, CI.DUTYMAN, ISNULL(CI.DUTYMAN_TEL1, ISNULL(CI.DUTYMAN_TEL2, CI.DUTYMAN_TEL3)) DUTYMAN_TEL, CI.FINANCE, CI.FINANCE_TEL, CI.CAPITAL, CI.CAPITAL_TEL
		  FROM T_EQUIPMENT E, T_CORP_INFO CI
		 WHERE (E.STATUS < '6' OR E.STATUS > '7')
		   AND E.DEL_FLAG = '1'
		   AND CI.DEL_FLAG = '1'
		   AND CI.CORP_STATUS = '1'
		   AND E.PROPERTY_ENT = CI.CORP_ID
		   AND E.SCRAP_DATE = @END_DATE )
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '备案号为' + A.RECORD_ID + '的设备，将于 ' + @END_DATE + ' 报废，请提前做好安排.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT ES.RECORD_ID, ES.DUTYMAN REMAIND_NAME, ES.DUTYMAN_TEL REMAIND_TEL FROM EQUIP_SCRAP ES
		        UNION ALL
		        SELECT ES.RECORD_ID, ES.FINANCE REMAIND_NAME, ES.FINANCE_TEL REMAIND_TEL FROM EQUIP_SCRAP ES
		        UNION ALL
		        SELECT ES.RECORD_ID, ES.CAPITAL REMAIND_NAME, ES.CAPITAL_TEL REMAIND_TEL FROM EQUIP_SCRAP ES) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 零配件折旧率-年度折旧累加 -->
	<select id="compon_depreciate_rate">
	<![CDATA[
		UPDATE C
		   SET C.TOTAL_RATE      = CASE WHEN (C.TOTAL_RATE + C.DEPRECIATE_RATE) >= 100.00 THEN 100.00 ELSE (C.TOTAL_RATE + C.DEPRECIATE_RATE) END,
		       C.PRESENT_VALUE   = CAST((CASE WHEN C.TOTAL_RATE + C.DEPRECIATE_RATE >= 100.00 THEN 0 ELSE (C.ASSET_VALUE * ((100.00 - C.TOTAL_RATE - C.DEPRECIATE_RATE) / 100.00)) END) AS NUMERIC(12,2)),
		       C.DEPRECIATE_DATE = CONVERT(CHAR(10), DATEADD(YEAR, 1, C.DEPRECIATE_DATE), 23) FROM T_COMPONENT C
		 WHERE (C.STATUS < '6' OR C.STATUS > '7')
		   AND C.DEL_FLAG = '1'
		   AND C.DEPRECIATE_DATE < CONVERT(CHAR(10), GETDATE(), 23)
		   AND C.DEPRECIATE_DATE IS NOT NULL
	]]>
	</select>
	<!-- 设备折旧率-年度折旧累加 -->
	<select id="equip_depreciate_rate">
	<![CDATA[
		UPDATE E
		   SET E.TOTAL_RATE      = CASE WHEN (E.TOTAL_RATE + E.DEPRECIATE_RATE) >= 100 THEN 100.00 ELSE (E.TOTAL_RATE + E.DEPRECIATE_RATE) END,
		       E.PRESENT_VALUE   = CAST((CASE WHEN E.TOTAL_RATE + E.DEPRECIATE_RATE >= 100.00 THEN 0 ELSE (E.ASSET_VALUE * ((100.00 - E.TOTAL_RATE - E.DEPRECIATE_RATE) / 100.00)) END) AS NUMERIC(12,2)),
		       E.DEPRECIATE_DATE = CONVERT(CHAR(10), DATEADD(YEAR, 1, E.DEPRECIATE_DATE), 23) FROM T_EQUIPMENT E
		 WHERE (E.STATUS < '6' OR E.STATUS > '7')
		   AND E.DEL_FLAG = '1'
		   AND E.DEPRECIATE_DATE < CONVERT(CHAR(10), GETDATE(), 23)
	]]>
	</select>
	<!-- 客户生日提醒 -->
	<select id="schedule_customer_birthday">
	<![CDATA[
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT CL.LINKER, CL.TEL, (SELECT COMPANYNAME + '祝您生日快乐，感谢您一直对我们的关心与支持。' FROM COMPANY WHERE COMPANYID = 1) MESSAGE, '系统消息', '0', GETDATE()
		  FROM T_CUSTOMER C, T_CUSTOMER_LINKER CL
		 WHERE C.STATUS = '1'
		   AND C.DEL_FLAG = '1'
		   AND C.CUSTOMER_ID = CL.CUSTOMER_ID
		   AND CL.TEL IS NOT NULL
		   AND CL.BIRTH_DATE = CONVERT(CHAR(10), GETDATE(), 23)
	]]>
	</select>
	<!-- 供应商生日提醒 -->
	<select id="schedule_supplier_birthday">
	<![CDATA[
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT SL.LINKER, SL.TEL, (SELECT COMPANYNAME + '祝您生日快乐，感谢您一直对我们的关心与支持。' FROM COMPANY WHERE COMPANYID = 1) MESSAGE, '系统消息', '0', GETDATE()
		  FROM T_SUPPLIER S, T_SUPPLIER_LINKER SL
		 WHERE S.STATUS = '1'
		   AND S.DEL_FLAG = '1'
		   AND S.SUPPLIER_ID = SL.SUPPLIER_ID
		   AND SL.TEL IS NOT NULL
		   AND SL.BIRTH_DATE = CONVERT(CHAR(10), GETDATE(), 23)
	]]>
	</select>
	<!-- 保险到期提醒 -->
	<select id="schedule_insure_overtime">
	<![CDATA[
		DECLARE @END_DATE CHAR(10)
		SET @END_DATE = ?;
		WITH INSURE_EQUIP AS (
		SELECT E.RECORD_ID, CI.DUTYMAN, CI.DUTYMAN_TEL1 DUTYMAN_TEL, CI.FINANCE, CI.FINANCE_TEL, CI.CAPITAL, CI.CAPITAL_TEL
		  FROM T_INSURE_EQUIPMENT IE, T_EQUIPMENT E, T_CORP_INFO CI
		 WHERE E.STATUS < '5'
		   AND E.DEL_FLAG = '1'
		   AND CI.DEL_FLAG = '1'
		   AND CI.CORP_STATUS = '1'
		   AND IE.DEL_FLAG = '1'
		   AND IE.EQUIP_ID = E.EQUIP_ID
		   AND E.PROPERTY_ENT = CI.CORP_ID
		   AND IE.END_INSURE_DATE = @END_DATE )
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '备案号为' + RECORD_ID + '的设备，保险于 ' + @END_DATE + '(终保时间)超期，请确认是否续保。' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT IE.RECORD_ID, IE.DUTYMAN REMAIND_NAME, IE.DUTYMAN_TEL REMAIND_TEL FROM INSURE_EQUIP IE
		        UNION ALL
		        SELECT IE.RECORD_ID, IE.FINANCE REMAIND_NAME, IE.FINANCE_TEL REMAIND_TEL FROM INSURE_EQUIP IE
		        UNION ALL
		        SELECT IE.RECORD_ID, IE.CAPITAL REMAIND_NAME, IE.CAPITAL_TEL REMAIND_TEL FROM INSURE_EQUIP IE ) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 合同设备到期未拆卸提醒 -->
	<select id="schedule_contract_equip_expire" properties="default_equip_contractremaind">
	<![CDATA[
		DECLARE @END_DATE CHAR(10)
		SET @END_DATE = ?;
		WITH EXPIRE_EQUIP AS ( #default_equip_contractremaind# )
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, A.CONTRACT_SERIAL + '中设备编号 ' + A.RECORD_ID + ' 的租期将于 ' + @END_DATE + ' 到期。' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT EE.RECORD_ID RECORD_ID, EE.CONTRACT_SERIAL, CI.DUTYMAN REMAIND_NAME, ISNULL(CI.DUTYMAN_TEL1, ISNULL(CI.DUTYMAN_TEL2, CI.DUTYMAN_TEL3)) REMAIND_TEL
		          FROM EXPIRE_EQUIP EE, T_CORP_INFO CI
		         WHERE EE.PROPERTY_ENT = CI.CORP_ID AND EE.END_DATE = @END_DATE
		        UNION ALL
		        SELECT EE.RECORD_ID RECORD_ID, EE.CONTRACT_SERIAL, CI.FINANCE REMAIND_NAME, CI.FINANCE_TEL REMAIND_TEL
		          FROM EXPIRE_EQUIP EE, T_CORP_INFO CI
		         WHERE EE.PROPERTY_ENT = CI.CORP_ID AND EE.END_DATE = @END_DATE
		        UNION ALL
		        SELECT EE.RECORD_ID RECORD_ID, EE.CONTRACT_SERIAL, CI.CAPITAL REMAIND_NAME, CI.CAPITAL_TEL REMAIND_TEL
		          FROM EXPIRE_EQUIP EE, T_CORP_INFO CI
		         WHERE EE.PROPERTY_ENT = CI.CORP_ID AND EE.END_DATE = @END_DATE
		        UNION ALL
		        SELECT EE.RECORD_ID RECORD_ID, EE.CONTRACT_SERIAL, EE.PA_ENT_LINK_MAN REMAIND_NAME, EE.PA_ENT_LINK_TEL REMAIND_TEL
		          FROM EXPIRE_EQUIP EE WHERE EE.END_DATE = @END_DATE
		        UNION ALL
		        SELECT EE.RECORD_ID RECORD_ID, EE.CONTRACT_SERIAL, EE.SALESMAN REMAIND_NAME, EE.SALESMAN_TEL REMAIND_TEL
		          FROM EXPIRE_EQUIP EE WHERE EE.END_DATE = @END_DATE) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 合同设备逾期未拆卸提醒 -->
	<select id="schedule_contract_equip_overtime" properties="default_equip_contractremaind">
	<![CDATA[
		DECLARE @END_DATE CHAR(10)
		SET @END_DATE = ?;
		WITH EXPIRE_EQUIP AS ( #default_equip_contractremaind# )
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, A.CONTRACT_SERIAL + '中设备编号 ' + A.RECORD_ID + ' 的租期已于 ' + @END_DATE + ' 到期;现已逾期办理拆卸,请跟踪处理.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT EE.RECORD_ID RECORD_ID, EE.CONTRACT_SERIAL, CI.DUTYMAN REMAIND_NAME, ISNULL(CI.DUTYMAN_TEL1, ISNULL(CI.DUTYMAN_TEL2, CI.DUTYMAN_TEL3)) REMAIND_TEL
		          FROM EXPIRE_EQUIP EE, T_CORP_INFO CI
		         WHERE EE.PROPERTY_ENT = CI.CORP_ID AND EE.END_DATE = @END_DATE
		        UNION ALL
		        SELECT EE.RECORD_ID RECORD_ID, EE.CONTRACT_SERIAL, CI.FINANCE REMAIND_NAME, CI.FINANCE_TEL REMAIND_TEL
		          FROM EXPIRE_EQUIP EE, T_CORP_INFO CI
		         WHERE EE.PROPERTY_ENT = CI.CORP_ID AND EE.END_DATE = @END_DATE
		        UNION ALL
		        SELECT EE.RECORD_ID RECORD_ID, EE.CONTRACT_SERIAL, CI.CAPITAL REMAIND_NAME, CI.CAPITAL_TEL REMAIND_TEL
		          FROM EXPIRE_EQUIP EE, T_CORP_INFO CI
		         WHERE EE.PROPERTY_ENT = CI.CORP_ID AND EE.END_DATE = @END_DATE
		        UNION ALL
		        SELECT EE.RECORD_ID RECORD_ID, EE.CONTRACT_SERIAL, EE.SALESMAN REMAIND_NAME, EE.SALESMAN_TEL REMAIND_TEL
		          FROM EXPIRE_EQUIP EE WHERE EE.END_DATE = @END_DATE) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 采购单逾期提醒 -->
	<select id="schedule_purchase_overtime" properties="default_purchase_remainduser">
	<![CDATA[
		DECLARE @ARRIVAL_DATE CHAR(10)
		SET @ARRIVAL_DATE = ?;
		WITH PURCHASE_REMAINDUSER AS ( #default_purchase_remainduser# )
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '采购单号:' + A.PURCHASE_SERIAL + ',主题:' + A.PURCHASE_THEME + ' 的采购计划于 ' + @ARRIVAL_DATE + ' 到货，现已逾期到货，请跟踪落实。' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT PR.PURCHASE_SERIAL, PR.PURCHASE_THEME, PR.REMAIND_NAME, PR.REMAIND_TEL FROM PURCHASE_REMAINDUSER PR WHERE PR.ARRIVAL_DATE = @ARRIVAL_DATE AND PR.APPLYFOR_STATE = '3') A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 借用归还到期提醒 -->
	<select id="schedule_borrow_expire">
	<![CDATA[
		DECLARE @RETURN_DATE CHAR(10)
		SET @RETURN_DATE = ?
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '借用单号:' + A.BORROW_SERIAL + ',主题 ' + A.BORROW_THEME + '预计于' + @RETURN_DATE + '归还,请提前做好归好准备工作.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT B.IN_HANDLER REMAIND_NAME, B.IN_PHONE REMAIND_TEL, B.BORROW_SERIAL, B.BORROW_THEME FROM T_BORROW B WHERE B.APPLYFOR_STATE = '3' AND B.RETURN_DATE = @RETURN_DATE
				UNION ALL
				SELECT B.OUT_HANDLER REMAIND_NAME, B.OUT_PHONE REMAIND_TEL, B.BORROW_SERIAL, B.BORROW_THEME FROM T_BORROW B WHERE B.APPLYFOR_STATE = '3' AND B.RETURN_DATE = @RETURN_DATE) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 借用归还逾期提醒 -->
	<select id="schedule_borrow_overtime">
	<![CDATA[
		DECLARE @RETURN_DATE CHAR(10)
		SET @RETURN_DATE = ?
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '借用单号:' + A.BORROW_SERIAL + ',主题 ' + A.BORROW_THEME + '应于' + @RETURN_DATE + '归还,现已逾期归还,请落实处理.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT B.IN_HANDLER REMAIND_NAME, B.IN_PHONE REMAIND_TEL, B.BORROW_SERIAL, B.BORROW_THEME FROM T_BORROW B WHERE B.APPLYFOR_STATE = '3' AND B.RETURN_DATE = @RETURN_DATE
				UNION ALL
				SELECT B.OUT_HANDLER REMAIND_NAME, B.OUT_PHONE REMAIND_TEL, B.BORROW_SERIAL, B.BORROW_THEME FROM T_BORROW B WHERE B.APPLYFOR_STATE = '3' AND B.RETURN_DATE = @RETURN_DATE) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 设备逾期贷款提醒 -->
	<select id="schedule_instalment_equip_overtime">
	<![CDATA[
		DECLARE @END_DATE CHAR(10)
		DECLARE @DAY CHAR(10)
		SET @END_DATE = ?
		SET @DAY = ?;
		WITH EQUIP_INSTALMEN AS (SELECT I.PAYMENT, E.RECORD_ID, CI.DUTYMAN, ISNULL(CI.DUTYMAN_TEL1, ISNULL(CI.DUTYMAN_TEL2, CI.DUTYMAN_TEL3)) DUTYMAN_TEL, CI.FINANCE, CI.FINANCE_TEL
		  FROM T_INSTALMENT I, T_EQUIPMENT E, T_CORP_INFO CI
		 WHERE I.RELATE_MODULE = 'EQUIPMENT'
		   AND I.STATUS < '2'
		   AND I.PAY_DATE < @END_DATE
		   AND E.EQUIP_ID = I.RELATE_ID
		   AND E.DEL_FLAG = '1'
		   AND E.PROPERTY_ENT = CI.CORP_ID
		   AND CI.DEL_FLAG = '1')
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '备案号为' + A.RECORD_ID + '的设备,计划于本月' + @DAY + '日前还贷' + CONVERT(VARCHAR(20), A.PAYMENT) + '元,现已逾期,请处理.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT EI.PAYMENT, EI.RECORD_ID, EI.DUTYMAN REMAIND_NAME, EI.DUTYMAN_TEL REMAIND_TEL FROM EQUIP_INSTALMEN EI
				UNION ALL
				SELECT EI.PAYMENT, EI.RECORD_ID, EI.FINANCE REMAIND_NAME, EI.FINANCE_TEL REMAIND_TEL FROM EQUIP_INSTALMEN EI) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 合同到期还款提醒 -->
	<select id="schedule_instalment_contract_overtime">
	<![CDATA[
		DECLARE @END_DATE CHAR(10)
		SET @END_DATE = ?
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, A.PROJECT_NAME + '项目应收款共计' + CONVERT(VARCHAR(20), A.REAL_AMOUNT) + '元,计划于' + A.PAY_DATE + '前回款' + CONVERT(VARCHAR(20), A.PAYMENT) + '元,请落实按期回款事宜' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT I.PAYMENT, I.PAY_DATE, CL.DEBIT_RECEIVABLE REAL_AMOUNT, CL.PROJECT_NAME, CI.DUTYMAN REMAIND_NAME, CI.DUTYMAN_TEL1 REMAIND_TEL
				  FROM T_INSTALMENT I, T_CONTRACT_LEASE CL, T_CORP_INFO CI
				 WHERE I.RELATE_MODULE = 'CONTRACT_LEASE'
				   AND I.STATUS < '2'
				   AND I.PAY_DATE < @END_DATE
				   AND CL.CONTRACT_ID = I.RELATE_ID
				   AND CL.APPLYFOR_STATE > '3'
				   AND CL.PB_MODULE = 'CORP'
				   AND CL.PB_ENT = CI.CORP_ID
				   AND CI.DEL_FLAG = '1'
				UNION ALL
				SELECT I.PAYMENT, I.PAY_DATE, CL.DEBIT_RECEIVABLE REAL_AMOUNT, CL.PROJECT_NAME, CI.FINANCE REMAIND_NAME, CI.FINANCE_TEL REMAIND_TEL
				  FROM T_INSTALMENT I, T_CONTRACT_LEASE CL, T_CORP_INFO CI
				 WHERE I.RELATE_MODULE = 'CONTRACT_LEASE'
				   AND I.STATUS < '2'
				   AND I.PAY_DATE < @END_DATE
				   AND CL.CONTRACT_ID = I.RELATE_ID
				   AND CL.APPLYFOR_STATE > '3'
				   AND CL.PB_MODULE = 'CORP'
				   AND CL.PB_ENT = CI.CORP_ID
				   AND CI.DEL_FLAG = '1'
				UNION ALL
				SELECT I.PAYMENT, I.PAY_DATE, CL.DEBIT_RECEIVABLE REAL_AMOUNT, CL.PROJECT_NAME, CL.PB_ENT_LINK_MAN REMAIND_NAME, CL.PB_ENT_LINK_TEL REMAIND_TEL
				  FROM T_INSTALMENT I, T_CONTRACT_LEASE CL
				 WHERE I.RELATE_MODULE = 'CONTRACT_LEASE'
				   AND I.STATUS < '2'
				   AND I.PAY_DATE < @END_DATE
				   AND CL.CONTRACT_ID = I.RELATE_ID
				   AND CL.APPLYFOR_STATE > '3') A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 借款超期归还提醒 -->
	<select id="schedule_money_lend_overtime">
	<![CDATA[
		DECLARE @BACK_DATE CHAR(10)
		SET @BACK_DATE = ?
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, A.PRACTI_NAME + '于' + A.LEND_DATE + '的借款，计划于' + A.BACK_DATE + '前还款，现已逾期还款，请及时说明处理.' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT ML.PRACTI_NAME REMAIND_NAME, ML.PRACTI_TEL REMAIND_TEL, ML.PRACTI_NAME, ML.LEND_DATE, ML.BACK_DATE
				  FROM T_MONEY_LEND ML
				 WHERE ML.BACK_DATE = @BACK_DATE
				   AND ML.APPLYFOR_STATE  = '3'
				   AND ML.LENDBACK_STATUS = '0'
				UNION ALL
				SELECT ML.PRACTI_NAME REMAIND_NAME, ML.PRACTI_TEL REMAIND_TEL, ML.PRACTI_NAME, ML.LEND_DATE, ML.BACK_DATE
				  FROM T_MONEY_LEND ML, T_PRACTITIONER P, T_CORP_INFO CI
				 WHERE ML.BACK_DATE = @BACK_DATE
				   AND ML.APPLYFOR_STATE  = '3'
				   AND ML.LENDBACK_STATUS = '0'
				   AND ML.PRACTI_ID = P.PRACTI_ID
				   AND P.CORP_ID = CI.CORP_ID
				UNION ALL
				SELECT ML.PRACTI_NAME REMAIND_NAME, ML.PRACTI_TEL REMAIND_TEL, ML.PRACTI_NAME, ML.LEND_DATE, ML.BACK_DATE
				  FROM T_MONEY_LEND ML, T_PRACTITIONER P, T_CORP_INFO CI 
				 WHERE ML.BACK_DATE = @BACK_DATE
				   AND ML.APPLYFOR_STATE  = '3'
				   AND ML.LENDBACK_STATUS = '0'
				   AND ML.PRACTI_ID = P.PRACTI_ID
				   AND P.CORP_ID = CI.CORP_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- ####################################################################   作废   ############################################################### -->
	<!-- 设备巡检不合格审批完成提醒 -->
	<select id="equipinspect_approve_remaind" properties="default_equip_corpremaind">
	<![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?;
		WITH EQUIP_CORP AS ( #default_equip_corpremaind# )
		INSERT INTO T_BUSINESS_MESSAGE(RECEIVE_NAME, RECEIVE_TEL, MESSAGE, SENDER_NAME, SEND_FLAG, CREATE_TIME)
		SELECT A.REMAIND_NAME, A.REMAIND_TEL, '备案号为 ' + A.RECORD_ID + ' 的设备，经巡检发现故障，现不可使用，请安排处理。' MESSAGE, '系统消息', '0', GETDATE()
		  FROM (SELECT EC.RECORD_ID, EC.DUTYMAN REMAIND_NAME, EC.DUTYMAN_TEL REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID
		        UNION ALL
		        SELECT EC.RECORD_ID, EC.CAPITAL REMAIND_NAME, EC.CAPITAL_TEL REMAIND_TEL FROM EQUIP_CORP EC WHERE EC.EQUIP_ID = @EQUIP_ID) A
		 WHERE A.REMAIND_TEL IS NOT NULL
	]]>
	</select>
	<!-- 设备拆卸时间到期在用状态清除 -->
	<select id="clean_inusedstatus_equip">
	<![CDATA[
		UPDATE E
		   SET E.STATUS = '1' FROM T_EQUIPMENT E
		 WHERE NOT EXISTS (SELECT 'X'
		          FROM T_EQUIPMENT_DIARY ED
		         WHERE ED.ACTIVE = '1'
		           AND ED.END_DATE > GETDATE()
		           AND ED.EQUIP_ID = E.EQUIP_ID)
		   AND E.STATUS = '0'
	]]>
	</select>
	<!-- 零配件拆卸时间到期在用状态清除 -->
	<select id="clean_inusedstatus_compon">
	<![CDATA[
		UPDATE C
		   SET C.STATUS = '1' FROM T_COMPONENT C
		 WHERE NOT EXISTS (SELECT 'X'
		          FROM T_COMPONENT_DIARY CD
		         WHERE CD.ACTIVE = '1'
		           AND CD.END_DATE > GETDATE()
		           AND CD.COMPON_ID = C.COMPON_ID)
		   AND C.STATUS = '0'
	]]>
	</select>
	<select id="componentMthStocks">
	<![CDATA[
		DECLARE @YEARMTH CHAR(6)
		SET @YEARMTH = ?;
	
		INSERT INTO T_COMPONT_STOCKS SELECT T.COMPON_ID,T.COMPON_SERIAL,@YEARMTH,T.CONSUME_COUNTS,T.CONSUME_COUNTS*T.UNITPRICE  
		FROM dbo.T_COMPONENT T WHERE T.DEL_FLAG=1
	]]>	
	</select>
	
	<select id="antiFallDate">
	<![CDATA[
		select *
 from T_ANTI_FALL_DETECTION  
where  (DATEDIFF(dd, GETDATE(),[END_DATE]) = 30);
	]]>	
	</select>
	
	<select id="inspectOverDate">
	<![CDATA[
				DECLARE @INSPECT_DATE CHAR(10)
		--SET @INSPECT_DATE = ?
	    ;WITH QUERY AS (
	      SELECT *, ROW_NUMBER() OVER (ORDER BY A.inspectDate DESC) AS _ROWNUM 
	        FROM (SELECT CONVERT(CHAR(10), EI.INSPECT_DATE, 23)      inspectDate,
	                     EI.INSPECT_ID        inspectId,
	                     EI.INSPECT_SERIAL    inspectSerial,
	                     EI.INSPECT_PEPOLES   inspectPepoles,
	                     EI.INSPECT_RESULT    inspectResult,
	                     EI.EXW_SERIAL        exwserial,
	                     EI.BUILDING_NUM      buildingnum,
	                     EI.RECORD_ID         recordId,
	                     B.VALUE              inspectResultName,
	                     EI.STATUS            statusName,
	                     EI.REMARK            remark,
	                     EI.LONGITUDE         longitude,
	                     EI.LATITUDE          latitude,
	                     ED.PROJECT_NAME      projectName,
						 EI.RECTIFICATION     rectification,
						 IR.RECTIFY_USERID    userId,
	                     'EQUIP_INSPECT'      relateModule
	                FROM T_EQUIPMENT_INSPECT EI 
					LEFT JOIN BM_INSPECT_RESULT B ON B.CODE = EI.INSPECT_RESULT, T_EQUIPMENT_INSPECT_SCHEMA EIS, T_EQUIPMENT_DIARY ED
					LEFT JOIN T_INSPECT_RECTIFY IR ON IR.INSPECT_RECTIFY_ID = EI.INSPECT_RECTIFY_ID
	               WHERE ED.EQUIP_DIARY_ID = EIS.EQUIP_DIARY_ID
	                 AND EIS.INSPECT_SCHEMA_ID = EI.INSPECT_SCHEMA_ID
	                 AND CONVERT(VARCHAR(10),EI.INSPECT_DATE,112) = @INSPECT_DATE
	              UNION ALL
	              SELECT CONVERT(CHAR(10), IM.INSPECT_DATE, 23)      inspectDate,
	                     IM.INSPECT_ID        inspectId,
	                     NULL                 inspectSerial,
	                     IM.INSPECT_PEPOLES   inspectPepoles,
	                     IM.INSPECT_RESULT    inspectResult,
	                     IM.EXW_SERIAL        exwserial,
	                     IM.BUILDING_NUM      buildingnum,
	                     IM.RECORD_ID         recordId,
	                     B.VALUE              inspectResultName,
	                     NULL                 statusName,
	                     IM.REMARK            remark,
	                     IM.LONGITUDE         longitude,
	                     IM.LATITUDE          latitude,
	                     IM.PROJECT_NAME      projectName,
						 IM.RECTIFICATION     rectification,
						 IR.RECTIFY_USERID    userId,
	                     'INSPECT_MANAGE'     relateModule
	                FROM T_INSPECT_MANAGE IM 
					LEFT JOIN BM_INSPECT_RESULT B ON B.CODE = IM.INSPECT_RESULT
					LEFT JOIN T_INSPECT_RECTIFY IR ON IR.INSPECT_RECTIFY_ID = EI.INSPECT_RECTIFY_ID
	               WHERE CONVERT(VARCHAR(10),IM.INSPECT_DATE,112) = @INSPECT_DATE
	              ) A
	    ) SELECT * FROM QUERY ORDER BY inspectId desc
	]]>	
	</select>
	
		<!-- 资质证剩余天数 -->
	<select id="cert_left_effect_days">
	<![CDATA[
		SELECT AU.USERID userId,AU.USERNAME userName,BW.VALUE kindWork,T.EFFECT_DATE effectDate,
				 DATEDIFF ( day , T.EFFECT_DATE , GETDATE() ) days FROM T_PRACTI_CERT  T 
			LEFT JOIN T_PRACTITIONER TP ON TP.PRACTI_ID = T.PRACTI_ID 
			LEFT JOIN APP_USER AU ON AU.USERID =TP.USERID 
			LEFT JOIN BM_KIND_WORK BW ON T.PRACTI_KINDWORK = BW.CODE 
		WHERE T.DEL_FLAG = 1 AND T.QSTATE = 1 AND AU.USERID IS NOT NULL
	]]>
	</select>
	
		
		<!-- 检测管理下次检测时间提醒 -->
	<select id="redetec_date">
	<![CDATA[
		SELECT T.USER_ID userId,T.PROJECT_NAME projectName,T.BUILDING_NUM buildingNum,T.EXW_SERIAL exwSerial,TD.REDETECT_DATE redetectDate,DATEDIFF ( day , TD.REDETECT_DATE , GETDATE() ) days FROM T_EQUIPMENT_DETECT TD 
		LEFT JOIN T_EQUIPMENT_FLOW TF ON TF.FLOW_ID = TD.FLOW_ID
		LEFT JOIN T_EQUIPMENT T ON T.EQUIP_ID = TF.EQUIP_ID
		WHERE DATEDIFF ( day , TD.REDETECT_DATE , GETDATE() ) <= -30
	]]>
	</select>
	
		<!-- 项目仓库初始化库存数量 -->
	<select id="project_depot_init">
	<![CDATA[
		DECLARE @PROJECT_ID BIGINT
		SET @PROJECT_ID = ?
		SELECT * FROM T_PROJECT_DEPOT_INIT PD WHERE PD.PROJECT_ID=@PROJECT_ID
	]]>
	</select>
	
		<!-- 基地仓库初始化库存数量 -->
	<select id="base_depot_init">
	<![CDATA[
		DECLARE @COMMODITY VARCHAR(32)
		SET @COMMODITY = ?
		SELECT * FROM T_BASE_DEPOT_INIT PD WHERE PD.COMMODITY=@COMMODITY
	]]>
	</select>
		
		<!-- 巡检单过期封存 -->
	<select id="seal_equip_inspect">
		<![CDATA[
			UPDATE T_EQUIPMENT_INSPECT SET SEAL_STATUS = '1' WHERE THIS_END_CYCLE_DATE < CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),120)) AND SEAL_STATUS != '1';
		]]>
	</select>
</mapper>