<?xml version="1.0" encoding="UTF-8"?>
<mapper namespace="equipdoc">
    <!-- 设备所属部件及使用信息 -->
    <select id="include_compon_diary">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT C.COMPON_ID,
		       C.STATUS,
		       (SELECT CG.VALUE FROM BM_COMPONENT_GENERIC CG WHERE CG.CODE = C.COMPON_GENERIC) COMPON_GENERIC,
		       (SELECT CG.VALUE FROM BM_COMPONENT_SPECIFIC CG WHERE CG.CODE = C.COMPON_SPECIFIC) COMPON_SPECIFIC,
		       CONVERT(VARCHAR(10), C.PURCHASE_DATE, 23) PURCHASE_DATE,
		       CONVERT(VARCHAR(10), CD.START_DATE, 23) START_DATE,
		       CONVERT(VARCHAR(10), CD.END_DATE, 23) END_DATE,
		       CD.PROJECT_NAME,
		       CD.ADDRESS
		  FROM T_COMPONENT C
		  LEFT JOIN T_COMPONENT_DIARY CD ON CD.COMPON_ID = C.COMPON_ID
		 WHERE C.DEL_FLAG = '1'
		   AND C.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 总出租次数 -->
    <select id="rent_out_count">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT COUNT(*) COUNTS
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D
		 WHERE (D.APPLYFOR_STATE = '3' OR D.APPLYFOR_STATE = '5')
		   AND D.DISPATCH_ID = DE.DISPATCH_ID
		   AND DE.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 总收入（元） -->
    <select id="receive_sum">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT ISNULL(SUM(AES.PRESENT_AMOUNT), 0) PRESENT_AMOUNT
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_RECEIVE AR
		 WHERE AR.APPLYFOR_STATE = '3'
		   AND AR.AMOUNT_RECEIVE_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_RECEIVE'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 总支出（元） -->
    <select id="payment_sum">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT ISNULL(SUM(AES.PRESENT_AMOUNT), 0) PRESENT_AMOUNT
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_PAYMENT AP
		 WHERE AP.APPLYFOR_STATE = '3'
		   AND AP.AMOUNT_PAYMENT_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_PAYMENT'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 总出租率 -->
    <select id="occupancy_rate">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CAST(CAST(ISNULL(SUM(DATEDIFF(DAY, ED.START_DATE, (CASE WHEN ED.END_DATE > GETDATE() THEN GETDATE() ELSE ED.END_DATE END))), 0) AS FLOAT) /
		       CAST(ISNULL((SELECT (DATEDIFF(DAY, E.PURCHASE_DATE, GETDATE())) FROM T_EQUIPMENT E WHERE E.EQUIP_ID = @EQUIP_ID), 1) AS FLOAT) * 100 AS DEC(5, 2)) OCCUPANCY_RATE
		  FROM T_EQUIPMENT_DIARY ED
		 WHERE ED.ACTIVE = '1'
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 最近调配记录(当前、上一次) -->
    <select id="top2_diary">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT TOP 2 P.PROJECT_NAME,
		       P.ADDRESS,
		       ED.ACTIVATE_DATE,
		       P.UN_CUSTOM_NAME,
		       DE.WORK_STATUS
		  FROM T_DISPATCH_EQUIP DE, T_EQUIPMENT_DIARY ED LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID
		 WHERE ED.ACTIVE = '1'
		   AND ED.EQUIP_ID = @EQUIP_ID
		   AND ED.PROJECT_ID > 0
		   AND DE.DISPATCH_EQUIP_ID = ED.BUSINESS_EQUIP_ID
		 ORDER BY ED.START_DATE DESC
	]]>
    </select>
    <!-- 租赁合同 -->
    <select id="contract">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CL.APPLYFOR_STATE,
		       CL.CONTRACT_SERIAL,
		       CL.PB_ENT_NAME,
		       CL.PROJECT_NAME,
		       CL.SIGNING_TIME,
		       CL.CONTRACT_AMOUNT,
		       CL.SALESMAN
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D, T_CONTRACT_LEASE CL
		 WHERE DE.DISPATCH_ID = D.DISPATCH_ID
		   AND DE.EQUIP_ID = @EQUIP_ID
		   AND (D.APPLYFOR_STATE = '3' OR D.APPLYFOR_STATE = '5')
		   AND D.RELATE_ID = CL.CONTRACT_ID
		   AND D.RELATE_MODULE = 'CONTRACT_LEASE'
	]]>
    </select>
    <!-- 租赁合同-资料打印 -->
    <select id="contractByPE">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		DECLARE @PROJECT_ID BIGINT
		SET @EQUIP_ID = ?
		SET @PROJECT_ID = ?
		SELECT * FROM T_CONTRACT_EQUIP CE
		LEFT JOIN T_CONTRACT_LEASE CL ON CL.CONTRACT_ID = CE.CONTRACT_ID
		WHERE CE.EQUIP_ID = @EQUIP_ID
		AND CL.PROJECT_ID = @PROJECT_ID
	]]>
    </select>
    <!-- 结算信息 -->
    <select id="settle">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT SC.FUND_STATUS,
		       SC.SETTLE_SERIAL,
		       SC.START_SETTLE_DATE,
		       SC.END_SETTLE_DATE,
		       SC.SETTLE_AMOUNT,
		       SC.PROJECT_NAME,
		       SC.PA_ENT_NAME
		  FROM T_SETTLE_EQUIP_BRIEF SEB, T_SETTLE_CONTRACT SC
		 WHERE SEB.EQUIP_ID = @EQUIP_ID
		   AND SEB.SETTLE_ID = SC.SETTLE_ID
		   AND SC.EFFECTIVE = '1'
	]]>
    </select>
    <!-- 调度信息 -->
    <select id="dispatch">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT D.APPLYFOR_STATE,
		       D.PROJECT_NAME,
		       D.ADDRESS,
		       CONVERT(VARCHAR(10), DE.START_DATE, 23) START_DATE,
		       D.PROJECT_MANAGER
		  FROM T_DISPATCH_EQUIP DE, T_DISPATCH D
		 WHERE DE.EQUIP_ID = @EQUIP_ID
		   AND DE.DISPATCH_ID = D.DISPATCH_ID
		   AND (D.APPLYFOR_STATE = '3' OR D.APPLYFOR_STATE = '5')
	]]>
    </select>
    <!-- 安装启用 -->
    <select id="install">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CONVERT(VARCHAR(10), EI.STARTIN_DATE, 23) STARTIN_DATE,
		       CONVERT(VARCHAR(10), EI.ENDIN_DATE, 23) ENDIN_DATE,
		       EA.ACTIVATE_DATE,
		       ED.PROJECT_NAME,
		       EI.INSTALL_HEIGHT,
		       EI.PRINCIPAL
		  FROM T_EQUIPMENT_INSTALL EI, T_EQUIPMENT_DIARY ED LEFT JOIN T_EQUIPMENT_ACTIVATE EA ON EA.FLOW_ID = ED.FLOW_ID
		 WHERE ED.FLOW_ID = EI.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
		   AND (EI.APPLYFOR_STATE = '3' OR EI.APPLYFOR_STATE = '4')
	]]>
    </select>
    <!--  顶升加节 -->
    <select id="jj">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CD.COMPON_GENERIC,
		CD.COUNTS,
		CD.PROJECT_NAME,
		CD.JJUSERNAME,
		CD.START_DATE
		FROM T_COMPONENT_DIARY CD
		WHERE CD.JJSTAUTS = '2'
	]]>
    </select>
    <!-- 检测信息 -->
    <select id="detect">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EDE.DETECT_SERIAL,
		       EDE.DETECT_ENT_NAME,
		       EDE.DETECT_DATE,
		       ED.PROJECT_NAME,
		       EDE.DETECT_RESULT
		  FROM T_EQUIPMENT_DETECT EDE, T_EQUIPMENT_DIARY ED
		 WHERE EDE.DEL_FLAG = '1'
		   AND ED.FLOW_ID = EDE.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 验收信息 -->
    <select id="verify">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EV.VERIFY_SERIAL,
		       EV.EM_ENT_NAME,
		       EV.VERIFY_RESULT,
		       ED.PROJECT_NAME,
		       ED.ADDRESS
		  FROM T_EQUIPMENT_VERIFY EV, T_EQUIPMENT_DIARY ED
		 WHERE EV.DEL_FLAG = '1'
		   AND ED.FLOW_ID = EV.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 使用信息 -->
    <select id="employ">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CONVERT(VARCHAR(10), EE.EMPLOY_DATE, 23) EMPLOY_DATE,
			   CONVERT(VARCHAR(10), EE.END_PLAN_DATE, 23) END_PLAN_DATE,
		       P.UN_CUSTOM_NAME,
		       ED.PROJECT_NAME,
		       ED.ADDRESS
		  FROM T_EQUIPMENT_EMPLOY EE, T_EQUIPMENT_DIARY ED LEFT JOIN T_PROJECT P ON P.PROJECT_ID = ED.PROJECT_ID
		 WHERE (EE.APPLYFOR_STATE = '3' OR EE.APPLYFOR_STATE = '4')
		   AND ED.FLOW_ID = EE.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 巡检信息 -->
    <select id="inspect">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EI.INSPECT_SERIAL,
		       CONVERT(VARCHAR(10), EI.INSPECT_DATE, 23) INSPECT_DATE,
		       EI.INSPECT_PEPOLES,
		       (SELECT IR.VALUE FROM BM_INSPECT_RESULT IR WHERE IR.CODE = EI.INSPECT_RESULT) INSPECT_RESULT,
		       ED.PROJECT_NAME
		  FROM T_EQUIPMENT_INSPECT EI, T_EQUIPMENT_INSPECT_SCHEMA EIS, T_EQUIPMENT_DIARY ED
		 WHERE EI.INSPECT_SCHEMA_ID = EIS.INSPECT_SCHEMA_ID
		   AND EIS.FLOW_ID = ED.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 维保记录 -->
    <select id="maint">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT EM.MAINT_SERIAL,
		       CONVERT(VARCHAR(10), EM.MAINT_DATE, 23) MAINT_DATE,
		       EM.MAINT_PEPOLES,
		       (SELECT MT.VALUE FROM BM_MAINT_TYPE MT WHERE MT.CODE = EMS.MAINT_TYPE) MAINT_TYPE,
		       CONVERT(VARCHAR(10), EM.THIS_END_CYCLE_DATE, 23) THIS_END_CYCLE_DATE,
		       (SELECT IR.VALUE FROM BM_INSPECT_RESULT IR WHERE IR.CODE = EM.MAINT_RESULT) MAINT_RESULT
		  FROM T_EQUIPMENT_MAINT EM, T_EQUIPMENT_MAINT_SCHEMA EMS, T_EQUIPMENT_DIARY ED
		 WHERE EM.MAINT_SCHEMA_ID = EMS.MAINT_SCHEMA_ID
		   AND EMS.EQUIP_DIARY_ID = ED.EQUIP_DIARY_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
		   AND EM.STATUS > '0'
	]]>
    </select>
    <!-- 拆卸信息 -->
    <select id="dismantle">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT CONVERT(VARCHAR(10), DIS.STARTDIS_DATE, 23) STARTDIS_DATE,
			   CONVERT(VARCHAR(10), DIS.ENDDIS_DATE, 23) ENDDIS_DATE,
		       DBO.F_MERGE_DISMANTLE_PRACTI(DIS.DISMANTLE_ID, 'EQUIP_DISMANTLE') PRACTI_NAMES,
		       ED.PROJECT_NAME,
		       DIS.DISMANTLE_HEIGHT,
		       DIS.PRINCIPAL
		  FROM T_EQUIPMENT_DISMANTLE DIS, T_EQUIPMENT_DIARY ED
		 WHERE (DIS.APPLYFOR_STATE = '3' OR DIS.APPLYFOR_STATE = '4')
		   AND DIS.FLOW_ID = ED.FLOW_ID
		   AND ED.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 保险信息 -->
    <select id="insure">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT IE.INSURANCE_COMPANY,
		       IE.START_INSURE_DATE,
		       IE.END_INSURE_DATE,
		       IE.INSURE_SERIAL,
		       IE.PREMIUM,
		       (SELECT SUM(IC.COMPENSATE_AMOUNT) FROM T_INSURE_CLAIM IC WHERE IC.INSURE_ID = IE.INSURE_ID) COMPENSATE_AMOUNT
		  FROM T_INSURE_EQUIPMENT IE 
		 WHERE IE.DEL_FLAG = '1'
		   AND IE.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 收款明细 -->
    <select id="receive">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT AR.AMOUNT_SERIAL,
		       AR.PAYMENT_NAME,
		       AR.RECEIVE_DATE,
		       AR.RECEIVE_AMOUNT,
		       AR.RECEIVE_STATUS
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_RECEIVE AR
		 WHERE AR.APPLYFOR_STATE = '3'
		   AND AR.AMOUNT_RECEIVE_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_RECEIVE'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- 支出明细 -->
    <select id="payment">
        <![CDATA[
		DECLARE @EQUIP_ID BIGINT
		SET @EQUIP_ID = ?
		SELECT AP.RELATE_THEME,
		       AP.RECEIVE_NAME,
		       AP.PAYMENT_DATE,
		       AP.PAYMENT_AMOUNT,
		       AP.PAYMENT_STATUS
		  FROM T_AMOUNT_EQUIP_SHARE AES, T_AMOUNT_PAYMENT AP
		 WHERE AP.APPLYFOR_STATE = '3'
		   AND AP.AMOUNT_PAYMENT_ID = AES.RELATE_ID
		   AND AES.RELATE_MODULE = 'AMOUNT_PAYMENT'
		   AND AES.EQUIP_ID = @EQUIP_ID
	]]>
    </select>
    <!-- ==============================================设备分布==================================== -->
    <!-- 设备省份分布 -->
    <select id="province_map_info">
        <![CDATA[
		SELECT '0' AREA_TYPE, A.CODE AREA_ID, A.VALUE AREA_NAME, A.LONGITUDE, A.LATITUDE, CAST(A.COUNTS AS VARCHAR) + ' 台' STAT_COUNTS
		  FROM (SELECT B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE, COUNT(B.VALUE) COUNTS
		          FROM T_EQUIPMENT       E,
		               T_EQUIPMENT_DIARY ED,
		               T_PROJECT         P,
		               BM_PROVINCE       B
		         WHERE E.FLOW_ID = ED.FLOW_ID
		           AND ED.PROJECT_ID = P.PROJECT_ID
		           AND P.PROVINCE = B.CODE
		         GROUP BY B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE) A
		  WHERE 1 = 1
	]]>
    </select>
    <!-- 设备城市分布 -->
    <select id="city_map_info">
        <![CDATA[
		SELECT '1' AREA_TYPE, A.CODE AREA_ID, A.VALUE AREA_NAME, A.LONGITUDE, A.LATITUDE, CAST(A.COUNTS AS VARCHAR) + ' 台' STAT_COUNTS
		  FROM (SELECT P.PROVINCE, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE, COUNT(B.VALUE) COUNTS
		          FROM T_EQUIPMENT       E,
		               T_EQUIPMENT_DIARY ED,
		               T_PROJECT         P,
		               BM_CITY           B
		         WHERE E.FLOW_ID = ED.FLOW_ID
		           AND ED.PROJECT_ID = P.PROJECT_ID
		           AND P.CITY = B.CODE
		         GROUP BY P.PROVINCE, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE) A
		  WHERE 1 = 1
	]]>
    </select>
    <!-- 设备区县分布 -->
    <select id="country_map_info">
        <![CDATA[
		SELECT '2' AREA_TYPE, A.CODE AREA_ID, A.VALUE AREA_NAME, A.LONGITUDE, A.LATITUDE, CAST(A.COUNTS AS VARCHAR) + ' 台' STAT_COUNTS
		  FROM (SELECT P.PROVINCE, P.CITY, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE, COUNT(B.VALUE) COUNTS
		          FROM T_EQUIPMENT       E,
		               T_EQUIPMENT_DIARY ED,
		               T_PROJECT         P,
		               BM_COUNTY         B
		         WHERE E.FLOW_ID = ED.FLOW_ID
		           AND ED.PROJECT_ID = P.PROJECT_ID
		           AND P.COUNTY = B.CODE
		         GROUP BY P.PROVINCE, P.CITY, B.CODE, B.VALUE, B.LONGITUDE, B.LATITUDE) A
		  WHERE 1 = 1
	]]>
    </select>
    <select id="settleEquipByPE">
        <![CDATA[
            SELECT * FROM T_SETTLE_EQUIP_BRIEF SE
            LEFT JOIN T_SETTLE_CONTRACT SC ON SC.SETTLE_ID = SE.SETTLE_ID
            WHERE SE.EQUIP_ID = ?
            AND SC.PROJECT_ID = ?
        ]]>
    </select>
    <select id="indisSchemaByPE">
        <![CDATA[
            SELECT * FROM T_INDIS_SCHEMA S
            WHERE S.EQUIP_ID = ?
            AND S.PROJECT_ID = ?
            AND S.RELATE_MODULE = 'EQUIP_INSTALL'
        ]]>
    </select>
</mapper>